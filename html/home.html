<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="/js/w2ui-1.5.rc1.min.css" />
    <script src="/js/jquery.min.js"></script>
    <script src="/js/w2ui-1.5.rc1.js"></script>
    <link rel="stylesheet" href="/html/fa/css/font-awesome.min.css">
    <link rel="stylesheet" href="/html/rentroll.css">
    <!-- <script src="/js/rutil.js"></script> -->
    <link rel="icon" type="image/png" href="/html/images/favicon32x32.png">
</head>
<body>

<!--  color Icon images:  icon-page, w2ui-icon-check, ... see below in toptoolbar -->
<!--

mainlayout    - w2ui layout toptoolbar, toplayout, footer
toplayout     - w2ui layout for sidebar, main, and right (Detail)
reportslayout - w2ui layout for reports, main for reports, and top for toolbar
toptoolbar    - w2ui toolbar
sidebarL1     - w2ui sidebar

-->

<script>
/*global
    w2ui, console, plural,setToRAForm, setToForm, window,
    w2uiDateControlString, w2popup, getCurrentBusiness, dateControlString,dateMonthFwd,
    tcidPickerDropRender, tcidRAPayorPickerRender, tcidPickerCompare,
    ridRentablePickerRender, ridRentableDropRender,ridRentableCompare, calcRarGridContractRent,
    handleDateToolbarAction, setDateControlsInToolbar, genDateRangeNavigator, getPaymentType,
    getBUDfromBID, buildPaymentTypeSelectList,
    tcidReceiptPayorPickerRender, unallocAmountRemaining,
    addDateNavToToolbar,dateFromString, getPayorFund, refreshUnallocAmtSummaries,
    getParentAccounts, formRefreshCallBack, getFormSubmitData, formRecDiffer,
    form_dirty_alert, w2confirm,getRentableTypes,getPersonDetailsByTCID,
    tcidRUserPickerRender,rentalAgrFinderRender,rentalAgrFinderDropRender,rentalAgrFinderCompare,
    getAccountsList,getPostAccounts,int_to_bool,buildTopLayout,buildNewsLayout,
    buildSidebar,buildAllocFundsGrid,buildAccountElements,buildTransactElements,
    buildRentableTypeElements,buildRentableElements,buildRAElements,
    buildRAPayorPicker,buildRUserPicker,buildRentablePicker,buildRAFinder,buildReceiptElements,
    buildAssessmentElements,buildARElements,buildPaymentTypeElements,buildDepositoryElements,buildReportElements,buildTWSElemets
*/

/*globals $:false */
/*jshint globalstrict: true*/
"use strict";

// unallocated receipts utility literal object
var _unAllocRcpts = {
    layoutPanels: {
        top: function(unallocFund, person/*, tcid*/) {
            return `<html>
                <head>
                <link rel="stylesheet" href="/html/rentroll.css">
                </head>
                <body>
                <div style="display: table; width: 100%; height: 40%;">
                    <div style="display: table-cell; vertical-align: middle;text-align: left;width: 100%;">
                        <p style="margin: 5px auto;font-size: 1.5rem;font-weight: bold;" name="unallocForm">`+person+`<br>Remaining unallocated funds:
                        <span id="total_fund_amount" data-fund="`+unallocFund+`"
                        style="padding: 10px; color: #00AA00; font-size: 1.5rem; font-weight: bold; margin: 10px auto; width: 30%;">`+
                        unallocFund+
                        `</span>&nbsp;&nbsp;&nbsp;&nbsp;<button class="w2ui-btn w2ui-btn-green" style="font-size: 1.1rem;" id="auto_allocate_btn">Auto-Allocate</button></p>
                    </div>
                </div>
                </body>
                </html>`;
        },
        bottom: function() {
            return `<div style="display: table; width: 100%; height: 100%;">
                    <div style="display: table-cell; vertical-align: middle;text-align: center;width: 100%;">
                        <button class="w2ui-btn" id="alloc_fund_save_btn">Save</button>
                    </div>
                </div>`;
        }
    }
};

// The rentroll app object, used to manage app-level data.
var app = {
    D1: "2016-02-01",
    D2: "2016-03-01",
    uid: 211,
    WidestFormWidth: 900,
    sidebarWidth: 215,
    TmpTCID: 0,  // holds TCID of Payor from Apply Payments grid - Save function on unpaid assessments grid uses it
    TcidRAPayorPicker: {BID: 0},
    TcidRUserPicker: {BID: 0, Title: '', RAID: 0, RARentablesNames: [], RAR: []},
    RentalAgrFinder: {BID: 0, RAID: 0, TCID: 0, FirstName: '', LastName: '', CompanyName: '', IsCompany: false, RAR: [], RARentablesNames: []},
    ridRentablePicker: {BID: 0, Title: '', RAID: 0},
    asmsRevMode: [
        {id: 0, text: "this instance only"},
        {id: 1, text: "this and future instances"},
        {id: 2, text: "all instances"}
    ],
    ARTypes: {0: "Assessment", 1: "Receipt"},
    Assessments: [{id: 0, text: "Set Assessment Rule"},],
    Receipts: [{id: 1, text: "Set Payment Rule"},],
    AsmtModeCallerForm: null,
    language: "{{.Language}}",
    template: "{{.Template}}",
    pstyle: 'border: 1px solid #dfdfdf; padding: 0px;',
    pstyleNB: 'border: 0px solid #dfdfdf; padding: 0px;',
    pstyle4: 'border: 1px solid #bbbbbb; padding: 0px;',
    pstyle2: 'border: 1px solid #cfcfcf; padding: 0px;',
    //prefmt: 'font-family: "Monaco", "Menlo", "Source Code Pro", monospace; white-space: pre; font-size: 9pt; background-color: white;',
    prefmt: 'border:4px; solid #bbbbbb; background-color: white;',
    bgyellow: 'background-color: yellow;',
    stdfmt: 'font-family: "Open Sans","Roboto",sans-serif; font-size: 8pt; border: 1px solid #dfdfdf; border-spacing:0px; padding: 3px; color: #777777;',
    refreshInhibit: false,
    receiptsToolbarOnClickAdded: false,
    arList: [{id: 0, text:"Assessment"}, {id:1, text:"Receipt"}],
    rt_list: {},
    gl_accounts: {}, // this holds the list of GLAccount per business
    parent_accounts: {}, // possible parent accounts
    post_accounts: {}, // possible post accounts
    rof: {"csv": 4, "pdf": 3}, // report export/output format
    pdfPageWidth: 8.5, // defaults to USLetter Portrait width
    pdfPageHeight: 11, // defaults to USLetter Portrait height
    pageSizes: {
        "USLetter": { "w": 8.5, "h": 11 },
        "Legal": { "w": 8.5, "h": 14 },
        "Ledger": { "w": 11, "h": 17 },
    },
    active_grid: "", // which one is active now
    new_form_rec: false,
    active_form: "", // which form is active now
    form_is_dirty: false,
    active_form_original: {},
    last: {
        report: "",
        BUD: "",
        BID: -1,
        grid_recid: -1,
    }
};

// delete confirmation dialog box options
var delete_confirm_options = {
    msg          : '<p>Are you sure you want to delete this record?</p>',
    title        : '',
    width        : 340,     // width of the dialog
    height       : 160,     // height of the dialog
    btn_yes      : {
        text     : 'Yes',   // text for yes button (or yes_text)
        class    : 'w2ui-btn w2ui-btn-red',      // class for yes button (or yes_class)
        style    : '',      // style for yes button (or yes_style)
        callBack : null     // callBack for yes button (or yes_callBack)
    },
    btn_no       : {
        text     : 'No',    // text for no button (or no_text)
        class    : 'w2ui-btn',      // class for no button (or no_class)
        style    : '',      // style for no button (or no_style)
        callBack : null     // callBack for no button (or no_callBack)
    },
    callBack     : null     // common callBack
};

// reverse confirmation dialog box options
var reverse_confirm_options = {
    msg          : '<p>Are you sure you want to reverse this entry?</p>',
    title        : '',
    width        : 340,     // width of the dialog
    height       : 160,     // height of the dialog
    btn_yes      : {
        text     : 'Yes',   // text for yes button (or yes_text)
        class    : 'w2ui-btn w2ui-btn-red',      // class for yes button (or yes_class)
        style    : '',      // style for yes button (or yes_style)
        callBack : null     // callBack for yes button (or yes_callBack)
    },
    btn_no       : {
        text     : 'No',    // text for no button (or no_text)
        class    : 'w2ui-btn',      // class for no button (or no_class)
        style    : '',      // style for no button (or no_style)
        callBack : null     // callBack for no button (or no_callBack)
    },
    callBack     : null     // common callBack
};

// ChangeBusiness updates the UI to the newly selected business.
// This routine is indeed used, in spite of what JSHint thinks. It
// is embedded in a string defining the OnClick handler for a button
// in the main toolbar.
function ChangeBusiness() {
    var bizName = $("select[name=BusinessSelect]").find(":selected").attr("name"),
        bizVal = $("select[name=BusinessSelect]").val();

    // if same business value then nothing to do
    if (bizName === app.last.BUD) {
        return;
    }

    w2ui.toplayout.content('main', ' ');
    w2ui.toplayout.hide('right',true);
    var s = w2ui.sidebarL1;
    var sel = s.selected;
    if (sel !== null) {
        s.unselect(sel);
    }

    var no_callBack = function() {
        // revert back to last one
        $("select[name=BusinessSelect] option[value="+app.last.BID+"]").prop("selected", true);
        return false;
    },
    yes_callBack = function() {
        w2ui.toplayout.content('main', ' ');
        w2ui.toplayout.hide('right',true);
        var s = w2ui.sidebarL1;
        var sel = s.selected;
        if (sel !== null) {
            s.unselect(sel);
        }
        w2ui.reportslayout.load('main','/html/blank.html');
        app.last.report = '';
        app.last.BUD = bizName;
        app.last.BID = bizVal;
        s.collapse('reports');
        return true;
    };

    // warn user if active form has been changed
    form_dirty_alert(yes_callBack, no_callBack);
}

function switchToGrid(svc) {
    var grid = svc + 'Grid'; // this builds the name of the w2ui grid we want
    var x = getCurrentBusiness();
    var url = '/v1/' + svc + '/' + x.value;
    w2ui[grid].url = url;
    w2ui[grid].last.sel_recid = null; // whenever switch grid, erase last selected record
    app.last.grid_sel_recid = -1;
    app.active_grid = grid; // mark active grid in app.active_grid
    w2ui.toplayout.content('main', w2ui[grid]);
    w2ui.toplayout.hide('right',true);
}

function defineDateFmts() {
    var month = (new Date()).getMonth() + 1;
    var year  = (new Date()).getFullYear();
    // // US Format
    $('input[type=us-date]').w2field('date', { format: 'm/d/yyy' });
    $('input[type=us-dateA]').w2field('date', { format: 'm/d/yyyy', start:  month + '/5/' + year, end: month + '/25/' + year });
    $('input[type=us-dateB]').w2field('date', { format: 'm/d/yyyy', blocked: [ month+'/12/2014',month+'/13/2014',month+'/14/' + year,]});
    $('input[type=us-date1]').w2field('date', { format: 'm/d/yyyy', end: $('input[type=us-date2]') });
    $('input[type=us-date2]').w2field('date', { format: 'm/d/yyyy', start: $('input[type=us-date1]') });
    $('input[type=us-time]').w2field('time',  { format: 'h12' });
    $('input[type=us-timeA]').w2field('time', { format: 'h12', start: '8:00 am', end: '4:30 pm' });

    // EU Common Format
    $('input[type=eu-date]').w2field('date',  { format: 'd.m.yyyy' });
    $('input[type=eu-dateA]').w2field('date', { format: 'd.m.yyyy', start:  '5.' + month + '.' + year, end: '25.' + month + '.' + year });
    $('input[type=eu-dateB]').w2field('date', { format: 'd.m.yyyy', blocked: ['12.' + month + '.' + year, '13.' + month + '.' + year, '14.' + month + '.' + year]});
    $('input[type=eu-date1]').w2field('date', { format: 'd.m.yyyy', end: $('input[type=eu-date2]') });
    $('input[type=eu-date2]').w2field('date', { format: 'd.m.yyyy', start: $('input[type=eu-date1]') });
    $('input[type=eu-time]').w2field('time',  { format: 'h24' });
    $('input[type=eu-timeA]').w2field('time', { format: 'h24', start: '8:00 am', end: '4:30 pm' });
}

function openInNewTab(url) {
    var win = window.open(url, '_blank');
    win.focus();
}

// The reason to load these elements in this way rather than storing them as part of a
// 'config' variable then passing them into the widget generators is that we need to
// download the lists first. Making the elements part of a config.* variable would evaluate
// the dropdown lists prior to downloading their values. By doing it this way, we download
// the lists first so that their values will be set by the server before we build the UI.
function buildPageElements() {
    //------------------------------------------------------------------------
    //          mainlayout
    //------------------------------------------------------------------------
    $('#layout').w2layout({
        name: 'mainlayout',
        padding: 2,
        panels: [
            { type: 'top', size: 55, style: app.pstyle, content: 'top' },
            { type: 'left', size: app.sidebarWidth, hidden: true, style: app.pstyle, content: 'left' },
            { type: 'main', style: app.pstyle, content: 'main' },
            { type: 'preview', size: '50%', resizable: true, hidden: true, style: app.pstyle, content: 'preview' },
            { type: 'right', size: 200, resizable: true, style: app.pstyle, hidden: true, content: 'Details' },
            { type: 'bottom', size: 20, resizable: false, style: app.stdfmt, content: '&copy; 2015-2017 Accord Interests' }
        ]
    });


    //------------------------------------------------------------------------
    //          toptoolbar
    //------------------------------------------------------------------------
    w2ui.mainlayout.content('top', $().w2toolbar({
        name: 'toptoolbar',
        items: [
             { type: 'html',  id: 'logo',
                html: '<div style="padding: 4px 0px;">'+
                      '<img src="/html/images/logo.png">'+
                      '</div>'
            },
            { type: 'break', id: 'break1' },
            { type: 'menu',    id: 'moduleMenu', caption: 'Select Module',    icon: 'fa fa-sitemap', items: [
                { text: 'Directory',          icon: 'fa fa-user' },
                { text: 'RentRoll',           icon: 'fa fa-building-o' },
                { text: 'Mojo',               icon: 'fa fa-envelope-o' },
                { text: 'Forms & Procedures', icon: 'fa fa-book' },
            ]},
             { type: 'html',  id: 'BUD',
                html: //'<div style="background-color: #eee; padding: 10px 5px; border-bottom: 1px solid silver">'+
                    '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<i class="fa fa-building-o"></i> &nbsp;' + app.sBusinessUnit +
                    ': <select name="BusinessSelect" onchange="ChangeBusiness();">'+
                    '{{range .BL}}<option value="{{.BID}}" name="{{.Designation}}">{{.Designation}}</option>{{end}}'+
                    '</select>&nbsp;&nbsp;&nbsp;' //+ '</div>'
            },
            { type: 'break',  id: 'break2' },
            { type: 'button', id: 'msgButton',  caption: 'News Flash', icon: 'fa fa-spinner fa-pulse fa-3x fa-fw'},
            { type: 'menu',   id: 'menuButton', caption: 'Developer',  icon: 'fa fa-user-circle', items: [
                { text: 'Webdocs',       icon: 'fa fa-book' },
                { text: 'Template-Dflt', icon: 'fa fa-language' },
                { text: 'Template-Apts', icon: 'fa fa-language' },
                { text: 'Messages',      icon: 'fa fa-folder-o' },
            ]},
            { id: 'bt3', type: 'spacer' },
            { id: 'help', text: 'Help', type: 'button', icon: 'fa fa-question-circle' },
        ],
        onRender: function(event) {
            event.onComplete = function() {
                // when this render complete then store default selected business in app.last
                app.last.BUD = $("select[name=BusinessSelect]").find(":selected").attr("name");
                app.last.BID = $("select[name=BusinessSelect]").val();
            };
        },
        onClick: function (event) {
            console.log('target = ' + event.target);
            switch(event.target) {
                case "moduleMenu:Directory":      window.location.href = 'https://directory.airoller.com/'; break;
                case "menuButton:Template-Dflt":  window.location.href = '/home/en-us/default';             break;
                case "menuButton:Template-Apts":  window.location.href = '/home/en-us/apts';                break;
                case "moduleMenu:RentRoll":       window.location.href = '/';                               break;
                case "moduleMenu:Mojo":           window.location.href = 'http://localhost:8275/home/';     break;
                case "menuButton:Webdocs": openInNewTab('/doc/docs.html'); break;
                case "msgButton":
                case "menuButton:Messages":
                        w2ui.toplayout.toggle('top',true);
                        w2ui.toplayout.set('top',{ content: w2ui.newsLayout});
                        w2ui.newsLayout.load('main', '/html/news.html', 'flip-down', function () {console.log('content loaded');});
                        w2ui.toptoolbar.set('msgButton', {icon: 'fa fa-newspaper-o'});
                        break;
            }
        },
    }));

    buildTopLayout();
    buildNewsLayout();
    buildSidebar();
    buildAllocFundsGrid();
    buildAccountElements();
    buildTransactElements();
    buildRentableTypeElements();
    buildRentableElements();
    buildRAElements();
    buildRAPayorPicker();
    buildRUserPicker();
    buildRentablePicker();
    buildRAFinder();
    buildReceiptElements();
    buildAssessmentElements();
    buildARElements();
    buildPaymentTypeElements();
    buildDepositoryElements();
    buildReportElements();
    buildTWSElemets();

    //------------------------------------------------------------------------
    //          notesPopUp
    //------------------------------------------------------------------------
    function notesPopUp() {
        w2popup.open({
            width   : 580,
            height  : 350,
            title   : 'Notes',
            body    : '<div class="w2ui-centered" style="line-height: 1.8">'+
                      '     This is a sample of what the Notes area.'+
                      '     <br>The focus will not leave popup. <br><br>'+
                      '     Add Note: <textarea name="comments" type="text" style="width: 385px; height: 80px"></textarea><br>'+
                       '</div>',
            buttons : '<button class="w2ui-btn" onclick="w2popup.close()">Ok</button>'+
                      '<button class="w2ui-btn" onclick="w2popup.close()">Cancel</button>'
        });
    }

}  // buildPageElements

function popupRentalAgrPicker() {
    var x = getCurrentBusiness();
    app.RentalAgrFinder = {BID: x.value, RAID: 0, TCID: 0, RID: 0, FirstName: '', LastName: '', CompanyName: '', IsCompany: false, RAR: [], RARentablesNames: []};
    app.RentalAgrFinder.RARentablesNames = [{id: 0, text:" "}];
    w2ui.rentalAgrFinder.fields[2].options.items = app.RentalAgrFinder.RARentablesNames;
    w2ui.rentalAgrFinder.record.TCID = -1;
    w2ui.rentalAgrFinder.record.RAID = -1;
    w2ui.rentalAgrFinder.record.PayorName = '';
    w2ui.rentalAgrFinder.record.IsCompany = -1;
    w2ui.rentalAgrFinder.record.CompanyName = '';
    w2ui.rentalAgrFinder.record.FirstName = '';
    w2ui.rentalAgrFinder.record.LastName = '';
    w2ui.rentalAgrFinder.refresh();


    $().w2popup('open', {
        title   : 'Find Rental Agreement',
        body    : '<div id="form" style="width: 100%; height: 100%;"></div>',
        style   : 'padding: 15px 0px 0px 0px',
        width   : 400,
        height  : 250,
        showMax : true,
        onToggle: function (event) {
            $(w2ui.rentalAgrFinder.box).hide();
            event.onComplete = function () {
                $(w2ui.rentalAgrFinder.box).show();
                w2ui.rentalAgrFinder.resize();
            };
        },
        onOpen: function (event) {
            event.onComplete = function () {
                // specifying an onOpen handler instead would be equivalent to specifying
                // an onBeforeOpen handler, which would make this code execute too
                // early and hence not deliver.
                $('#w2ui-popup #form').w2render('rentalAgrFinder');
            };
        }
    });
}

function createRentalAgreementForm() {
    w2ui.raLayout.content('left', w2ui.rentalagrForm);
    w2ui.raLayout.content('main', w2ui.raLayoutSub1);

    w2ui.raLayoutSub1.content('top', w2ui.rarGrid);
    w2ui.rarGrid.header = plural(app.sRentable);
    w2ui.raLayoutSub1.content('main', w2ui.rapGrid);
    w2ui.rapGrid.header = plural(app.sPayor);

    w2ui.raLayoutSub1.content('preview', w2ui.rauGrid);
    w2ui.rauGrid.header = plural(app.sUser);
    w2ui.raLayoutSub1.content('bottom', w2ui.raPetGrid);
    w2ui.raPetGrid.header = "Pets";
}

function finishInitialization() {
    defineDateFmts();
    buildPageElements();
    createRentalAgreementForm();
    var d1 = new Date();
    d1.setDate(1);
    app.D1 = dateControlString(d1);
    var d2 = dateMonthFwd(d1);
    app.D2 = dateControlString(d2);
}

$(function () {
    $.get('/v1/uilists/' + app.language + '/' + app.template)
    .done(function(data, textStatus, jqXHR) {

        if (data.substring(11,14) == "err") {
            console.log('ERROR: '+data);
        }

        // if status is success then
        if (jqXHR.status == 200) {
            var app_data = JSON.parse(data);
            // fit all lists, values, maps in app variable
            for( var key in app_data ) {
                app[key] = app_data[key];
            }
        } else {
            console.log( '**** YIPES! ****  status on /v1/uilists/ = ' + textStatus);
        }

        // finish initialization
        finishInitialization();

    })
    .fail( function() {
        console.log('Error getting /v1/uilists');
    });
});

// =================================================
// WINDOW BEFORE UNLOAD EVENT
// =================================================
// warn user if active form content has been changed
// for security reason you can't just popup your custom dialog
// see the thread: https://stackoverflow.com/questions/30712377/jquery-beforeunload-custom-pop-up-window-for-leaving-a-page
function form_dirty_alert_window_unload(e) {
    if (app.form_is_dirty){
        if(!e) e = window.event;

        //e.cancelBubble is supported by IE - this will kill the bubbling process.
        e.cancelBubble = true;

        //e.stopPropagation works in Firefox.
        if (e.stopPropagation) {
            e.stopPropagation();
            e.preventDefault();
        }
        return "Changes in the form that you made may not be saved.";
    }
}
window.onbeforeunload=form_dirty_alert_window_unload;
// =================================================

</script>

<div id="layout"style="position: absolute; top: 0px; left: 0px; bottom: 0px; right: 0px;"></div>
<script src="/js/bundle.js"></script>
</body>
</html>
