<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="/js/w2ui-1.5.rc1.min.css" />
    <script src="/js/jquery.min.js"></script>
    <script src="/js/w2ui-1.5.rc1.js"></script>
    <link rel="stylesheet" href="/html/fa/css/font-awesome.min.css">
    <link rel="stylesheet" href="/html/rentroll.css">
    <script src="/js/rutil.js"></script>
    <link rel="icon" type="image/png" href="/html/images/favicon32x32.png">
</head>
<body>

<!--  color Icon images:  icon-page, w2ui-icon-check, ... see below in toptoolbar -->
<!--

mainlayout    - w2ui layout toptoolbar, toplayout, footer
toplayout     - w2ui layout for sidebar, main, and right (Detail)
reportslayout - w2ui layout for reports, main for reports, and top for toolbar
toptoolbar    - w2ui toolbar
sidebarL1     - w2ui sidebar

-->

<script>
/*global
    w2ui, console, plural, monthBack, monthFwd, dayBack, dayFwd, setToRAForm, setToForm,
    w2uiDateControlString, w2popup, getCurrentBusiness, dateControlString, dateMonthFwd,
    tcidPickerDropRender, tcidRAPayorPickerRender, tcidPickerCompare, dateMonthBack,
    ridRentablePickerRender, ridRentableDropRender,ridRentableCompare, calcRarGridContractRent,
    handleDateToolbarAction, setDateControlsInToolbar, genDateRangeNavigator, getPaymentTypeName,
    getBUDfromBID, buildPaymentTypeOptions, getPaymentTypeID, buildPaymentTypeSelectList,
    tcidReceiptPayorPickerRender, asmFormRentablePickerRender, unallocAmountRemaining
*/

/*globals $:false */

// The rentroll app object, used to manage app-level data.
var app = {
    D1: "2016-02-01",
    D2: "2016-03-01",
    uid: 211,
    lastReport: '',
    WidestFormWidth: 900,
    sidebarWidth: 215,
    TmpTCID: 0,  // holds TCID of Payor from Apply Payments grid - Save function on unpaid assessments grid uses it
    TcidRAPayorPicker: {BID: 0},
    TcidRUserPicker: {BID: 0, Title: '', RAID: 0, RARentablesNames: [], RAR: []},
    RentalAgrFinder: {BID: 0, RAID: 0, TCID: 0, FirstName: '', LastName: '', CompanyName: '', IsCompany: false, RAR: [], RARentablesNames: []},
    ridRentablePicker: {BID: 0, Title: '', RAID: 0},
    ARTypes: {0: "Assessment", 1: "Receipt"},
    Assessments: [{id: 0, text: "Set Assessment Rule"},],
    Receipts: [{id: 1, text: "Set Payment Rule"},],
    language: "{{.Language}}",
    template: "{{.Template}}",
    pstyle: 'border: 1px solid #dfdfdf; padding: 0px;',
    pstyleNB: 'border: 0px solid #dfdfdf; padding: 0px;',
    pstyle4: 'border: 1px solid #bbbbbb; padding: 0px;',
    pstyle2: 'border: 1px solid #cfcfcf; padding: 0px;',
    //prefmt: 'font-family: "Monaco", "Menlo", "Source Code Pro", monospace; white-space: pre; font-size: 9pt; background-color: white;',
    prefmt: 'border:4px; solid #bbbbbb; background-color: white;',
    bgyellow: 'background-color: yellow;',
    stdfmt: 'font-family: "Open Sans","Roboto",sans-serif; font-size: 8pt; border: 1px solid #dfdfdf; border-spacing:0px; padding: 3px; color: #777777;',
    refreshInhibit: false,
    receiptsToolbarOnClickAdded: false,
    paymentTypeList: [{id: 10, text: "check"}, {id: 11, text:"VISA"}],  // just an example, will be set when the grid is shown based on current Business
    arList: [{id: 0, text:"Assessment"}, {id:1, text:"Receipt"}],
    rt_list: {},
    gl_accounts: {}, // this holds the list of GLAccount per business
    parent_accounts: {}, // possible parent accounts
    post_accounts: {}, // possible post accounts
    rof: {"csv": 4, "pdf": 3}, // report export/output format
    pdfPageWidth: 8.5, // defaults to USLetter Portrait width
    pdfPageHeight: 11, // defaults to USLetter Portrait height
    pageSizes: {
        "USLetter": { "w": 8.5, "h": 11 },
        "Legal": { "w": 8.5, "h": 14 },
        "Ledger": { "w": 11, "h": 17 },
    },
    activeGrid: "", // which one is active now
    new_form_rec: false,
};

// delete confirmation dialog box options
var delete_confirm_options = {
    msg          : 'Are you sure you want to delete this record?',
    title        : '',
    width        : 340,     // width of the dialog
    height       : 160,     // height of the dialog
    btn_yes      : {
        text     : 'Yes',   // text for yes button (or yes_text)
        class    : 'w2ui-btn w2ui-btn-red',      // class for yes button (or yes_class)
        style    : '',      // style for yes button (or yes_style)
        callBack : null     // callBack for yes button (or yes_callBack)
    },
    btn_no       : {
        text     : 'No',    // text for no button (or no_text)
        class    : 'w2ui-btn',      // class for no button (or no_class)
        style    : '',      // style for no button (or no_style)
        callBack : null     // callBack for no button (or no_callBack)
    },
    callBack     : null     // common callBack
};

function exportReportCSV(rptname){
    "use strict";
    if (rptname === '') {
        return;
    }
    var x = getCurrentBusiness();
    var userid = 211;
    var url = '/wsvc/' + userid + '/' + x.value + '?r=' + rptname;
    var y = document.getElementsByName("dateD1");
    if (y.length === 0) {
        return; // the toolbar has not been rendered yet.  Just return now, we'll get called back.
    }
    var d = y[0].value;
    app.D1 = d;
    url += '&dtstart=' + d;
    //console.log('d1 = ' + d);
    y = document.getElementsByName("dateD2");
    d = y[0].value;
    app.D2 = d;
    // console.log('d2 = ' + d);
    url += '&dtstop=' + d;
    // now append the report output format
    url += '&rof=' + app.rof.csv;
    console.log('url = ' + url);
    // open separate window
    window.open(url);
}

function popupPDFCustomDimensions() {
    "use strict";
    w2popup.open({
        title     : 'PDF custom width and height',
        body      : '<div class="w2ui-centered">' +
            '<div class="w2ui-field"><label>Page Width (inch): </label><div><input type="text" name="custom_pdf_width" class="w2ui-input" value="'+app.pdfPageWidth+'" /></div></div>' +
            '<div class="w2ui-field"><label>Page Height (inch): </label><div><input type="text" name="custom_pdf_height"  class="w2ui-input" value="'+app.pdfPageHeight+'" /></div></div>' +
            '</div>',
        buttons   : '<button class="w2ui-btn" onclick="w2popup.close();">Close</button> '+
                    '<button class="w2ui-btn" onclick="saveCustomDims();" >Save</button>',
        width     : 500,
        height    : 200,
        overflow  : 'hidden',
        color     : '#333',
        speed     : '0.3',
        opacity   : '0.5',
        modal     : true,
        showClose : true,
    });
}

function saveCustomDims() {
    "use strict";
    var width = parseFloat($("input[name='custom_pdf_width']").val());
    if (!isNaN(width)) {
        app.pdfPageWidth = width;
    }
    var height = parseFloat($("input[name='custom_pdf_height']").val());
    if (!isNaN(height)) {
        app.pdfPageHeight = height;
    }
    w2popup.close();
}

function exportReportPDF(rptname){
    "use strict";
    if (rptname === '') {
        return;
    }
    var x = getCurrentBusiness();
    var userid = 211;
    var url = '/wsvc/' + userid + '/' + x.value + '?r=' + rptname;
    var y = document.getElementsByName("dateD1");
    if (y.length === 0) {
        return; // the toolbar has not been rendered yet.  Just return now, we'll get called back.
    }
    var d = y[0].value;
    app.D1 = d;
    url += '&dtstart=' + d;
    //console.log('d1 = ' + d);
    y = document.getElementsByName("dateD2");
    d = y[0].value;
    app.D2 = d;
    // console.log('d2 = ' + d);
    url += '&dtstop=' + d;
    // now append the report output format
    url += '&rof=' + app.rof.pdf;
    // need to pass page width and height
    url += '&pw=' + app.pdfPageWidth + "&ph=" + app.pdfPageHeight;
    console.log('url = ' + url);
    // open separate window
    window.open(url);
}

function showReport(rptname, elToFocus) {
    "use strict";
    if (rptname === '') {
        return;
    }
    var x = getCurrentBusiness();
    var userid = 211;
    var url = '/wsvc/' + userid + '/' + x.value + '?r=' + rptname;
    w2ui.toplayout.content('main', w2ui.reportslayout);
    w2ui.toplayout.hide('right',true);
    var y = document.getElementsByName("dateD1");
    if (y.length === 0) {
        return; // the toolbar has not been rendered yet.  Just return now, we'll get called back.
    }
    var d = y[0].value;
    app.D1 = d;
    url += '&dtstart=' + d;
    //console.log('d1 = ' + d);
    y = document.getElementsByName("dateD2");
    d = y[0].value;
    app.D2 = d;
    // console.log('d2 = ' + d);
    url += '&dtstop=' + d;
    console.log('url = ' + url);
    var callBack;

    if (elToFocus) {
        callBack = function() {
            // document.getElementsByName(elToFocus)[0].focus(); // arrr..... does not found element, WHY!!
        };
    }
    w2ui.reportslayout.load('main', url, null, callBack);
}


// ChangeBusiness updates the UI to the newly selected business.
// This routine is indeed used, in spite of what JSHint thinks. It
// is embedded in a string defining the OnClick handler for a button
// in the main toolbar.
function ChangeBusiness() {
    "use strict";
    w2ui.toplayout.content('main', ' ');
    w2ui.toplayout.hide('right',true);
    var s = w2ui.sidebarL1;
    var sel = s.selected;
    if (sel !== null) {
        s.unselect(sel);
    }
    w2ui.reportslayout.load('main','/html/blank.html');
    app.lastReport = '';
    s.collapse('reports');
    s.collapse('admin');
}

function switchToGrid(svc) {
    "use strict";
    var grid = svc + 'Grid'; // this builds the name of the w2ui grid we want
    var x = getCurrentBusiness();
    var url = '/v1/' + svc + '/' + x.value;
    w2ui[grid].url = url;
    w2ui[grid].last.sel_recid = null; // whenever switch grid, erase last selected record
    app.activeGrid = grid; // mark active grid in app.activeGrid

    // Special Handling
    switch(svc) {
    case 'receipts':
        // need to set up Payment Type list -- varies by business
        var BUD = getBUDfromBID(x.value);
        app.paymentTypeList = buildPaymentTypeSelectList( BUD );
        w2ui.receiptsGrid.columns[8].editable.items = app.paymentTypeList;
        break;
    }
    w2ui.toplayout.content('main', w2ui[grid]);
    w2ui.toplayout.hide('right',true);
}

function defineDateFmts() {
    "use strict";
    var month = (new Date()).getMonth() + 1;
    var year  = (new Date()).getFullYear();
    // // US Format
    $('input[type=us-date]').w2field('date', { format: 'm/d/yyy' });
    $('input[type=us-dateA]').w2field('date', { format: 'm/d/yyyy', start:  month + '/5/' + year, end: month + '/25/' + year });
    $('input[type=us-dateB]').w2field('date', { format: 'm/d/yyyy', blocked: [ month+'/12/2014',month+'/13/2014',month+'/14/' + year,]});
    $('input[type=us-date1]').w2field('date', { format: 'm/d/yyyy', end: $('input[type=us-date2]') });
    $('input[type=us-date2]').w2field('date', { format: 'm/d/yyyy', start: $('input[type=us-date1]') });
    $('input[type=us-time]').w2field('time',  { format: 'h12' });
    $('input[type=us-timeA]').w2field('time', { format: 'h12', start: '8:00 am', end: '4:30 pm' });

    // EU Common Format
    $('input[type=eu-date]').w2field('date',  { format: 'd.m.yyyy' });
    $('input[type=eu-dateA]').w2field('date', { format: 'd.m.yyyy', start:  '5.' + month + '.' + year, end: '25.' + month + '.' + year });
    $('input[type=eu-dateB]').w2field('date', { format: 'd.m.yyyy', blocked: ['12.' + month + '.' + year, '13.' + month + '.' + year, '14.' + month + '.' + year]});
    $('input[type=eu-date1]').w2field('date', { format: 'd.m.yyyy', end: $('input[type=eu-date2]') });
    $('input[type=eu-date2]').w2field('date', { format: 'd.m.yyyy', start: $('input[type=eu-date1]') });
    $('input[type=eu-time]').w2field('time',  { format: 'h24' });
    $('input[type=eu-timeA]').w2field('time', { format: 'h24', start: '8:00 am', end: '4:30 pm' });
}

function openInNewTab(url) {
    "use strict";
    var win = window.open(url, '_blank');
    win.focus();
}

// The reason to load these elements in this way rather than storing them as part of a
// 'config' variable then passing them into the widget generators is that we need to
// download the lists first. Making the elements part of a config.* variable would evaluate
// the dropdown lists prior to downloading their values. By doing it this way, we download
// the lists first so that their values will be set by the server before we build the UI.
function buildPageElements() {
    "use strict";
    //------------------------------------------------------------------------
    //          mainlayout
    //------------------------------------------------------------------------
    $('#layout').w2layout({
        name: 'mainlayout',
        padding: 2,
        panels: [
            { type: 'top', size: 55, style: app.pstyle, content: 'top' },
            { type: 'left', size: app.sidebarWidth, hidden: true, style: app.pstyle, content: 'left' },
            { type: 'main', style: app.pstyle, content: 'main' },
            { type: 'preview', size: '50%', resizable: true, hidden: true, style: app.pstyle, content: 'preview' },
            { type: 'right', size: 200, resizable: true, style: app.pstyle, hidden: true, content: 'Details' },
            { type: 'bottom', size: 20, resizable: false, style: app.stdfmt, content: '&copy; 2015-2017 Accord Interests' }
        ]
    });


    //------------------------------------------------------------------------
    //          NEWS LAYOUT
    //------------------------------------------------------------------------
    $().w2layout({
        name: 'newsLayout',
        padding: 0,
        panels: [
            { type: 'left', hidden: false, style: app.pstyleNB, size: 20 },
            { type: 'top', hidden: true },
            { type: 'main', size: '90%', resizable: true, hidden: false, style: app.pstyleNB, content: 'Hi.  I should load w2ui.newsLayout' },
            { type: 'preview', hidden: true },
            { type: 'bottom', hidden: true },
            { type: 'right', hidden: true }
        ]
    });

    //------------------------------------------------------------------------
    //          toplayout
    //------------------------------------------------------------------------
    w2ui.mainlayout.content('main', $().w2layout({
        name: 'toplayout',
        padding: 2,
        panels: [
            { type: 'top',     size: 200, style: app.pstyle2,  hidden: true, resizable: true, content: w2ui.newsLayout},
            { type: 'left',    size: app.sidebarWidth, style: app.pstyle2,                resizable: true, content: 'sidebar' },
            { type: 'main',               style: app.pstyle2   },
            { type: 'preview', size: 0,   style: app.bgyellow, hidden: true, resizable: true, content: 'preview' },
            { type: 'right',   size: 200, style: app.pstyle2,  hidden: true, resizable: true },
            { type: 'bottom',  size: 0,   style: app.pstyle2,  hidden: true, resizable: true, content: 'toplayout - bottom' }
        ]
    }));

    //------------------------------------------------------------------------
    //          toptoolbar
    //------------------------------------------------------------------------
    w2ui.mainlayout.content('top', $().w2toolbar({
        name: 'toptoolbar',
        items: [
             { type: 'html',  id: 'logo',
                html: '<div style="padding: 4px 0px;">'+
                      '<img src="/html/images/logo.png">'+
                      '</div>'
            },
            { type: 'break', id: 'break1' },
            { type: 'menu',    id: 'moduleMenu', caption: 'Select Module',    icon: 'fa fa-sitemap', items: [
                { text: 'Directory',          icon: 'fa fa-user' },
                { text: 'RentRoll',           icon: 'fa fa-building-o' },
                { text: 'Mojo',               icon: 'fa fa-envelope-o' },
                { text: 'Forms & Procedures', icon: 'fa fa-book' },
            ]},
             { type: 'html',  id: 'BUD',
                html: //'<div style="background-color: #eee; padding: 10px 5px; border-bottom: 1px solid silver">'+
                    '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<i class="fa fa-building-o"></i> &nbsp;' + app.sBusinessUnit +
                    ': <select name="BusinessSelect" onchange="ChangeBusiness()">'+
                    '{{range .BL}}<option value="{{.BID}}" name="{{.Designation}}">{{.Designation}}</option>{{end}}'+
                    '</select>&nbsp;&nbsp;&nbsp;' //+ '</div>'
            },
            { type: 'break',  id: 'break2' },
            { type: 'button', id: 'msgButton',  caption: 'News Flash', icon: 'fa fa-spinner fa-pulse fa-3x fa-fw'},
            { type: 'menu',   id: 'menuButton', caption: 'Developer',  icon: 'fa fa-user-circle', items: [
                { text: 'Webdocs',       icon: 'fa fa-book' },
                { text: 'Template-Dflt', icon: 'fa fa-language' },
                { text: 'Template-Apts', icon: 'fa fa-language' },
                { text: 'Messages',      icon: 'fa fa-folder-o' },
            ]},
            { id: 'bt3', type: 'spacer' },
            { id: 'help', text: 'Help', type: 'button', icon: 'fa fa-question-circle' },
        ],
        onClick: function (event) {
            console.log('target = ' + event.target);
            switch(event.target) {
                case "moduleMenu:Directory":      window.location.href = 'https://directory.airoller.com/'; break;
                case "menuButton:Template-Dflt":  window.location.href = '/home/en-us/default';             break;
                case "menuButton:Template-Apts":  window.location.href = '/home/en-us/apts';                break;
                case "moduleMenu:RentRoll":       window.location.href = '/';                               break;
                case "moduleMenu:Mojo":           window.location.href = 'http://localhost:8275/home/';     break;
                case "menuButton:Webdocs": openInNewTab('/doc/docs.html'); break;
                case "msgButton":
                case "menuButton:Messages":
                        w2ui.toplayout.toggle('top',true);
                        w2ui.toplayout.set('top',{ content: w2ui.newsLayout});
                        w2ui.newsLayout.load('main', '/html/news.html', 'flip-down', function () {console.log('content loaded');});
                        w2ui.toptoolbar.set('msgButton', {icon: 'fa fa-newspaper-o'});
                        break;
            }
        },
    }));

    //------------------------------------------------------------------------
    //          sidebarL1
    //------------------------------------------------------------------------
    w2ui.toplayout.content('left',$().w2sidebar({
        name: 'sidebarL1',
        nodes: [
            { id: 'workflowreceipts', text: plural(app.sAssessment)+' / '+plural(app.sReceipt), img: 'icon-folder', expanded: true, group: true,
                nodes: [
                        { id: 'asms',         text: 'Assess Charges',                icon: 'fa fa-star-o',      hint: plural(app.sAssessment) },
                        { id: 'receipts',     text: 'Receive '+plural(app.sReceipt), icon: 'fa fa-star',        hint: plural(app.sReceipt) },
                        { id: 'mkdep',        text: 'Make A Deposit',                icon: 'fa fa-plus-circle', hint: 'Make Deposit' },
                        { id: 'allocfunds',   text: 'Apply '+plural(app.sReceipt),   icon: 'fa fa-check-circle-o' },
                        { id: 'reversepmt',   text: 'Reverse '+plural(app.sReceipt), icon: 'fa fa-window-close' },
                        { id: 'gdssvcs',      text: 'Goods & Services',              icon: 'fa fa-coffee' },
               ]
            },
            { id: 'rentagr', text: plural(app.sRentalAgreement), img: 'icon-folder', expanded: true, group: true,
                nodes: [
                        { id: 'transactants', text: plural(app.sTransactant),        icon: 'fa fa-users' },
                        { id: 'assignrnt',    text: 'Assign A ' + app.sRentable,     icon: 'fa fa-check-square-o' },
                        { id: 'movein',       text: app.sTransactant + ' Arrival',   icon: 'fa fa-sign-in' },
                        { id: 'moveout',      text: app.sTransactant + ' Departure', icon: 'fa fa-sign-out' },
                        { id: 'rentalagrs',   text: 'Add/Modify Agreements',         icon: 'fa fa-certificate', hint: 'Add/Modify Agreements' },
                        { id: 'updatera',     text: 'Extend ' + app.sRentalAgreement,icon: 'fa fa-pencil' },
                ]
            },
            { id: 'collections', text: 'Collections', img: 'icon-folder', expanded: false, group: true,
                nodes: [
                        { id: 'dlnq',         text: 'Delinquency Analysis',          icon: 'fa fa-pie-chart',   hint: 'Delinquency Analysis' },
                        { id: 'prepnotice',   text: 'Prepare Notices',               icon: 'fa fa-file-text-o', hint: 'Prepare Notices' },
                ]
            },
            { id: 'acct', text: 'Accounting', img: 'icon-folder', expanded: false, group: true,
                nodes: [
                        { id: 'close',       text: 'Close Period',                   icon: 'fa fa-toggle-down', hint: 'Close Period' },
                        { id: 'adjust',      text: 'Adjust Closed Period',           icon: 'fa fa-reply',       hint: 'Adjust Closed Period' },
                ]
            },
            { id: 'facilities', text: 'Facilities Management', img: 'icon-folder', expanded: false, group: true,
                nodes: [
                        { id: 'svcreq',      text: 'Create Service Request',         icon: 'fa fa-square-o',       hint: 'Create Service Request' },
                        { id: 'svcreqcmp',   text: 'Complete Service Request',       icon: 'fa fa-check-square-o', hint: 'Complete Service Request' },
                        { id: 'housekpg',    text: 'Housekeeping',                   icon: 'fa fa-home',           hint: 'Housekeeping' },
                        { id: 'prvmaint',    text: 'Preventative Maintenance',       icon: 'fa fa-wrench',         hint: 'Preventative Maintenance' },
                        { id: 'invntory',    text: 'Inventory',                      icon: 'fa fa-shopping-cart',  hint: 'Preventative Maintenance' },
                ]
            },
            { id: 'reports', text: 'Reports', img: 'icon-folder', expanded: false, group: true,
                nodes: [
                       //{ id: 'RPTasmrpt',     text: 'Assessments',                     icon: 'fa fa-file-text-o' },
                       //{ id: 'RPTb',          text: 'Business Units',                  icon: 'fa fa-file-text-o' },
                       { id: 'RPTcoa',          text: 'Chart Of Accounts',               icon: 'fa fa-file-text-o' },
                       //{ id: 'RPTdpm',        text: 'Deposit Methods',                 icon: 'fa fa-file-text-o' },
                       //{ id: 'RPTdep',        text: 'Depositories',                    icon: 'fa fa-file-text-o' },
                       { id: 'RPTdelinq',       text: 'Delinquency',                     icon: 'fa fa-file-text-o' },
                       { id: 'RPTgsr',          text: 'GSR',                             icon: 'fa fa-file-text-o' },
                       { id: 'RPTj',            text: 'Journal',                         icon: 'fa fa-file-text-o' },
                       { id: 'RPTl',            text: 'Ledger',                          icon: 'fa fa-file-text-o' },
                       { id: 'RPTla',           text: 'Ledger Activity',                 icon: 'fa fa-file-text-o' },
                       { id: 'RPTpeople',       text: app.sTransactant,                  icon: 'fa fa-file-text-o' },
                       //{ id: 'RPTpmt',        text: 'Payment Types',                   icon: 'fa fa-file-text-o' },
                       //{ id: 'RPTrcpt',       text: 'Receipts',                        icon: 'fa fa-file-text-o' },
                       { id: 'RPTrcbt',         text: app.sRentable+' Type Counts',      icon: 'fa fa-file-text-o' },
                       { id: 'RPTr',            text: plural(app.sRentable),             icon: 'fa fa-file-text-o' },
                       { id: 'RPTra',           text: plural(app.sRentalAgreement),      icon: 'fa fa-file-text-o' },
                       { id: 'RPTrat',          text: app.sRentalAgreement+' Templates', icon: 'fa fa-file-text-o' },
                       { id: 'RPTrt',           text: app.sRentable+' Types',            icon: 'fa fa-file-text-o' },
                       { id: 'RPTrr',           text: 'RentRoll',                        icon: 'fa fa-file-text-o' },
                       //{ id: 'RPTstatements', text: 'Statements',                      icon: 'fa fa-file-text-o' },
                       //{ id: 'RPTsl',         text: 'String Lists',                    icon: 'fa fa-file-text-o' },
                       { id: 'RPTtb',           text: 'Trial Balance',                   icon: 'fa fa-file-text-o' },//
                ]
            },
            { id: 'setup', text: 'Setup', img: 'icon-wrench', expanded: true, group: true,
                nodes: [
                        { id: 'changeRT',    text: 'Change ' + app.sRentable +' Type',    icon: 'fa fa-refresh' },
                        { id: 'accounts',    text: 'Chart Of Accounts',                   icon: 'fa fa-list' },
                        { id: 'pmts',        text: 'Payment Types',                       icon: 'fa fa-credit-card' },
                        { id: 'dep',         text: 'Depositories',                        icon: 'fa fa-university' },
                        { id: 'ars',         text: 'Assessment/Receipt Rules',            icon: 'fa fa-cogs' },
                        { id: 'rt',          text: plural(app.sRentableType),             icon: 'fa fa-asterisk', hint: 'Rentable Types' },
                        { id: 'rentables',   text: 'Add/Modify ' + plural(app.sRentable), icon: 'fa fa-cube' },
                        { id: 'permissions', text: 'Permissions',                         icon: 'fa fa-thumbs-o-up' },
                ]
            },
        ],
        onExpand: function(event) {
            //var x = getCurrentBusiness();
            //console.log('current biz = ' + x.value + '  name = ' + x.name );
            switch (event.target) {
                case 'reports':
                    var w = w2ui.reportslayout;
                    w2ui.toplayout.content('main', w);
                    w2ui.toplayout.hide('right',true);
                    break;
            }

        },
        onFlat: function (event) {
            console.log('event.goFlat = ' + event.goFlat );
            $('#sidebarL1').css('width', (event.goFlat ? '35px' : ''+app.sidebarWidth+'px'));
        },
        onClick: function (event) {
            console.log('event.target = ' + event.target);
            switch(event.target) {
                case 'accounts':
                case 'rt':
                case 'rentables':
                case 'transactants':
                case 'rentalagrs':
                case 'receipts':
                case 'asms':
                case 'pmts':
                case 'dep':
                case 'ars':
                    w2ui.sidebarL1.collapse('reports'); // close reports when jumping to a main view
                    switchToGrid(event.target);
                    break;
                case 'goRatePlan':
                    w2ui.sidebarL1.collapse('reports'); // close reports when jumping to a main view
                    w2ui.toplayout.content('main', '<h1>Sorry :-(</h1><h2>Rate Plan...  Not Available</h2><h3>But coming soon!</h3>');
                    w2ui.toplayout.hide('right',true);
                    break;
                case 'goServiceMenu':
                    w2ui.sidebarL1.collapse('reports'); // close reports when jumping to a main view
                    w2ui.toplayout.content('main', '<h1>Sorry :-(</h1><h2>Service Menu...  Not Available</h2><h3>But coming soon!</h3>');
                    w2ui.toplayout.hide('right',true);
                    break;
                case 'mkdep':
                    w2ui.sidebarL1.collapse('reports'); // close reports when jumping to a main view
                    w2ui.toplayout.load('main', '/html/formmkdep.html');
                    w2ui.toplayout.hide('right',true);
                    break;
                case 'reversepmt':
                    w2ui.sidebarL1.collapse('reports'); // close reports when jumping to a main view
                    w2ui.toplayout.load('main', '/html/formrevrcpt.html');
                    w2ui.toplayout.hide('right',true);
                    break;
                case 'gdssvcs':
                    w2ui.sidebarL1.collapse('reports'); // close reports when jumping to a main view
                    w2ui.toplayout.load('main', '/html/formgas.html');
                    w2ui.toplayout.hide('right',true);
                    break;
                case 'assignrnt':
                    w2ui.sidebarL1.collapse('reports'); // close reports when jumping to a main view
                    w2ui.toplayout.load('main', '/html/formaar.html');
                    w2ui.toplayout.hide('right',true);
                    break;
                case 'movein':
                    w2ui.sidebarL1.collapse('reports'); // close reports when jumping to a main view
                    w2ui.toplayout.load('main', '/html/formmvin.html');
                    w2ui.toplayout.hide('right',true);
                    break;
                case 'moveout':
                    w2ui.sidebarL1.collapse('reports'); // close reports when jumping to a main view
                    w2ui.toplayout.load('main', '/html/formmvout.html');
                    w2ui.toplayout.hide('right',true);
                    break;
                case 'updatera':
                    w2ui.sidebarL1.collapse('reports'); // close reports when jumping to a main view
                    w2ui.toplayout.load('main', '/html/formraextend.html');
                    w2ui.toplayout.hide('right',true);
                    break;
                case 'dlnq':
                    w2ui.sidebarL1.collapse('reports'); // close reports when jumping to a main view
                    w2ui.toplayout.load('main', '/html/formdlnq.html');
                    w2ui.toplayout.hide('right',true);
                    break;
                case 'prepnotice':
                    w2ui.sidebarL1.collapse('reports'); // close reports when jumping to a main view
                    w2ui.toplayout.load('main', '/html/formprepnotice.html');
                    w2ui.toplayout.hide('right',true);
                    break;
                case 'close':
                    w2ui.sidebarL1.collapse('reports'); // close reports when jumping to a main view
                    w2ui.toplayout.load('main', '/html/formclose.html');
                    w2ui.toplayout.hide('right',true);
                    break;
                case 'adjust':
                    w2ui.sidebarL1.collapse('reports'); // close reports when jumping to a main view
                    w2ui.toplayout.load('main', '/html/formadjust.html');
                    w2ui.toplayout.hide('right',true);
                    break;
                case 'svcreq':
                    w2ui.sidebarL1.collapse('reports'); // close reports when jumping to a main view
                    w2ui.toplayout.load('main', '/html/formcsr.html');
                    w2ui.toplayout.hide('right',true);
                    break;
                case 'svcreqcmp':
                    w2ui.sidebarL1.collapse('reports'); // close reports when jumping to a main view
                    w2ui.toplayout.load('main', '/html/formcmplsr.html');
                    w2ui.toplayout.hide('right',true);
                    break;
                case 'housekpg':
                    w2ui.sidebarL1.collapse('reports'); // close reports when jumping to a main view
                    w2ui.toplayout.load('main', '/html/formhskp.html');
                    w2ui.toplayout.hide('right',true);
                    break;
                case 'prvmaint':
                    w2ui.sidebarL1.collapse('reports'); // close reports when jumping to a main view
                    w2ui.toplayout.load('main', '/html/formprvm.html');
                    w2ui.toplayout.hide('right',true);
                    break;
                case 'invntory':
                    w2ui.sidebarL1.collapse('reports'); // close reports when jumping to a main view
                    w2ui.toplayout.load('main', '/html/forminv.html');
                    w2ui.toplayout.hide('right',true);
                    break;
                case 'changeRT':
                    w2ui.sidebarL1.collapse('reports'); // close reports when jumping to a main view
                    w2ui.toplayout.load('main', '/html/formchgrt.html');
                    w2ui.toplayout.hide('right',true);
                    break;
                case 'permissions':
                    w2ui.sidebarL1.collapse('reports'); // close reports when jumping to a main view
                    w2ui.toplayout.load('main', '/html/formperm.html');
                    w2ui.toplayout.hide('right',true);
                    break;

                case 'RPTasmrpt':
                case 'RPTb':
                case 'RPTcoa':
                case 'RPTdelinq':
                case 'RPTdep':
                case 'RPTdpm':
                case 'RPTgsr':
                case 'RPTj':
                case 'RPTl':
                case 'RPTla':
                case 'RPTpeople':
                case 'RPTpmt':
                case 'RPTr':
                case 'RPTra':
                case 'RPTrat':
                case 'RPTrcbt':  // rentable count by type
                case 'RPTrcpt':
                case 'RPTrr':
                case 'RPTrt':
                case 'RPTsl':
                case 'RPTstatements':
                case 'RPTtb':
                    showReport(event.target);
                    app.lastReport = event.target;
                    break;
                case 'allocfunds':
                    w2ui.sidebarL1.collapse('reports'); // close reports when jumping to a main view
                    switchToGrid(event.target);
                    break;
                default:
                    console.log('unhandled event: ' + event.target);
            }
        }
    }));

    //------------------------------------------------------------------------
    //          reportslayout
    //------------------------------------------------------------------------
    $().w2layout({
        name: 'reportslayout',
        padding: 0,
        panels: [
            { type: 'top',size: 34, content: 'reports toolbar'},
            { type: 'left', size: 20, style: app.prefmt, hidden: false },
            { type: 'main',  size: 100, style: app.prefmt},
            { type: 'preview', size: 0, hidden: true, content: 'reports preview' },
            { type: 'right', size: 200, hidden: true, content: 'reports - detail' },
            { type: 'bottom', size: 20, hidden: true, content: 'reports - bottom' },
        ]
    });


    //------------------------------------------------------------------------
    //          reportstoolbar
    //------------------------------------------------------------------------
    var tmp = genDateRangeNavigator('date');
    tmp.push.apply(tmp, [
        { type: 'spacer',},
        { type: 'button', id: 'csvexport', icon: 'fa fa-table', tooltip: 'export to CSV' },
        { type: 'button', id: 'printreport', icon: 'fa fa-file-pdf-o', tooltip: 'export to PDF' },
        { type: 'break', id: 'break2' },
        { type: 'menu-radio', id: 'page_size', icon: 'fa fa-print',
            tooltip: 'exported PDF page size',
            text: function (item) {
            //var text = item.selected;
            var el   = this.get('page_size:' + item.selected);
            if (item.selected == "Custom") {
                popupPDFCustomDimensions();
            }
            return 'Page Size: ' + el.text;
            },
            selected: 'USLetter',
            items: [
                { id: 'USLetter', text: 'US Letter (8.5 x 11 in)'},
                { id: 'Legal', text: 'Legal (8.5 x 14 in)'},
                { id: 'Ledger', text: 'Ledger (11 x 17 in)'},
                { id: 'Custom', text: 'Custom'},
            ]
        },
        { type: 'menu-radio', id: 'orientation', icon: 'fa fa-clone',
            tooltip: 'exported PDF orientation',
            text: function (item) {
            //var text = item.selected;
            var el   = this.get('orientation:' + item.selected);
            var pageSize = w2ui.reportstoolbar.get('page_size').selected;
            if (pageSize != "Custom" && item.selected == "Portrait") {
                app.pdfPageWidth = app.pageSizes[pageSize].w;
                app.pdfPageHeight = app.pageSizes[pageSize].h;
            }
            else if (pageSize != "Custom" && item.selected == "LandScape") {
                app.pdfPageWidth = app.pageSizes[pageSize].h;
                app.pdfPageHeight = app.pageSizes[pageSize].w;
            }
            return 'Orientation: ' + el.text;
            },
            selected: 'LandScape',
            items: [
                { id: 'LandScape', text: 'LandScape'},
                { id: 'Portrait', text: 'Portrait'},
            ]
        },
    ]);

    w2ui.reportslayout.content('top', $().w2toolbar({
        name: 'reportstoolbar',
        items: tmp,
        onClick: function (event) {
            if (event.target == "page_size") {
                console.log("Page size selected");
            }
            else if (event.target == "orientation") {
                console.log("orientation selected");
            }
            else if (event.target == "csvexport") {
                exportReportCSV(app.lastReport);
            }
            else if (event.target == "printreport") {
                exportReportPDF(app.lastReport);
            }
            else{
                handleDateToolbarAction(event,'date');
                showReport(app.lastReport);
            }
            // TODO: prevent refresh, why toolbar needs to be refreshed when user just selects
            // paper size, orientation? That refresh must be prevented.
        },
        onRefresh: function (event) {
            if (event.target == 'monthfwd') {  // we do these tasks after monthfwd is refreshed so we know that the 2 date controls exist
                var x = document.getElementsByName("dateD1");
                x[0].value = app.D1;
                x = document.getElementsByName("dateD2");
                x[0].value = app.D2;
            }
        }
    }));

    // bind onchange event for date input control for reports
    $(document).on("keypress", "input[name=dateD1]", function(e) {
        // do not procedd further untill user press the Enter key
        if (e.which != 13) {
            return;
        }
        var xd1 = document.getElementsByName('dateD1')[0].value;
        var xd2 = document.getElementsByName('dateD2')[0].value;
        var d1 = dateFromString(xd1);
        var d2 = dateFromString(xd2);
        // check that it is valid or not
        if (isNaN(Date.parse(xd1))) {
            return;
        }
        // check that year is not behind 2000
        if (d1.getFullYear() < 2000) {
            return;
        }
        // check that from date does not have value greater then To date
        if (d1.getTime() >= d2.getTime()) {
            d1 = new Date(d2.getTime() - 24 * 60 * 60 * 1000); //one day back from To date
        }
        app.D1 = dateControlString(d1);
        showReport(app.lastReport, "dateD1");
    }).on("keypress", "input[name=dateD2]", function(e) {
        // do not procedd further untill user press the Enter key
        if (e.which != 13) {
            return;
        }
        var xd1 = document.getElementsByName('dateD1')[0].value;
        var xd2 = document.getElementsByName('dateD2')[0].value;
        var d1 = dateFromString(xd1);
        var d2 = dateFromString(xd2);
        // check that it is valid or not
        if (isNaN(Date.parse(xd2))) {
            return;
        }
        // check that year is not behind 2000
        if (d2.getFullYear() < 2000) {
            return;
        }
        // check that from date does not have value greater then To date
        if (d2.getTime() <= d1.getTime()) {
            d2 = new Date(d1.getTime() + 24 * 60 * 60 * 1000); //one day forward from From date
        }
        app.D2 = dateControlString(d2);
        showReport(app.lastReport, "dateD2");
    });

    //------------------------------------------------------------------------
    //          allocfundsGrid
    //------------------------------------------------------------------------
    $().w2grid({
        name: 'allocfundsGrid',
        url: '/v1/allocfunds',
        multiSelect: false,
        title: 'Unpaid assesments for ',
        show: {
            header: false,
            toolbar: true,
            footer: true,
            searches: true,
            lineNumbers: false,
            selectColumn: false,
            expandColumn: false
        },
        columns: [
            {field: 'recid', type: 'int', caption: 'recid', hidden: true, size: '40px', sortable: true},
            {field: 'Name', type: 'text', caption: 'Payor Name', size: '90%', sortable: true},
            {field: 'BID', type: 'int', caption: 'BID', hidden: true},
            {field: 'TCID', type: 'int', caption: 'TCID', hidden: true},
        ],
        onRefresh: function(event) {
            event.onComplete = function() {
                var sel_recid = this.last.sel_recid;
                if (app.activeGrid == this.name && sel_recid !== undefined && sel_recid !== null) {
                    if (app.new_form_rec) {
                        this.unselect(sel_recid);
                    }
                    else{
                        this.select(sel_recid);
                    }
                }
            };
        },
        onClick:  function(event) {
            event.onComplete = function() {
                app.new_form_rec = false;
                var rec = this.get(event.recid);

                app.TmpTCID = rec.TCID; // store here in case it is deselected by the time the Save function needs it
                getPayorFund(rec.BID, rec.TCID)
                .done(function(data) {
                    app.payor_fund = data.record.fund;  // store fund in app variable
                    w2ui.unpaidASMsGrid.load('/v1/unpaidasms/'+rec.BID+'/'+rec.TCID);   // load grid data

                    var top = _unAllocRcpts.layoutPanels.top(app.payor_fund, rec.Name/*, rec.TCID*/),
                        bottom = _unAllocRcpts.layoutPanels.bottom();

                    w2ui.allocfundsLayout.content('top', top);
                    w2ui.allocfundsLayout.content('main', w2ui.unpaidASMsGrid);
                    w2ui.allocfundsLayout.content('bottom', bottom);

                    w2ui.toplayout.show('right', true);
                    w2ui.toplayout.content('right', w2ui.allocfundsLayout);
                    w2ui.toplayout.sizeTo('right', 800);
                    w2ui.toplayout.render();
                })
                .fail(function(/*data*/) {
                    console.log('ERROR, unable to get payor fund for TCID', rec.TCID);
                });
            };
        },
    });

    //------------------------------------------------------------------------
    //          allocate fund layout
    //------------------------------------------------------------------------
    $().w2layout({
        name: 'allocfundsLayout',
        panels: [
            { type: "top", size: 140, style: 'border: 1px solid #cfcfcf; padding: 5px;', content: 'Allocate Fund Top Panel',
                toolbar: {
                    name: 'unallocfund_toolbar',
                    items: [
                        { id: 'btnNotes', type: 'button', icon: 'fa fa-sticky-note-o' },
                        { id: 'bt3', type: 'spacer' },
                        { id: 'btnClose', type: 'button', icon: 'fa fa-times' },
                    ],
                    onClick: function(event) {
                        switch(event.target) {
                            case 'btnClose':
                                w2ui.toplayout.hide('right',true);
                                w2ui.toplayout.render();
                                break;
                        }
                    }
                }
            },
            { type: "left", hidden: true },
            { type: "main", size: "90%", style: app.pstyle, content: 'Allocate Fund Main Panel' },
            { type: "right", hidden: true },
            { type: "bottom", size: 60, style: app.pstyle, content: 'Allocate Fund Bottom Panel' },
        ]
    });

    //------------------------------------------------------------------------------
    //   UNPAID ASSESSMENTS GRID
    //------------------------------------------------------------------------------

    $().w2grid({
        name: 'unpaidASMsGrid',
        header: 'Unpaid Assessments',
        show: {
            toolbar: false,
            header: true,
            toolbarReload   : false,
            toolbarColumns  : false,
            toolbarSearch   : false,
            toolbarAdd: false,
            toolbarDelete: false,
            toolbarInput: false,
            searchAll: false,
            toolbarSave: false,
            toolbarEdit: false,
            footer: false,
            searches: false,
            lineNumbers: false,
            selectColumn: false,
            expandColumn: false
        },
        columns: [
            { field: 'recid', type: 'int', caption: 'recid', size: '40px', hidden: true},
            { field: 'Date', render: 'date', caption: 'Assessment<br>Date', style: 'text-align: right', size: '80px' },
            { field: 'Assessment', caption: 'Assessment', size: '10%' },
            { field: 'Amount', render: 'money', caption: 'Assessment<br>Amount', size: '100px' },
            { field: 'AmountPaid', render: 'money', caption: 'Amount Paid', size: '100px' },
            { field: 'AmountOwed', render: 'money', caption: 'Amount Owed', size: '100px' },
            { field: 'ARID', hidden: true },
            { field: 'ASMID', hidden: true },
            { field: 'Dt', render: 'date', caption: 'Payment Date', size: '100px', style: 'text-align: right', editable: {type: 'date'}},
            { field: 'Allocate', render: 'money', caption: 'Allocate Amount', size: '110px', editable: {type: 'float'}},
        ],
        onRefresh: function(/*event*/) {
            unallocAmountRemaining();
            refreshUnallocAmtSummaries();
        },
        onLoad: function(event) {
            event.done(function () {
                if (w2ui.unpaidASMsGrid.summary.length === 0) {
                    w2ui.unpaidASMsGrid.add({recid: 's-1', Date: '', Assessment: '', Amount: 0, AmountPaid: 0, AmountOwed: 0, Allocate: 0, w2ui: {summary: true}});
                }
            });
        },
        onRender: function(event) {
            event.done(function() {
                refreshUnallocAmtSummaries();
                unallocAmountRemaining();
            });
        },
        onChange: function(event) {
            event.onComplete = function() {
                var tgrid = w2ui.unpaidASMsGrid;
                var c = w2ui[event.target].getChanges();
                var total_fund = parseFloat($("#total_fund_amount").attr("data-fund")).toFixed(2);
                for (var i = 0; i < c.length; i++) {
                    var rec_index = tgrid.get(c[i].recid, true);         // get record index in `records` array
                    if (c[i].Allocate > 0) {                             // Is an amount present?
                        var fundsAllocated = 0;
                        var fundsRemaining = 0;
                        for (var j=0; j < tgrid.records.length; j++) {   // how much has been allocated everywhere else?
                            if (rec_index != tgrid.records[j].recid) {
                                fundsAllocated += tgrid.records[j].Allocate;
                            }
                        }
                        fundsRemaining = total_fund - fundsAllocated;    // how much remains?
                        var owed = tgrid.records[rec_index].AmountOwed;  // here's how much is still owed
                        var amtToPay = c[i].Allocate;                    // start by paying what the user asked
                        if (amtToPay > fundsRemaining) {
                            amtToPay = fundsRemaining;                   // adjust if it's more than what is available
                        }
                        if (amtToPay > owed) {
                            amtToPay = owed;                             // adjust if it's more than what is owed
                        }
                        tgrid.records[rec_index].Allocate = amtToPay;
                    } else {                                             // if Allocated amount is not greater than zero
                        tgrid.records[rec_index].Allocate = 0;
                    }
                    tgrid.records[rec_index].w2ui = {};                  // clear w2ui object in record
                }
                tgrid.save();
                refreshUnallocAmtSummaries();
                unallocAmountRemaining();
            };
        }
    });

    //------------------------------------------------------------------------
    //          accountsGrid
    //------------------------------------------------------------------------
    $().w2grid({
        name: 'accountsGrid',
        url: '/v1/GLAccounts',
        multiSelect: false,
        show: {
            header: false,
            toolbar: true,
            footer: true,
            lineNumbers: false,
            selectColumn: false,
            expandColumn: false,
            toolbarAdd: true,
            searchAll: true,
            toolbarSearch: true,
            toolbarColumns: true,
            toolbarInput: true,
            toolbarReload: true,
        },
        columns: [
            {field: 'recid',    caption: 'recid',     size: '80px', sortable: false, hidden: true},
            {field: 'LID',      caption: 'LID',       size: '50px', sortable: false, hidden: true},
            {field: 'PLID',     caption: 'PLID',      size: '50px', sortable: false, hidden: true},
            {field: 'BID',      caption: 'BID',       size: '40px', sortable: false, hidden: true},
            {field: 'GLNumber', caption: 'GL Number', size: '100px', sortable: true},
            {field: 'Name',     caption: 'Name',      size: '450px', sortable: true},
            {field: 'Status',   caption: 'Status',    size: '90px', sortable: true,
                render: function (record/*, index, col_index*/) {
                    var html = '';
                    // app.account_stuff.status.forEach(function(item) {
                    //     if (item.id == w2ui.accountsGrid.getCellValue(index, col_index)) html = item.text;
                    // });
                    if (typeof record == "undefined") {
                        return;
                    }
                    for (var i=0; i < app.account_stuff.statusList.length; i++) {
                        if (record.Status == app.account_stuff.statusList[i].id) {
                            html = app.account_stuff.statusList[i].text;
                        }
                    }
                    return html;
                },
            },
            {field: 'AcctType', caption: 'AcctType', size: '150px', sortable: true},
        ],
        onRefresh: function(event) {
            event.onComplete = function() {
                var sel_recid = this.last.sel_recid;
                if (app.activeGrid == this.name && sel_recid !== undefined && sel_recid !== null) {
                    if (app.new_form_rec) {
                        this.unselect(sel_recid);
                    }
                    else{
                        this.select(sel_recid);
                    }
                }
            };
        },
        onClick: function(event) {
            event.onComplete = function() {
                app.new_form_rec = false;

                var rec = this.get(event.recid);

                // get latest gl accounts first
                getParentAccounts(rec.BID)
                .done(function(data) {
                    if (data.status != 'success') {
                        w2ui.accountForm.message(data.message);
                        w2ui.toplayout.content('right', w2ui.accountForm);
                        w2ui.toplayout.show('right', true);
                        w2ui.toplayout.sizeTo('right', 700);
                        return;
                    }
                    else {
                        setToForm('accountForm', '/v1/account/' + rec.BID + '/' + rec.LID, 400, true);
                    }
                })
                .fail(function(/*data*/) {
                    console.log("unable to get gl accounts list");
                    return;
                });
            };
        },
        onAdd: function (/*event*/) {
            app.new_form_rec = true;

            var x = getCurrentBusiness();
            var BID=parseInt(x.value);
            var BUD = getBUDfromBID(BID);

            getParentAccounts(BID)
           .done(function(data) {
                if (data.status != 'success') {
                    w2ui.accountForm.message(data.message);
                    w2ui.toplayout.content('right', w2ui.accountForm);
                    w2ui.toplayout.show('right', true);
                    w2ui.toplayout.sizeTo('right', 700);
                    return;
                } else {

                    var y = new Date();

                    var record = {
                        recid: 0,
                        LID: 0,
                        PLID: 0,
                        BID: BID,
                        BUD: BUD,
                        RAID: 0,
                        TCID: 0,
                        GLNumber: '',
                        Status: 2,
                        Type: 0,
                        Name: '',
                        AcctType: '',
                        RAAssociated: 0,
                        AllowPost: 1,
                        ManageToBudget: 0,
                        Description: '',
                        LastModTime: w2uiDateControlString(y),
                        LastModBy: 0,
                    };
                    w2ui.accountForm.record = record;
                    w2ui.accountForm.refresh();

                    setToForm('accountForm', '/v1/account/' + BID + '/0', 400);
                }
            })
            .fail( function() {
                console.log('unable to get GLAccounts');
                return;
             });
        },
    });

    //------------------------------------------------------------------------
    //          Account Form
    //------------------------------------------------------------------------
    $().w2form({
        name: 'accountForm',
        header: 'Account Detail',
        url: '/v1/account',
        style: 'border: 0px; background-color: transparent;display: block;',
        formURL: '/html/formacct.html',
        fields: [
            { field: "recid", required: false, type: 'int', html: { caption: "recid", page: 0, column: 0 } },
            { field: "LID", required: false, type: 'int', html: { caption: "LID", page: 0, column: 0 } },
            { field: 'PLID', type: 'list', required: false, options: { items: [], selected: {}, maxDropHeight: 200 } },
            { field: "BID", required: false, type: 'int', html: { caption: "BID", page: 0, column: 0 } },
            { field: "BUD", required: true, options: { items: app.businesses, maxDropHeight: 350 }, type: 'list', html: { caption: "BUD", page: 0, column: 0 } },
            { field: "RAID", required: false, type: 'int', html: { caption: "RAID", page: 0, column: 0 } },
            { field: "TCID", required: false, type: 'int', html: { caption: "TCID", page: 0, column: 0 } },
            { field: "GLNumber", required: true, type: 'text', html: { caption: "GLNumber", page: 0, column: 0 } },
            { field: "Status", required: true, type: 'list', options: { items: [], selected: {}, maxDropHeight: 350 }, html: { caption: "Status", page: 0, column: 0 } },
            { field: "Type", required: true, type: 'list', options: { items: [], selected: {}, maxDropHeight: 350 }, html: { caption: "Type", page: 0, column: 0 } },
            { field: "Name", required: true, type: 'text', html: { caption: "Name", page: 0, column: 0 } },
            { field: "AcctType", required: false, type: 'text', html: { caption: "QB Accountt Type", page: 0, column: 0 } },
            { field: "RAAssociated", required: true, type: 'list', options: { items: [], selected: {}, maxDropHeight: 350 }, html: { caption: "RAAssociated", page: 0, column: 0 } },
            { field: "AllowPost", required: true, type: 'list', options: { items: [], selected: {}, maxDropHeight: 350 }, html: { caption: "AllowPost", page: 0, column: 0 } },
            { field: "ManageToBudget", required: true, type: 'list', options: { items: [], selected: {}, maxDropHeight: 350 }, html: { caption: "Manage To Budget", page: 0, column: 0 } },
            { field: "Description", required: false, type: 'text', html: { caption: "Description", page: 0, column: 0 } },
            { field: "LastModTime", required: false, type: 'date', html: { caption: "LastModTime", page: 0, column: 0 } },
            { field: "LastModBy", required: false, type: 'int', html: { caption: "LastModBy", page: 0, column: 0 } },
        ],
        toolbar: {
            items: [
                { id: 'btnNotes', type: 'button', icon: 'fa fa-sticky-note-o' },
                { id: 'bt3', type: 'spacer' },
                { id: 'btnClose', type: 'button', icon: 'fa fa-times' },
            ],
            onClick: function(event) {
                switch(event.target) {
                    case 'btnClose':
                        w2ui.toplayout.hide('right',true);
                        w2ui.toplayout.render();
                        break;
                }
            }
        },
        onChange: function(event) {
            if (event.target === "BUD" && event.type === "change") {
                var BUD = event.value_new.id;
                var BID = getBIDfromBUD(BUD);
                var r = w2ui.accountForm.record;

                // update the BID in record
                r.BID = BID;
                r.PLID = 0;

                // change the choice of parent account list
                getParentAccounts(BID)
                .done(function(/*data*/) {
                    w2ui.accountForm.refresh();
                });
            }
        },
        onSubmit: function(target, data) {
            // modify form data for server request
            getFormSubmitData(data.postData.record);
        },
        actions: {
            save: function() {
                var tgrid = w2ui.accountsGrid;
                var sel = tgrid.getSelection();
                tgrid.unselect(sel);

                this.save({}, function (data) {
                    if (data.status == 'error') {
                        console.log('ERROR: '+ data.message);
                        return;
                    }
                    w2ui.toplayout.hide('right',true);
                    w2ui.toplayout.render();
                    tgrid.reload();
                });
            },
            delete: function() {

                var form = this;

                w2confirm(delete_confirm_options)
                .yes(function() {
                    var tgrid = w2ui.pmtsGrid;
                    var sel = tgrid.getSelection();
                    tgrid.unselect(sel);

                    var params = {cmd: 'delete', formname: form.name, LID: form.record.LID };
                    var dat = JSON.stringify(params);

                    // delete Depository request
                    $.post(form.url, dat)
                    .done(function(data) {
                        if (data.status != "success") {
                            return;
                        }

                        w2ui.toplayout.hide('right',true);
                        w2ui.toplayout.render();
                        tgrid.reload();
                    })
                    .fail(function(/*data*/){
                        console.log("Delete Payment failed.");
                    });
                })
                .no(function() {
                    return;
                });
            },
        },
        onRefresh: function(event) {
            event.onComplete = function() {
                var f = w2ui.accountForm;
                var r = f.record;
                var BUD = getBUDfromBID(r.BID);
                if (r.LID) {
                    f.header = 'Edit Account Detail' + ' (' + r.LID + ')';
                    isNewFormRecord(f.name, false);
                } else {
                    f.header = 'Edit Account Detail (new)';
                    isNewFormRecord(f.name, true);
                }

                $("#accountForm").find('input[name=AllowPost]').w2field('list', {
                    items: app.account_stuff.allowPostList,
                    selected: r.AllowPost,
                });

                // set RAAssociated
                $("#accountForm").find('input[name=RAAssociated]').w2field('list',{
                    items: app.account_stuff.RAAssociatedList,
                    selected: r.RAAssociated,
                });

                // set managetoBudget
                $("#accountForm").find('input[name=ManageToBudget]').w2field('list',{
                    items: app.manageToBudgetList,
                    selected: r.ManageToBudget,
                });

                // set Status
                $("#accountForm").find('input[name=Status]').w2field('list',{
                    items: app.account_stuff.statusList,
                    selected: r.Status,
                });

                // set Type
                $("#accountForm").find('input[name=Type]').w2field('list',{
                    items: app.account_stuff.typeList,
                    selected: r.Type,
                });

                // set Parent Account list
                var PLIDList = [{id: 0, text: ' -- No Parent LID -- '}];
                app.parent_accounts[BUD].forEach(function(item) {
                    if (item.id != r.LID) { // don't include itself in parent account choice -- drop list
                        PLIDList.push(item);
                    }
                });

                $("#accountForm").find('input[name=PLID]').w2field('list',{
                    items: PLIDList,
                    selected: r.PLID,
                });

                // set business
                $("#accountForm").find('input[name=BUD]').w2field('list',{
                    items: app.businesses,
                    selected: r.BUD,
                });

                // Reference: http://jsfiddle.net/vtoah4t5/7/
            };
        }
    });

    //------------------------------------------------------------------------
    //          transactantsGrid
    //------------------------------------------------------------------------
    $().w2grid({
        name: 'transactantsGrid',
        url: '/v1/transactants',
        multiSelect: false,
        show: {
            header: false,
            toolbar: true,
            footer: true,
            toolbarAdd: true,
            lineNumbers: false,
            selectColumn: false,
            expandColumn: false
        },
        columns: [
            {field: 'TCID',         caption: "TCID",          size: '50px',  sortable: true, style: 'text-align: right', hidden: false},
            {field: 'FirstName',    caption: "First Name",    size: '125px', sortable: true, hidden: false},
            {field: 'MiddleName',   caption: "Middle Name",   size: '20px',  sortable: true, hidden: true},
            {field: 'LastName',     caption: "Last Name",     size: '125px', sortable: true, hidden: false,
                render: function (record) {
                    var s = '';
                    if (record.IsCompany === 0) {
                        s += '<span style="color:#999;font-size:16px"><i class="fa fa-handshake-o" aria-hidden="true"></i></span>';
                    }
                    return s + ' ' + record.LastName;
                }
            },
            {field: 'CompanyName',  caption: "Company Name",  size: '125px', sortable: true, hidden: false,
                render: function (record) {
                    var s = '';
                    if (record.IsCompany > 0) {
                        s += '<span style="color:#999;font-size:16px"><i class="fa fa-handshake-o" aria-hidden="true"></i></span>';
                    }
                    return s + ' ' + record.CompanyName;
                }
            },
            {field: 'PrimaryEmail', caption: "Primary Email", size: '175px', sortable: true, hidden: false},
            {field: 'CellPhone',    caption: "Cell Phone",    size: '100px', sortable: true, hidden: false},
            {field: 'WorkPhone',    caption: "Work Phone",    size: '100px', sortable: true, hidden: false},
        ],
        onRefresh: function(event) {
            event.onComplete = function() {
                var sel_recid = this.last.sel_recid;
                if (app.activeGrid == this.name && sel_recid !== undefined && sel_recid !== null) {
                    if (app.new_form_rec) {
                        this.unselect(sel_recid);
                    }
                    else{
                        this.select(sel_recid);
                    }
                }
            };
        },
        onClick: function(event) {
            event.onComplete = function () {
                app.new_form_rec = false;
                var rec = this.get(event.recid);
                setToForm('transactantForm', '/v1/person/' + rec.BID + '/' + rec.TCID, 700, true);
             };
        },
        onAdd: function(/*event*/) {
            app.new_form_rec = true;

            // insert an empty record....
            var x = getCurrentBusiness();
            var BID=x.value;
            var BUD = getBUDfromBID(BID);
            var y = new Date();

            var record = {
                recid: 0,
                FirstName: "",
                LastName: "",
                MiddleName: "",
                PreferredName: "",
                PrimaryEmail: "",
                TCID: 0,
                BID: BUD,
                NLID: 0,
                CompanyName: "",
                IsCompany: 0,
                SecondaryEmail: "",
                WorkPhone: "",
                CellPhone: "",
                Address: "",
                Address2: "",
                City: "",
                State: "",
                PostalCode: "",
                Country: "",
                Website: "",
                LastModTime: w2uiDateControlString(y),
                LastModBy: 0,
                Points: 0,
                DateofBirth: "1/1/1900",
                EmergencyContactName: "",
                EmergencyContactAddress: "",
                EmergencyContactTelephone: "",
                EmergencyEmail: "",
                AlternateAddress: "",
                EligibleFutureUser: "yes",
                Industry: "",
                SourceSLSID: 0,
                CreditLimit: 0.00,
                TaxpayorID: "",
                AccountRep: 0,
                EligibleFuturePayor: "yes",
                EmployerName: "",
                EmployerStreetAddress: "",
                EmployerCity: "",
                EmployerState: "",
                EmployerPostalCode: "",
                EmployerEmail: "",
                EmployerPhone: "",
                Occupation: "",
                ApplicationFee: 0.00,
                DesiredUsageStartDate: "1/1/1900",
                RentableTypePreference: 0,
                FLAGS: 0,
                Approver: 0,
                DeclineReasonSLSID: 0,
                OtherPreferences: "",
                FollowUpDate: "1/1/1900",
                CSAgent: 0,
                OutcomeSLSID: 0,
                FloatingDeposit: 0.00,
                RAID: 0,
            };

            w2ui.transactantForm.record = record;
            w2ui.transactantForm.refresh();

            setToForm('transactantForm', '/v1/person/' + BID + '/0', 700);
        },
    });

    //------------------------------------------------------------------------
    //          transactantForm
    //------------------------------------------------------------------------
    $().w2form({
        name: 'transactantForm',
        style: 'border: 0px; background-color: transparent;',
        header: app.sTransactant + ' Detail',
        url: '/v1/person',
        formURL: '/html/formtc.html',
        fields: [
            { field: 'recid', type: 'int', required: false, html: { page: 0, column: 0 } },
            { field: 'FirstName', type: 'text', required: false, html: { page: 0, column: 0 } },
            { field: 'LastName', type: 'text', required: false, html: { page: 0, column: 0 } },
            { field: 'MiddleName', type: 'text', required: false, html: { page: 0, column: 0 } },
            { field: 'PreferredName', type: 'text', required: false, html: { page: 0, column: 0 } },
            { field: 'PrimaryEmail', type: 'email', required: false, html: { page: 0, column: 0 } },
            { field: 'TCID', type: 'int', required: false, html: { page: 0, column: 0 } },
            { field: 'BID', type: 'list', options: {items: app.businesses}, required: false, html: { page: 0, column: 0 } },
            { field: 'NLID', type: 'int', required: false, html: { page: 0, column: 0 } },
            { field: 'CompanyName', type: 'text', required: false, html: { page: 0, column: 0 } },
            { field: 'IsCompany', type: 'list', options: {items: app.companyOrPerson}, required: true, html: { page: 0, column: 0 } },
            { field: 'SecondaryEmail', type: 'email', required: false, html: { page: 0, column: 0 } },
            { field: 'WorkPhone', type: 'phone', required: false, html: { page: 0, column: 0 } },
            { field: 'CellPhone', type: 'phone', required: false, html: { page: 0, column: 0 } },
            { field: 'Address', type: 'text', required: false, html: { page: 0, column: 0 } },
            { field: 'Address2', type: 'text', required: false, html: { page: 0, column: 0 } },
            { field: 'City', type: 'text', required: false, html: { page: 0, column: 0 } },
            { field: 'State', type: 'list', options: {items: app.usStateAbbr}, required: false, html: { page: 0, column: 0 } },
            { field: 'PostalCode', type: 'text', required: false, html: { page: 0, column: 0 } },
            { field: 'Country', type: 'text', required: false, html: { page: 0, column: 0 } },
            { field: 'Website', type: 'text', required: false, html: { page: 0, column: 0 } },
            { field: 'LastModTime', type: 'text', required: false, html: { page: 0, column: 0 } },
            { field: 'LastModBy', type: 'int', required: false, html: { page: 0, column: 0 } },
            { field: 'Points', type: 'text', required: false, html: { page: 1, column: 0 } },
            { field: 'DateofBirth', type: 'date', required: false, html: { page: 1, column: 0 } },
            { field: 'EmergencyContactName', type: 'text', required: false, html: { page: 1, column: 0 } },
            { field: 'EmergencyContactAddress', type: 'text', required: false, html: { page: 1, column: 0 } },
            { field: 'EmergencyContactTelephone', type: 'text', required: false, html: { page: 1, column: 0 } },
            { field: 'EmergencyEmail', type: 'text', required: false, html: { page: 1, column: 0 } },
            { field: 'AlternateAddress', type: 'text', required: false, html: { page: 1, column: 0 } },
            { field: 'EligibleFutureUser', type: 'list', options: {items: app.yesNoList}, required: false, html: { page: 1, column: 0 } },
            { field: 'Industry', type: 'text', required: false, html: { page: 1, column: 0 } },
            { field: 'SourceSLSID', type: 'w2int', required: false, html: { page: 1, column: 0 } },
            { field: 'CreditLimit', type: 'money', required: false, html: {page: 2, column: 0 } },
            { field: 'TaxpayorID', type: 'text', required: false, html: {page: 2, column: 0 } },
            { field: 'AccountRep', type: 'text', required: false, html: {page: 2, column: 0 } },
            { field: 'EligibleFuturePayor', type: 'list', options: {items: app.yesNoList}, required: false, html: {page: 2, column: 0 } },
            { field: 'EmployerName', type: 'text', required: false, html: {page: 3, column: 0 } },
            { field: 'EmployerStreetAddress', type: 'text', required: false, html: {page: 3, column: 0 } },
            { field: 'EmployerCity', type: 'text', required: false, html: {page: 3, column: 0 } },
            { field: 'EmployerState', type: 'list', options: {items: app.usStateAbbr}, required: false, html: {page: 3, column: 0 } },
            { field: 'EmployerPostalCode', type: 'text', required: false, html: {page: 3, column: 0 } },
            { field: 'EmployerEmail', type: 'text', required: false, html: {page: 3, column: 0 } },
            { field: 'EmployerPhone', type: 'text', required: false, html: {page: 3, column: 0 } },
            { field: 'Occupation', type: 'text', required: false, html: {page: 3, column: 0 } },
            { field: 'ApplicationFee', type: 'text', required: false, html: {page: 3, column: 0 } },
            { field: 'DesiredUsageStartDate', type: 'date', required: false, html: {page: 3, column: 0 } },
            { field: 'RentableTypePreference', type: 'text', required: false, html: {page: 3, column: 0 } },
            { field: 'FLAGS', type: 'text', required: false, html: {page: 3, column: 0 } },
            { field: 'Approver', type: 'text', required: false, html: {page: 3, column: 0 } },
            { field: 'DeclineReasonSLSID', type: 'w2int', required: false, html: {page: 3, column: 0 } },
            { field: 'OtherPreferences', type: 'text', required: false, html: {page: 3, column: 0 } },
            { field: 'FollowUpDate', type: 'date', required: false, html: {page: 3, column: 0 } },
            { field: 'CSAgent', type: 'text', required: false, html: {page: 3, column: 0 } },
            { field: 'OutcomeSLSID', type: 'text', required: false, html: {page: 3, column: 0 } },
            { field: 'FloatingDeposit', type: 'w2float', required: false, html: {page: 3, column: 0 } },
            { field: 'RAID', type: 'w2int', required: false, html: {page: 3, column: 0 } },

        ],
        tabs: [
            { id: 'tab1', caption: app.sTransactant },
            { id: 'tab2', caption: app.sUser },
            { id: 'tab3', caption: app.sPayor },
            { id: 'tab4', caption: app.sProspect },
        ],
        toolbar: {
            items: [
                { id: 'btnNotes', type: 'button', icon: 'fa fa-sticky-note-o' },
                { id: 'bt3', type: 'spacer' },
                { id: 'btnClose', type: 'button', icon: 'fa fa-times' },
            ],
            onClick: function (event) {
                if (event.target == 'btnClose') {
                    w2ui.toplayout.hide('right',true);
                    w2ui.toplayout.render();
                }
                if (event.target == 'btnNotes')  {
                    notesPopUp();
                }
            },
        },
        onValidate: function (event) {
            if (this.record.IsCompany.text == 'Person' && this.record.FirstName === '') {
                event.errors.push({
                    field: this.get('FirstName'),
                    error: 'FirstName required when "Person or Company" field is set to Person'
                });
            }
            if (this.record.IsCompany.text == 'Person' && this.record.LastName === '') {
                event.errors.push({
                    field: this.get('LastName'),
                    error: 'LastName required when "Person or Company" field is set to Person'
                });
            }
            if (this.record.IsCompany.text == 'Company' && this.record.CompanyName === '') {
                event.errors.push({
                    field: this.get('CompanyName'),
                    error: 'Company Name required when "Person or Company" field is set to Company'
                });
            }
        },
        actions: {
            save: function () {
                var tgrid = w2ui.transactantsGrid;
                var sel = tgrid.getSelection();
                tgrid.unselect(sel);
                console.log('before: tgrid.getSelection() = ' + tgrid.getSelection() );
                this.save({}, function (data) {
                    if (data.status == 'error') {
                        console.log('ERROR: '+ data.message);
                        return;
                    }
                    w2ui.toplayout.hide('right',true);
                    tgrid.reload();
                });
            },
            delete: function(/*target, data*/) {
                var form = this;
                w2confirm(delete_confirm_options)
                .yes(function() {
                    var tgrid = w2ui.transactantsGrid;
                    var sel = tgrid.getSelection();
                    tgrid.unselect(sel);
                    var params = {cmd: 'delete', formname: form.name, TCID: form.record.TCID };
                    var dat = JSON.stringify(params);

                    // delete Transactant request
                    $.post(form.url, dat)
                    .done(function(data) {
                        if (data.status != "success") {
                            return;
                        }
                        w2ui.toplayout.hide('right',true);
                        w2ui.toplayout.render();
                        tgrid.reload();
                    })
                    .fail(function(/*data*/){
                        console.log("Delete Transactant failed.");
                    });
                })
                .no(function() {
                    return;
                });
            },
        },
        onRefresh: function() {
            var f = w2ui.transactantForm;
            var r = f.record;
            var title;
            if (r.TCID) {
                var name = r.FirstName + ' ' + r.LastName;
                title = 'Edit ' + app.sTransactant + ' - ' + name +' (' + r.TCID + ')';
                isNewFormRecord(f.name, false);
            } else {
                title = 'Edit '+app.sTransactant+' (new)';
                isNewFormRecord(f.name, true);
            }
            f.header = title;
        }
    });


    //------------------------------------------------------------------------
    //          notesPopUp
    //------------------------------------------------------------------------
    function notesPopUp() {
        w2popup.open({
            width   : 580,
            height  : 350,
            title   : 'Notes',
            body    : '<div class="w2ui-centered" style="line-height: 1.8">'+
                      '     This is a sample of what the Notes area.'+
                      '     <br>The focus will not leave popup. <br><br>'+
                      '     Add Note: <textarea name="comments" type="text" style="width: 385px; height: 80px"></textarea><br>'+
                       '</div>',
            buttons : '<button class="w2ui-btn" onclick="w2popup.close()">Ok</button>'+
                      '<button class="w2ui-btn" onclick="w2popup.close()">Cancel</button>'
        });
    }

    //------------------------------------------------------------------------
    //          rentable types Grid
    //------------------------------------------------------------------------
    $().w2grid({
        name: 'rtGrid',
        url: '/v1/rt',
        multiSelect: false,
        show: {
            header: false,
            toolbar: true,
            toolbarReload: false,
            toolbarColumns: false,
            toolbarSearch: true,
            toolbarAdd: true,
            toolbarDelete: false,
            toolbarSave: false,
            toolbarSearch   : true,
            searchAll       : true,
            footer: true,
            lineNumbers: false,
            selectColumn: false,
            expandColumn: false
        },
        columns: [
            {field: 'recid', caption: 'recid', hidden: true},
            {field: 'RTID', caption: 'RTID', size: '50px', sortable: true},
            {field: 'Name', caption: 'Name', size: '150px', sortable: true},
            {field: 'Style', caption: 'Style', size: '100px', sortable: true},
            {field: 'BID', caption: 'BID', hidden: true},
            {field: 'BUD', caption: 'BUD', hidden: true},
            {field: 'RentCycle', caption: 'RentCycle', size: '75px', sortable: true,
                render: function (record/*, index, col_index*/) {
                    var text = '';
                    if (record) {
                        app.cycleFreq.forEach(function(itemText, itemIndex) {
                            if (record.RentCycle == itemIndex) {
                                text = itemText;
                                return false;
                            }
                        });
                    }
                    return text;
                },
            },
            {field: 'Proration', caption: 'Proration', size: '90px', sortable: true,
                render: function (record/*, index, col_index*/) {
                    var text = '';
                    if (record) {
                        app.cycleFreq.forEach(function(itemText, itemIndex) {
                            if (record.Proration == itemIndex) {
                                text = itemText;
                                return false;
                            }
                        });
                    }
                    return text;
                },
            },
            {field: 'GSRPC', caption: 'GSRPC', size: '65px', sortable: true,
                render: function (record/*, index, col_index*/) {
                    var text = '';
                    if (record) {
                        app.cycleFreq.forEach(function(itemText, itemIndex) {
                            if (record.GSRPC == itemIndex) {
                                text = itemText;
                                return false;
                            }
                        });
                    }
                    return text;
                },
            },
            {field: 'ManageToBudget', caption: 'ManageToBudget', size: '200px', sortable: true,
                render: function (record/*, index, col_index*/) {
                    var text = '';
                    if (record) {
                        app.manageToBudgetList.forEach(function(item) {
                            if (record.ManageToBudget == item.id) {
                                text = item.text;
                                return false;
                            }
                        });
                    }
                    return text;
                },
            },
            {field: 'LastModTime', caption: 'LastModTime', hidden: true},
            {field: 'LastModBy', caption: 'LastModBy', hidden: true},
            {field: 'RMRID', caption: 'RMRID', hidden: true},
            {field: 'MarketRate', caption: 'MarketRate', size: '100px', sortable: true, render: 'money'},
        ],
        onRefresh: function(event) {
            event.onComplete = function() {
                var sel_recid = this.last.sel_recid;
                if (app.activeGrid == this.name && sel_recid !== undefined && sel_recid !== null) {
                    if (app.new_form_rec) {
                        this.unselect(sel_recid);
                    }
                    else{
                        this.select(sel_recid);
                    }
                }
            };
        },
        onClick: function(event) {
            event.onComplete = function () {
                app.new_form_rec = false;
                var rec = this.get(event.recid);
                console.log('rentableType form url: ' + '/v1/rt/' + rec.BID + '/' + rec.RTID);
                setToForm('rentableTypeForm', '/v1/rt/' + rec.BID + '/' + rec.RTID, 400, true);
            };
        },
        onAdd: function(/*event*/) {
            app.new_form_rec = true;

            var x = getCurrentBusiness();
            var BID=parseInt(x.value);
            var BUD = getBUDfromBID(BID);

            var y = new Date();

            var record = {
                recid: 0,
                BID: BID,
                BUD: BUD,
                RTID: 0,
                Style: "",
                Name: "",
                RentCycle: 0,
                Proration: 0,
                GSRPC: 0,
                ManageToBudget: 0,
                RMRID: 0,
                MarketRate: 0.0,
                LastModTime: y,
                LastModBy: 0,
            };

            w2ui.rentableTypeForm.record = record;
            w2ui.rentableTypeForm.refresh();

            setToForm('rentableTypeForm', '/v1/rt/' + BID + '/0', 400);
        },
    });

    //------------------------------------------------------------------------
    //          rentable Type Form
    //------------------------------------------------------------------------
    $().w2form({
        name: 'rentableTypeForm',
        style: 'border: 0px; background-color: transparent;',
        header: app.sRentableType + ' Detail',
        url: '/v1/rentabletypes',
        formURL: '/html/formrt.html',
        fields: [
            { field: 'recid', type: 'int', required: false, html: { page: 0, column: 0 } },
            { field: 'RTID', type: 'int', required: true, html: { page: 0, column: 0 } },
            { field: 'BID', type: 'int', required: true, html: { page: 0, column: 0 } },
            { field: 'BUD', type: 'list', options: {items: app.businesses}, required: true, html: { page: 0, column: 0 } },
            { field: 'Style', type: 'text', required: true, html: { page: 0, column: 0 } },
            { field: 'Name', type: 'text', required: true, html: { page: 0, column: 0 } },
            { field: 'RentCycle', type: 'list', options: {items: app.cycleFreq, selected: {}}, required: true, html: { page: 0, column: 0 } },
            { field: 'Proration', type: 'list', options: {items: app.cycleFreq, selected: {}}, required: true, html: { page: 0, column: 0 } },
            { field: 'GSRPC', type: 'list', options: {items: app.cycleFreq, selected: {}}, required: true, html: { page: 0, column: 0 } },
            { field: 'ManageToBudget', type: 'list', options: {items: app.manageToBudgetList, selected: {}}, required: true, html: { page: 0, column: 0 } },
            { field: 'RMRID', type: 'int', required: true, html: { page: 0, column: 0 } },
            { field: 'MarketRate', type: 'money', required: false, html: { page: 0, column: 0 } },
            { field: 'LastModTime', type: 'date', required: true, html: { page: 0, column: 0 } },
            { field: 'LastModBy', type: 'int', required: true, html: { page: 0, column: 0 } },
        ],
        toolbar: {
            items: [
                { id: 'btnNotes', type: 'button', icon: 'fa fa-sticky-note-o' },
                { id: 'bt3', type: 'spacer' },
                { id: 'btnClose', type: 'button', icon: 'fa fa-times' },
            ],
            onClick: function (event) {
                switch(event.target) {
                case 'btnClose':
                    w2ui.toplayout.hide('right',true);
                    w2ui.toplayout.render();
                    break;
                }
            },
        },
        onValidate: function(event) {
            if (this.record.ManageToBudget === 1 && this.record.MarketRate === "") {
                event.errors.push({
                    field: this.get('MarketRate'),
                    error: 'MarketRate cannot be blank when Mange To Budget is Yes'
                });
            }
            if (this.record.Style === "") {
                event.errors.push({
                    field: this.get('Style'),
                    error: 'Style cannot be blank'
                });
            }
            if (this.record.Name === "") {
                event.errors.push({
                    field: this.get('Name'),
                    error: 'Name cannot be blank'
                });
            }
        },
        actions: {
            save: function () {
                //var obj = this;
                var tgrid = w2ui.rtGrid;
                var sel = tgrid.getSelection();
                tgrid.unselect(sel);
                var errors = w2ui.rentableTypeForm.validate(true);
                if (errors.length > 1) {
                    return;
                }
                // have to ignore issue with LastModTime
                if (errors.length == 1 && errors[0].field.name != "LastModTime") {
                    return;
                }

                // this.save({}, function (data) {
                //     if (data.status == 'error') {
                //         console.log('ERROR: '+ data.message);
                //         return;
                //     }
                //     w2ui.toplayout.hide('right',true);
                //     tgrid.reload();
                // });
                var saveRecord = getFormSubmitData(this.record);
                var params = {cmd: 'save', formname: this.name, record: saveRecord };
                var dat = JSON.stringify(params);

                // save Depository request
                $.post(this.url, dat)
                .done(function(data) {
                    if (data.status != "success") {
                        return;
                    }
                    w2ui.toplayout.hide('right',true);
                    w2ui.toplayout.render();
                    tgrid.reload();
                })
                .fail(function(/*data*/){
                    console.log("Save RentableType failed.");
                });
            },
            delete: function() {

                var form = this;

                w2confirm(delete_confirm_options)
                .yes(function() {
                    var tgrid = w2ui.rtGrid;
                    var sel = tgrid.getSelection();
                    tgrid.unselect(sel);

                    var params = {cmd: 'delete', formname: form.name, ID: form.record.RTID };
                    var dat = JSON.stringify(params);

                    // delete Depository request
                    $.post(form.url, dat)
                    .done(function(data) {
                        if (data.status != "success") {
                            return;
                        }

                        w2ui.toplayout.hide('right',true);
                        w2ui.toplayout.render();
                        tgrid.reload();
                    })
                    .fail(function(/*data*/){
                        console.log("Delete Payment failed.");
                    });
                })
                .no(function() {
                    return;
                });
            },
        },
        onSubmit: function(target, data){
            // server request form data
            getFormSubmitData(data.postData.record);
        },
        onRefresh: function(event) {
            event.onComplete = function() {
                var f = w2ui.rentableTypeForm;
                var r = f.record;
                if (r.RTID) {
                    f.header = 'Edit ' + app.sRentableType + ' (' + r.RTID +')';
                    isNewFormRecord(f.name, false);
                } else {
                    f.header = 'Edit ' + app.sRentableType + ' (new)';
                    isNewFormRecord(f.name, true);
                }

                // assignmentTime selected and items for w2field
                var rentCycleSel = {}, prorationSel = {}, gsrpcSel = {}, manageToBudgetSel = {};

                // cycleFreqItems, manageToBudgetItems
                var cycleFreqItems = [];

                // select value for rentcycle, proration, gsrpc
                app.cycleFreq.forEach(function(itemText, itemIndex) {
                    if (itemIndex == r.RentCycle) {
                        rentCycleSel = { id: itemIndex, text: itemText };
                    }
                    if (itemIndex == r.Proration) {
                        prorationSel = { id: itemIndex, text: itemText };
                    }
                    if (itemIndex == r.GSRPC) {
                        gsrpcSel = { id: itemIndex, text: itemText };
                    }

                    cycleFreqItems.push({ id: itemIndex, text: itemText });
                });

                // select value for manage to budget
                app.manageToBudgetList.forEach(function(item) {
                    if (item.id == r.ManageToBudget) {
                        manageToBudgetSel = {id: item.id, text: item.text};
                    }
                });

                // fill the field with values
                $("#rentableTypeForm").find('input[name=RentCycle]').w2field('list', {
                    items: cycleFreqItems,
                    selected: rentCycleSel,
                });
                $("#rentableTypeForm").find('input[name=Proration]').w2field('list', {
                    items: cycleFreqItems,
                    selected: prorationSel,
                });
                $("#rentableTypeForm").find('input[name=GSRPC]').w2field('list', {
                    items: cycleFreqItems,
                    selected: gsrpcSel,
                });
                $("#rentableTypeForm").find('input[name=ManageToBudget]').w2field('list', {
                    items: app.manageToBudgetList,
                    selected: manageToBudgetSel,
                });
            };
        }
    });


    //------------------------------------------------------------------------
    //          rentablesGrid
    //------------------------------------------------------------------------
    $().w2grid({
        name: 'rentablesGrid',
        url: '/v1/rentable',
        multiSelect: false,
        show: {
            header: false,
            toolbar: true,
            toolbarAdd: true,
            searches: true,
            footer: true,
            lineNumbers: false,
            selectColumn: false,
            expandColumn: false
        },
        columns: [
            {field: 'recid', caption: 'recid', size: '50px', hidden: true, sortable: true},
            {field: 'RID', caption: 'RID', size: '50px', sortable: true},
            {field: 'RentableName', caption: 'Rentable Name', size: '150px', sortable: true},
            // {field: 'AssignmentTime', caption: 'Assignment Time', size: '120px', sortable: true},
            {field: 'RTID', caption: 'Rentable Type ID', hidden: true, sortable: true},
            {field: 'RentableType', caption: 'Rentable Type', size: '200px', sortable: true},
            {field: 'RentableStatus', caption: 'Rentable <br>Status', size: '100px', sortable: true},
            {field: 'RARID', caption: 'RARID', hidden: true, sortable: true},
            {field: 'RAID', caption: 'RAID', size: '70px', sortable: true},
            {field: 'RentalAgreementStart', caption: 'Rental Agreement <br>Start', size: '120px', sortable: true},
            {field: 'RentalAgreementStop', caption: 'Rental Agreement <br>Stop', size: '120px', sortable: true},
        ],
        onRefresh: function(event) {
            event.onComplete = function() {
                var sel_recid = this.last.sel_recid;
                if (app.activeGrid == this.name && sel_recid !== undefined && sel_recid !== null) {
                    if (app.new_form_rec) {
                        this.unselect(sel_recid);
                    }
                    else{
                        this.select(sel_recid);
                    }
                }
            };
        },
        onClick: function(event) {
            event.onComplete = function () {
                app.new_form_rec = false;

                var rec = this.get(event.recid);

                var BUD = getBUDfromBID(rec.BID);
                console.log('rentable form url: ' + '/v1/rentable/' + rec.BID + '/' + rec.RID);

                getRentableTypes(rec.BID)
                .done(function(/*data*/){
                    // set typedown list in rentableform - RentableType field
                    w2ui.rentableForm.get("RTID").options.items = app.rt_list[BUD];
                    w2ui.rentableForm.get("RTID").options.selected = {id: rec.RTID, text: rec.Name};

                    // must call refresh when form field has been set
                    w2ui.rentableForm.refresh();

                    setToForm('rentableForm', '/v1/rentable/' + rec.BID + '/' + rec.RID, 700, true);
                })
                .fail(function(){
                    console.log("Failed to get rentable type list");
                });
            };
        },
        onAdd: function(/*event*/) {
            app.new_form_rec = true;

            var x = getCurrentBusiness();
            var BID=parseInt(x.value);
            var BUD = getBUDfromBID(BID);

            var y = new Date();

            var record = {
                recid: 0,
                BID: BUD,
                RID: 0,
                RentableName: "",
                RARID: 0,
                RAID: 0,
                RARDtStart: w2uiDateControlString(y),
                RARDtStop: "1/1/9999",
                RTID: {id: 0, text: ''},
                RTRID: 0,
                RTRefDtStart: w2uiDateControlString(y),
                RTRefDtStop: "1/1/9999",
                RSID: 0,
                RentableStatus: "unknown",
                RSDtStart: w2uiDateControlString(y),
                RSDtStop: "1/1/9999",
                CurrentDate: y,
                AssignmentTime: 0,
            };

            getRentableTypes(BID)
            .done(function(/*data*/){

                // set typedown list in rentableform - RentableType field
                w2ui.rentableForm.get("RTID").options.items = app.rt_list[BUD];
                w2ui.rentableForm.get("RTID").options.selected = {};
                // must call refresh when form field has been set
                w2ui.rentableForm.refresh();
            })
            .fail(function(){
                console.log("Failed to get rentable type list");
            });

            w2ui.rentableForm.record = record;
            w2ui.rentableForm.refresh();

            setToForm('rentableForm', '/v1/rentable/' + BID + '/0', 700);
        },
    });

    //------------------------------------------------------------------------
    //          rentableForm
    //------------------------------------------------------------------------
    $().w2form({
        name: 'rentableForm',
        style: 'border: 0px; background-color: transparent;',
        header: app.sRentable + ' Detail',
        url: '/v1/rentable',
        formURL: '/html/formr.html',
        fields: [
            { field: 'recid', type: 'int', required: false, html: { page: 0, column: 0 } },
            { field: 'RID', type: 'int', required: false, html: { page: 0, column: 0 } },
            { field: 'BID', type: 'list', required: true, options: {items: app.businesses}, html: { page: 0, column: 0 } },
            { field: 'RARID', type: 'int', required: false, html: { page: 0, column: 0 } },
            { field: 'RAID', type: 'int', required: false, html: { page: 0, column: 0 } },
            { field: 'RARDtStart', type: 'date', required: false, html: { page: 0, column: 0 } },
            { field: 'RARDtStop', type: 'date', required: false, html: { page: 0, column: 0 } },
            { field: 'RentableName', type: 'text', required: true, html: { page: 0, column: 0 } },
            { field: 'RTID', type: 'list', required: true, html: { page: 0, column: 0 }, options: { items: [], selected: {}, maxDropHeight: 200 } },
            // { field: 'RTID', type: 'int', required: false },
            { field: 'RTRID', type: 'int', required: false, html: { page: 0, column: 0 } },
            { field: 'RTRefDtStart', type: 'date', required: true, html: { page: 0, column: 0 } },
            { field: 'RTRefDtStop', type: 'date', required: true, html: { page: 0, column: 0 } },
            { field: 'RSID', type: 'int', required: false, html: { page: 0, column: 0 } },
            { field: 'RentableStatus', type: 'list', options: {items: app.rentableStatusList}, required: true, html: { page: 0, column: 0 } },
            { field: 'RSDtStart', type: 'date', required: true, html: { page: 0, column: 0 } },
            { field: 'RSDtStop', type: 'date', required: true, html: { page: 0, column: 0 } },
            { field: 'CurrentDate', type: 'date', required: false },
            { field: 'AssignmentTime', type: 'list', required: false, html: { page: 0, column: 0 } },
        ],
        toolbar: {
            items: [
                { id: 'btnNotes', type: 'button', icon: 'fa fa-sticky-note-o' },
                { id: 'bt3', type: 'spacer' },
                { id: 'btnClose', type: 'button', icon: 'fa fa-times' },
            ],
            onClick: function (event) {
                switch(event.target) {
                case 'btnClose':
                    w2ui.toplayout.hide('right',true);
                    w2ui.toplayout.render();
                    break;
                }
            },
        },
        actions: {
            save: function () {
                //var obj = this;
                var tgrid = w2ui.rentablesGrid;
                var sel = tgrid.getSelection();
                tgrid.unselect(sel);
                this.save({}, function (data) {
                    if (data.status == 'error') {
                        console.log('ERROR: '+ data.message);
                        return;
                    }
                    w2ui.toplayout.hide('right',true);
                    tgrid.reload();
                });

            },
        },
        onSubmit: function(target, data){
            // server request form data
            delete data.postData.record.RARID;
            delete data.postData.record.RAID;
            delete data.postData.record.RARDtStop;
            delete data.postData.record.RARDtStart;
            getFormSubmitData(data.postData.record);
        },
        onRefresh: function(event) {
            event.onComplete = function() {
                var f = w2ui.rentableForm;
                var r = f.record;
                if (r.RID) {
                    f.header = 'Edit ' + app.sRentable + ' - ' + r.RentableName + ' (' + r.RID + ') as of '+r.CurrentDate;
                    isNewFormRecord(f.name, false);
                } else {
                    f.header = 'Edit ' + app.sRentable + ' (new) as of '+ r.CurrentDate;
                    isNewFormRecord(f.name, true);
                }

                // assignmentTime selected and items for w2field
                var assignmentItems = [], assignSelected = {};
                app.assignmentTimeList.forEach(function(item, index) {
                    if (index == r.AssignmentTime) {
                        assignSelected = { id: index, text: item };
                    }
                    assignmentItems.push({ id: index, text: item });
                });
                // fill the field with values
                $("#rentableForm").find('input[name=AssignmentTime]').w2field('list', {
                    items: assignmentItems,
                    selected: assignSelected,
                });
            };
        }
    });

    //------------------------------------------------------------------------
    //          rentalagrsGrid
    //------------------------------------------------------------------------
    $().w2grid({
        name: 'rentalagrsGrid',
        url: '/v1/rentalagrs',
        multiSelect: false,
        show: {
            toolbar: true,
            footer: true,
            lineNumbers: false,
            selectColumn: false,
            expandColumn: false,
            toolbarAdd: true,
            toolbarDelete: false,
            toolbarSave: false,
            toolbarEdit: false,
            toolbarSearch: true,
            toolbarInput: true,
            searchAll: true,
            toolbarReload: true,
            toolbarColumns: false,
        },
        multiSearch: true,
        searches: [
            { field: 'RAID', caption: 'RAID', type: 'text' },
            { field: 'Payors', caption: 'Payor(s)', type: 'text' },
            { field: 'AgreementStart', caption: 'Agreement Start Date', type: 'date' },
            { field: 'AgreementStop', caption: 'Agreement Stop Date', type: 'date' },
        ],
        columns: [
            {field: 'recid', hidden: true, caption: 'recid',  size: '40px', sortable: true},
            {field: 'BID', hidden: true, caption: 'BID',  size: '40px', sortable: false},
            {field: 'RAID', caption: 'RAID',  size: '50px', sortable: true},
            {field: 'Payors', caption: 'Payor(s)', size: '250px', sortable: true,
                // render: function (record, index, col_index) {
                //     if (record) {
                //         var icon;
                //         if (record.PayorIsCompany) {
                //             icon = 'fa-handshake-o'
                //         } else {
                //             icon = 'fa-user-o'
                //         }
                //         return '<i class="fa '+icon+'"></i>&nbsp;<span>'+record.Payors+'</span>';
                //     }
                // },
            },
            {field: 'AgreementStart', caption: 'Agreement<br>Start', render: 'date', size: '80px', sortable: true, style: 'text-align: right'},
            {field: 'AgreementStop', caption: 'Agreement<br>Stop',  render: 'date', size: '80px', sortable: true, style: 'text-align: right'},
            {field: 'PayorIsCompany', hidden: true, caption: 'IsCompany',  size: '40px', sortable: false},
        ],
        onRefresh: function(event) {
            event.onComplete = function() {
                var sel_recid = this.last.sel_recid;
                if (app.activeGrid == this.name && sel_recid !== undefined && sel_recid !== null) {
                    this.select(sel_recid);
                    // This one is special case, you need to set last sel_recid when you're adding
                    // new record with help of onAdd event handler, so new record automatically
                    // will be selected

                    // if (app.new_form_rec) {
                    //     this.unselect(sel_recid);
                    // }
                    // else{
                    //     this.select(sel_recid);
                    // }
                }
            };
        },
        onClick: function(event) {
            event.onComplete = function () {
                app.new_form_rec = false;
                var rec = this.get(event.recid);

                console.log( 'BID = ' + rec.BID + ',   RAID = ' + rec.RAID);
                var d = new Date();  // we'll use today for time-sensitive data
                setToRAForm(rec.BID, rec.RAID, d);
            };
        },
        onAdd: function (/*event*/) {
            app.new_form_rec = true;

            // this record will be added in grid, so set last sel_recid to this record
            // so it will be automatically highlighted
            var newRecId = this.records.length; // get length and assign recid to new record
            this.last.sel_recid = String(newRecId);

            // Insert an empty record...
            var x = getCurrentBusiness();
            var BID=x.value;
            var BUD = getBUDfromBID(BID);
            var y = new Date();
            var y1 = new Date(new Date().setFullYear(new Date().getFullYear() + 1));
            var y2 = new Date();
            y2.setDate(1); // set it to the first of the month
            var rec = {
                recid: newRecId,
                RAID: 0,
                RATID: 0,
                BID: {id: BID, text: BUD},
                NLID: 0,
                AgreementStart: w2uiDateControlString(y),
                AgreementStop: w2uiDateControlString(y1),
                PossessionStart: w2uiDateControlString(y),
                PossessionStop: w2uiDateControlString(y1),
                RentStart: w2uiDateControlString(y),
                RentStop: w2uiDateControlString(y1),
                RentCycleEpoch: w2uiDateControlString(y2),
                UnspecifiedAdults: 0,
                UnspecifiedChildren: 0,
                Renewal: {id:"month to month automatic renewal",text:"month to month automatic renewal"},
                SpecialProvisions: '',
                LastModTime: w2uiDateControlString(y),
                LastModBy: 0,
                LeaseType: 0,
                ExpenseAdjustmentType: 0,
                ExpensesStop: 0,
                ExpenseStopCalculation: '',
                BaseYearEnd: '1/1/1900',
                ExpenseAdjustment: '1/1/1900',
                EstimatedCharges: 0,
                RateChange: 0,
                NextRateChange: '1/1/1900',
                PermittedUses: '',
                ExclusiveUses: '',
                ExtensionOption: '',
                ExtensionOptionNotice: '1/1/1900',
                ExpansionOption: '',
                ExpansionOptionNotice: '1/1/1900',
                RightOfFirstRefusal: '',
            };

            var request={cmd:"save",recid:0,name:"rentalagrForm",record: rec};
            $.post('/v1/rentalagr/' + BUD + '/0', JSON.stringify(request))
            .done(function(data) {
                if (typeof data == 'string') {  // it's weird, a successful data add gets parsed as an object, an error message does not
                    var msg = JSON.parse(data);
                    w2ui.rentalagrsGrid.message(msg.message);
                    return;
                }
                if (data.status == 'success') {
                    rec.recid = data.recid; // success reply returns RAPID of record just added
                    rec.RAID = data.recid;
                    setToRAForm(BID, rec.RAID, y);
                } else {
                    w2ui.rentalagrsGrid.message(data.message);
                }
            });
        },
    });


    //------------------------------------------------------------------------
    //          Rental Agreement Details
    //------------------------------------------------------------------------
    $().w2layout({
        name: 'raLayout',
        padding: 0,
        panels: [
            { type: 'left', size: '40%', resizable: true, style: app.pstyle, content: 'top' },
            { type: 'top', size: 0, hidden: true },
            { type: 'main', size: '60%', resizable: true, style: app.pstyle, content: 'main' },
            { type: 'preview', size: 0, maxSize: 1, content: 'PREVIEW',  hidden: true },
            { type: 'bottom', size: 0, minSize: 0, maxSize: 1, hidden: true },
            { type: 'right', size: 0, minSize: 0, maxSize: 1, hidden: true }
        ]
    });
    $().w2layout({
        name: 'raLayoutSub1',
        padding: 1,
        panels: [
            { type: 'top', size: '30%', resizable: true, style: app.pstyle4, content: 'Rentables' },
            { type: 'left', size: 0, hidden: true },
            { type: 'main', size: '20%', resizable: true, style: app.pstyle4, content: 'Payors' },
            { type: 'preview', size: '60%', resizable: true, style: app.pstyle4, content: 'Users' },
            { type: 'right', size: 0, hidden: true },
            { type: 'bottom', size: '25%', resizable: true, style: app.pstyle4, content: 'Pets' }
        ]
    });

    //------------------------------------------------------------------------
    //          rentalagrForm
    //------------------------------------------------------------------------
    $().w2form({
        name: 'rentalagrForm',
        style: 'border: 0px; background-color: transparent;',
        header: app.sRentalAgreement + ' Detail',
        //url: '/v1/rentalagrs',
        formURL: '/html/formra.html',
        toolbar: {
            items: [
                { id: 'btnNotes', type: 'button', icon: 'fa fa-sticky-note-o' },
                { id: 'bt3', type: 'spacer' },
                { id: 'btnClose', type: 'button', icon: 'fa fa-times' },
            ],
            onClick: function (event) {
                switch(event.target) {
                case 'btnClose':
                    w2ui.toplayout.hide('right',true);
                    w2ui.toplayout.render();
                    break;
                }
            },
        },
        fields: [
            { field: 'recid', type: 'int', required: false, html: {page: 0, column: 0 } },
            { field: 'RAID', type: 'int', required: false, html: {  page: 0, column: 0 } },
            { field: 'RATID', type: 'int', required: false, html: { page: 0, column: 0 } },
            { field: 'BID', type: 'list', options: {items: app.businesses}, required: true, html: { page: 0, column: 0 } },
            { field: 'NLID', type: 'int', required: false, html: {page: 0, column: 0 } },
            { field: 'AgreementStart', type: 'date', required: true, html: { page: 0, column: 0 } },
            { field: 'AgreementStop', type: 'date', required: true, html: { page: 0, column: 0 } },
            { field: 'PossessionStart', type: 'date', required: true, html: { page: 0, column: 0 } },
            { field: 'PossessionStop', type: 'date', required: true, html: { page: 0, column: 0 } },
            { field: 'RentStart', type: 'date', required: true, html: { page: 0, column: 0 } },
            { field: 'RentStop', type: 'date', required: true, html: { page: 0, column: 0 } },
            { field: 'RentCycleEpoch', type: 'date', required: true, html: {  page: 0, column: 0 } },
            { field: 'UnspecifiedAdults', type: 'int', required: false, html: { page: 0, column: 0 } },
            { field: 'UnspecifiedChildren', type: 'int', required: false, html: { page: 0, column: 0 } },
            { field: 'Renewal', type: 'list', options: {items: app.renewalMap}, required: true, html: { page: 0, column: 0 } },
            { field: 'SpecialProvisions', type: 'text', required: false, html: { page: 0, column: 0 } },
            { field: 'LastModTime', type: 'text', required: false, html: { page: 0, column: 0 } },
            { field: 'LastModBy', type: 'int', required: false, html: { page: 0, column: 0 } },
            { field: 'LeaseType', type: 'w2int', required: false, html: {page: 1, column: 0}},
            { field: 'ExpenseAdjustmentType', type: 'w2int', required: false, html: {page: 1, column: 0}},
            { field: 'ExpensesStop', type: 'w2float', required: false, html: {page: 1, column: 0}},
            { field: 'ExpenseStopCalculation', type: 'text', required: false, html: {page: 1, column: 0}},
            { field: 'BaseYearEnd', type: 'date', required: false, html: {page: 1, column: 0}},
            { field: 'ExpenseAdjustment', type: 'date', required: false, html: {page: 1, column: 0}},
            { field: 'EstimatedCharges', type: 'w2float', required: false, html: {page: 1, column: 0}},
            { field: 'RateChange', type: 'w2float', required: false, html: {page: 1, column: 0}},
            { field: 'NextRateChange', type: 'date', required: false, html: {page: 1, column: 0}},
            { field: 'PermittedUses', type: 'text', required: false, html: {page: 1, column: 0}},
            { field: 'ExclusiveUses', type: 'text', required: false, html: {page: 1, column: 0}},
            { field: 'ExtensionOption', type: 'text', required: false, html: {page: 1, column: 0}},
            { field: 'ExtensionOptionNotice', type: 'date', required: false, html: {page: 1, column: 0}},
            { field: 'ExpansionOption', type: 'text', required: false, html: {page: 1, column: 0}},
            { field: 'ExpansionOptionNotice', type: 'date', required: false, html: {page: 1, column: 0}},
            { field: 'RightOfFirstRefusal', type: 'text', required: false, html: {page: 1, column: 0}},
        ],
        tabs: [
            { id: 'tab1', caption: app.sRAMainTab },
            { id: 'tab2', caption: app.sRACommercialTab },
        ],
        actions: {
            save: function () {
                var tgrid = w2ui.rentalagrsGrid;
                var sel = tgrid.getSelection();
                tgrid.unselect(sel);
                this.save({}, function (data) {
                    if (data.status == 'error') {
                        console.log('ERROR: '+ data.message);
                        return;
                    }
                    w2ui.toplayout.hide('right',true);
                    tgrid.reload();
                });
            },
            delete: function(/*target, data*/) {

                var form = this;

                w2confirm(delete_confirm_options)
                .yes(function() {

                    var tgrid = w2ui.rentalagrsGrid;
                    var sel = tgrid.getSelection();
                    tgrid.unselect(sel);

                    var params = {cmd: 'delete', formname: form.name, RAID: form.record.RAID };
                    var dat = JSON.stringify(params);

                    // delete RentalAgreement request
                    $.post(form.url, dat)
                    .done(function(data) {
                        if (data.status != "success") {
                            return;
                        }
                        w2ui.toplayout.hide('right',true);
                        w2ui.toplayout.render();
                        tgrid.reload();
                    })
                    .fail(function(/*data*/){
                        console.log("Delete RentalAgreement failed.");
                    });
                })
                .no(function() {
                    return;
                });
            },
        },
        onRefresh: function(/*event*/) {
            var f = w2ui.rentalagrForm;
            if (f.record.RAID) {
                f.header = "Edit" + app.sRentalAgreement + " (RA" + f.record.RAID + ")";
                isNewFormRecord(f.name, false);
            }
            else{
                f.header = "Edit" + app.sRentalAgreement + "(new)";
                isNewFormRecord(f.name, true);
            }
        },
        onValidate: function(event) {
            if (this.record.AgreementStart === '') {
                event.errors.push({
                    field: this.get('AgreementStart'),
                    error: 'Agreement Start date cannot be blank'
                });
            }
            if (this.record.AgreementStop === '') {
                event.errors.push({
                    field: this.get('AgreementStop'),
                    error: 'Agreement Stop date cannot be blank'
                });
            }
            if (this.record.PossessionStart === '') {
                event.errors.push({
                    field: this.get('PossessionStart'),
                    error: 'Possession Start date cannot be blank'
                });
            }
            if (this.record.PossessionStop === '') {
                event.errors.push({
                    field: this.get('PossessionStop'),
                    error: 'Possession Stop date cannot be blank'
                });
            }
            if (this.record.RentStart === '') {
                event.errors.push({
                    field: this.get('RentStart'),
                    error: 'Rent Start date cannot be blank'
                });
            }
            if (this.record.RentStop === '') {
                event.errors.push({
                    field: this.get('RentStop'),
                    error: 'Rent Stop date cannot be blank'
                });
            }
             if (this.record.RentCycleEpoch === '') {
                event.errors.push({
                    field: this.get('RentCycleEpoch'),
                    error: 'Rent Cycle Epoch date cannot be blank'
                });
            }
        },
    });

    //------------------------------------------------------------------------
    //          rarGrid
    //------------------------------------------------------------------------
    $().w2grid({
        name: 'rarGrid',
        show: {
            header: app.sRentable,
            toolbar: true,
            footer: false,
            lineNumbers: false,
            selectColumn: false,
            expandColumn: false,
            toolbarAdd: true,
            toolbarDelete: true,
            toolbarSave: true,
            toolbarEdit: false,
            toolbarSearch: false,
            toolbarInput: false,
            searchAll: false,
            toolbarReload: false,
            toolbarColumns: false,
        },
         url: '/v1/rar/',
        columns: [
            {field: 'recid', hidden: true, caption: 'recid',  size: '40px', sortable: true},
            {field: 'RAID', hidden: true, caption: 'RAID',  size: '40px', sortable: true},
            {field: 'RID', hidden: true, caption: app.sRentable,  size: '10%', sortable: true},
            {field: 'RentableName', caption: app.sRentable+' Name',  size: '10%', sortable: true},
            {field: 'ContractRent', caption: 'Rent', size: '10%', sortable: true, render: 'money', editable: { type: 'money' }},
            {field: 'RARDtStart', caption: 'Start', size: '10%', sortable: true, style: 'text-align: right', editable: { type: 'date' }},
            {field: 'RARDtStop', caption: 'Stop',  size: '10%', sortable: true, style: 'text-align: right', editable: { type: 'date' }},
        ],
        onAdd: function (/*event*/) {
            var x = getCurrentBusiness();
            popupRidRentablePicker(app.sRentable, x.value);
        },
        onChange: function(event) {
            var obj = this;
            event.done(function () {
                calcRarGridContractRent(obj);
                w2ui[event.target].save();
            });
        },
        onRender: function(event) {
            var obj = this;
            event.done(function() {
                calcRarGridContractRent(obj);
            });
        },
        onRefresh: function(/*event*/) {
            calcRarGridContractRent(this);
        },
        onLoad: function(event) {
                event.done(function () {
                    if (w2ui.rarGrid.summary.length === 0) {
                        w2ui.rarGrid.add({recid: 's-1', RAID: 0, RID: 0, RentableName: 'Total Rent', ContractRent: 0, RARDtStart: '', RARDtStop: '', w2ui: {summary: true}});
                    }
            });
        },
     });


    //------------------------------------------------------------------------
    //          rapGrid
    //------------------------------------------------------------------------
    $().w2grid({
        name: 'rapGrid',
        show: {
            header: app.sPayor,
            toolbar: true,
            footer: false,
            lineNumbers: false,
            selectColumn: false,
            expandColumn: false,
            toolbarAdd: true,
            toolbarDelete: true,
            toolbarSave: true,
            toolbarEdit: false,
            toolbarSearch: false,
            toolbarInput: false,
            searchAll: false,
            toolbarReload: false,
            toolbarColumns: false,
        },
        url: '/v1/rapayor',
        columns: [
            {field: 'recid', hidden: true, caption: 'recid',  size: '40px', sortable: true},
            {field: 'TCID', hidden: true, caption: 'TCID',  size: '40px', sortable: true},
            {field: 'FirstName', caption: 'First Name',  size: '10%', sortable: true},
            {field: 'MiddleName', caption: 'MI',  size: '30px', sortable: true},
            {field: 'LastName', caption: 'Last Name',  size: '10%', sortable: true},
            {field: 'IsCompany', caption: 'IsCompany', hidden: true, sortable: false },
            {field: 'CompanyName', caption: 'CompanyName',  size: '10%', sortable: true, style: 'text-align: left',
                render: function (record/*, index, col_index*/) {
                    var html = '';
                    if (record.IsCompany) {
                        html = record.CompanyName;
                    } else {
                        html = '';
                    }
                    return html;
                },
            },
            {field: 'DtStart', caption: 'Start', size: '10%', sortable: true, style: 'text-align: right', editable: { type: 'date' }},
            {field: 'DtStop', caption: 'Stop',  size: '10%', sortable: true, style: 'text-align: right', editable: { type: 'date' }},
        ],
        onAdd: function (/*event*/) {
            var x = getCurrentBusiness();
            popupTcidRAPayorPicker(app.sPayor, x.value );
        },
        onChange: function(event) {
            event.done(function () {
                w2ui[event.target].save();
            });
        },
        onSave: function() {
            console.log('save payors');
        },
        onDelete: function(/*event*/) {
            var sel = w2ui.rapGrid.getSelection(true); // get the record indeces rather than the recids
            w2ui.rapGrid.postData = {
                TCID: w2ui.rapGrid.records[sel[0]].TCID,
                DtStop: w2ui.rapGrid.records[sel[0]].DtStop
            };
        }
     });

    //------------------------------------------------------------------------
    //          rauGrid
    //------------------------------------------------------------------------
    $().w2grid({
        name: 'rauGrid',
        show: {
            header: app.sUser,
            toolbar: true,
            toolbarAdd: true,
            toolbarDelete: true,
            toolbarSave: true,
            footer: false,
            lineNumbers: false,
            selectColumn: false,
            expandColumn: false,
            toolbarEdit: false,
            toolbarSearch: false,
            toolbarInput: false,
            searchAll: false,
            toolbarReload: false,
            toolbarColumns: false,
        },
        url: '/v1/ruser',
        columns: [
            {field: 'recid', hidden: true, caption: 'recid',  size: '40px', sortable: true},
            {field: 'TCID', hidden: true, caption: 'TCID',  size: '40px', sortable: true},
            {field: 'RID', hidden: true, caption: 'RID',  size: '40px', sortable: true},
            {field: 'BID', hidden: true, caption: 'RID',  size: '40px', sortable: true},
            {field: 'RentableName', caption: app.sRentable,  size: '10%', sortable: true},
            {field: 'FirstName', caption: 'First Name',  size: '10%', sortable: true},
            {field: 'MiddleName', caption: 'MI',  size: '30px', sortable: true},
            {field: 'LastName', caption: 'Last Name',  size: '10%', sortable: true},
            {field: 'IsCompany', caption: 'IsCompany', hidden: true, sortable: false },
            {field: 'CompanyName', caption: 'CompanyName',  size: '10%', sortable: true, style: 'text-align: left',
                render: function (record/*, index, col_index*/) {
                    var html = '';
                    if (record.IsCompany) {
                        html = record.CompanyName;
                    } else {
                        html = '';
                    }
                    return html;
                },
            },
            {field: 'DtStart', caption: 'Start', size: '10%', sortable: true, style: 'text-align: right', editable: { type: 'date' }},
            {field: 'DtStop', caption: 'Stop',  size: '10%', sortable: true, style: 'text-align: right', editable: { type: 'date' }},
        ],
        onAdd: function (/*event*/) {
            var x = getCurrentBusiness();
            console.log('rentalagrForm.record.RAID = ' + w2ui.rentalagrForm.record.RAID);
            popupTcidRUserPicker(app.sUser, x.value, w2ui.rentalagrForm.record.RAID );
        },
        onChange: function(event) {
            event.done(function () {
                w2ui[event.target].save();
            });
        },
        onSave: function() {
            console.log('save users');
        },
        onDelete: function(/*event*/) {
            var sel = w2ui.rauGrid.getSelection(true); // get the record indeces rather than the recids
            var x = getCurrentBusiness();
            w2ui.rauGrid.postData = {
                TCID: w2ui.rauGrid.records[sel[0]].TCID,
            };
            w2ui.rauGrid.url = '/v1/ruser/' + x.value + '/' + w2ui.rauGrid.records[sel[0]].RID;
        }
     });

    //------------------------------------------------------------------------
    //          raPetGrid
    //------------------------------------------------------------------------
    $().w2grid({
        name: 'raPetGrid',
        show: {
            header: app.sUser,
            toolbar: true,
            footer: false,
            toolbarAdd: true,
            toolbarDelete: true,
            toolbarSave: true,
            toolbarEdit: false,
            toolbarSearch: false,
            toolbarInput: false,
            searchAll: false,
            toolbarReload: false,
            toolbarColumns: false,
        },
        url: '/v1/rapets',
        columns: [
            {field: 'recid', hidden: true, caption: 'recid',  size: '40px', sortable: true},
            {field: 'PETID', hidden: true, caption: 'PETID',  size: '40px', sortable: true},
            {field: 'Name',     caption: 'Name', size: '10%', sortable: true},
            {field: 'Type',     caption: 'Type', size: '10%', sortable: true},
            {field: 'Breed',    caption: 'Breed', size: '10%', sortable: true},
            {field: 'Color',    caption: 'Color', size: '10%', sortable: true},
            {field: 'Weight',   caption: 'Weight', size: '10%', sortable: true},
            {field: 'DtStart',  caption: 'DtStart', size: '10%', sortable: true, style: 'text-align: right'},
            {field: 'DtStop',   caption: 'DtStop', size: '10%', sortable: true, style: 'text-align: right'},
        ],
        onDelete: function(/*event*/) {
            var sel = w2ui.rPetGrid.getSelection(true); // get the record indeces rather than the recids
            w2ui.rPetGrid.postData = {
                PETID: w2ui.rPetGrid.records[sel[0]].PETID,
            };
        }

     });

    //------------------------------------------------------------------------
    //          receiptsGrid
    //------------------------------------------------------------------------
    $().w2grid({
        name: 'receiptsGrid',
        url: '/v1/receipts',
        multiSelect: false,
        postData: {searchDtStart: app.D1, searchDtStop: app.D2},
        show: {
            toolbar        : true,
            footer         : true,
            toolbarAdd     : true,   // indicates if toolbar add new button is visible
            toolbarDelete  : false,   // indicates if toolbar delete button is visible
            toolbarSave    : false,   // indicates if toolbar save button is visible
            selectColumn    : false,
            expandColumn    : false,
            toolbarEdit     : false,
            toolbarSearch   : false,
            toolbarInput    : true,
            searchAll       : true,
            toolbarReload   : true,
            toolbarColumns  : true,
        },
        columns: [
            {field: 'recid', hidden: true, caption: 'recid',  size: '40px', sortable: true},                                    // 0
            {field: 'RCPTID', caption: 'Receipt ID',  size: '80px', style: 'text-align: right', sortable: true},                // 1
            {field: 'Dt', caption: 'Date', size: '80px', sortable: true, style: 'text-align: right'},                           // 2
            {field: 'ARID', caption: 'ARID',  size: '150px', hidden: true, sortable: false}, // 3
            {field: 'AcctRule', caption: 'Account Rule',  size: '150px', sortable: true}, // 4
            {field: 'Amount', caption: 'Amount', size: '100px', sortable: true, render: 'money', style: 'text-align: right', searchable: true},   // 5
            {field: 'BID', hidden: true, caption: 'BUD', size: '40px', sortable: false},                                        // 6
            {field: 'TCID', hidden: true, caption: 'PMTID', size: '40px', sortable: false},                                     // 7
            {field: 'PMTID', caption: 'Payment Type', size: '100px', sortable: true, editable: {type: 'select', items: []},     // 8 - if this changes, update switchToGrid()
                    render: function (record, index, col_index) {
                        var html = '';
                        for (var p in app.paymentTypeList) {
                            if (app.paymentTypeList[p].id == this.getCellValue(index, col_index)) html = app.paymentTypeList[p].text;
                        }
                        return html;
                    },
            },
            {field: 'DocNo', caption: 'Document Number',  size: '150px', style: 'text-align: right', sortable: true, searchable: true},
            {field: 'Payor', caption: 'Payor', size: '150px', sortable: true, searchable: true},                                                  // 3
        ],
        // searches : [
        //     { field: 'Amount', caption: 'Amount', type: 'string' },
        //     { field: 'DocNo', caption: 'Document Number', type: 'string' },
        //     { field: 'Payor', caption: 'Payor', type: 'string' },
        // ],
        onClick: function(event) {
            event.onComplete = function () {
                app.new_form_rec = false;
                var rec = this.get(event.recid);

                var x = getCurrentBusiness();
                var Bid = x.value;
                var Bud = getBUDfromBID(Bid);
                $.get('/v1/uival/' + x.value + '/app.Receipts' )
                .done( function(data) {
                    if (typeof data == 'string') {  // it's weird, a successful data add gets parsed as an object, an error message does not
                        app.Receipts = JSON.parse(data);
                        w2ui.receiptForm.get('ARID').options.items = app.Receipts[Bud];
                        w2ui.receiptForm.refresh();
                        setToForm('receiptForm', '/v1/receipt/' + rec.BID + '/' + rec.RCPTID, 400, true);
                    }
                    if (data.status != 'success') {
                        w2ui.receiptForm.message(data.message);
                    }
                })
                .fail( function() {
                    console.log('Error getting /v1/uival/' + x.value + '/app.Receipts');
                 });
            };
        },
        onRequest: function(/*event*/) {
            w2ui.receiptsGrid.postData = {searchDtStart: app.D1, searchDtStop: app.D2};
        },
        onRefresh: function(event) {
            event.onComplete = function() {
                var sel_recid = this.last.sel_recid;
                if (app.activeGrid == this.name && sel_recid !== undefined && sel_recid !== null) {
                    if (app.new_form_rec) {
                        this.unselect(sel_recid);
                    }
                    else{
                        this.select(sel_recid);
                    }
                }

                if (event.target == 'monthfwd') {  // we do these tasks after monthfwd is refreshed so we know that the 2 date controls exist
                    setDateControlsInToolbar('receipts');
                    w2ui.receiptsGrid.postData = {searchDtStart: app.D1, searchDtStop: app.D2};
                }
            };
        },
        onAdd: function (/*event*/) {
            app.new_form_rec = true;

            // Insert an empty record...
            var x = getCurrentBusiness();
            var BID=x.value;
            var BUD = getBUDfromBID(BID);
            $.get('/v1/uival/' + x.value + '/app.Receipts' )
            .done( function(data) {
                if (typeof data == 'string') {  // it's weird, a successful data add gets parsed as an object, an error message does not
                    app.Receipts = JSON.parse(data);

                    var y = new Date();
                    var pmt_options = buildPaymentTypeOptions(BUD);
                    var ptInit = (pmt_options.length > 0) ? pmt_options[0] : '';
                    var record = {
                        recid: 0,
                        RCPTID: 0,
                        PRCPTID: 0,
                        ARID: 0,
                        BID: BUD,
                        PMTID: 0,
                        PmtTypeName: ptInit,
                        Dt: w2uiDateControlString(y),
                        DocNo: '',
                        Payor: '',
                        TCID: 0,
                        Amount: 0,
                        Comment: '',
                        OtherPayorName: '',
                    };
                    w2ui.receiptForm.fields[0].options.items = pmt_options;
                    w2ui.receiptForm.fields[1].options.items = app.Receipts[BUD];
                    w2ui.receiptForm.record = record;
                    w2ui.receiptForm.refresh();

                    setToForm('receiptForm', '/v1/receipt/' + BID + '/0', 400);
                }
                if (data.status != 'success') {
                    w2ui.receiptForm.message(data.message);
                }
            })
            .fail( function() {
                console.log('Error getting /v1/uival/'+BUD+'/app.Receipts');
             });
        },
    });

    //---------------------------------------------------------------------------------------
    //  Add a date range navigator to this view...
    //---------------------------------------------------------------------------------------
    w2ui.receiptsGrid.toolbar.add( genDateRangeNavigator('receipts') );
    w2ui.receiptsGrid.toolbar.on('click', function(event) {
        handleDateToolbarAction(event,'receipts'); // adjusts dates and loads into date controls
        w2ui.receiptsGrid.postData = {searchDtStart: app.D1, searchDtStop: app.D2};
        w2ui.receiptsGrid.load(w2ui.receiptsGrid.url);
    });
    w2ui.receiptsGrid.toolbar.on('refresh', function (/*event*/) {
        setDateControlsInToolbar('receipts');
        w2ui.receiptsGrid.postData = {searchDtStart: app.D1, searchDtStop: app.D2};
    });
    // bind onchange event for date input control for receipts
    $(document).on("keypress", "input[name=receiptsD1]", function(e) {
        // do not procedd further untill user press the Enter key
        if (e.which != 13) {
            return;
        }
        var xd1 = document.getElementsByName('receiptsD1')[0].value;
        var xd2 = document.getElementsByName('receiptsD2')[0].value;
        var d1 = dateFromString(xd1);
        var d2 = dateFromString(xd2);
        // check that it is valid or not
        if (isNaN(Date.parse(xd1))) {
            return;
        }
        // check that year is not behind 2000
        if (d1.getFullYear() < 2000) {
            return;
        }
        // check that from date does not have value greater then To date
        if (d1.getTime() >= d2.getTime()) {
            d1 = new Date(d2.getTime() - 24 * 60 * 60 * 1000); //one day back from To date
        }
        app.D1 = dateControlString(d1);
        w2ui.receiptsGrid.postData = {searchDtStart: app.D1, searchDtStop: app.D2};
        w2ui.receiptsGrid.load(w2ui.receiptsGrid.url, function() {
            document.getElementsByName('receiptsD1')[0].focus();
        });
    }).on("keypress", "input[name=receiptsD2]", function(e) {
        // do not procedd further untill user press the Enter key
        if (e.which != 13) {
            return;
        }
        var xd1 = document.getElementsByName('receiptsD1')[0].value;
        var xd2 = document.getElementsByName('receiptsD2')[0].value;
        var d1 = dateFromString(xd1);
        var d2 = dateFromString(xd2);
        // check that it is valid or not
        if (isNaN(Date.parse(xd2))) {
            return;
        }
        // check that year is not behind 2000
        if (d2.getFullYear() < 2000) {
            return;
        }
        // check that from date does not have value greater then To date
        if (d2.getTime() <= d1.getTime()) {
            d2 = new Date(d1.getTime() + 24 * 60 * 60 * 1000); //one day forward from From date
        }
        app.D2 = dateControlString(d2);
        w2ui.receiptsGrid.postData = {searchDtStart: app.D1, searchDtStop: app.D2};
        w2ui.receiptsGrid.load(w2ui.receiptsGrid.url, function() {
            document.getElementsByName('receiptsD2')[0].focus();
        });
    });

    //------------------------------------------------------------------------
    //          receiptForm
    //------------------------------------------------------------------------
    $().w2form({
        name: 'receiptForm',
        style: 'border: 0px; background-color: transparent;',
        header: app.sRentable + ' Detail',
        url: '/v1/receipt',
        formURL: '/html/formrcpt.html',
        fields: [
            { field: 'PmtTypeName',    type: 'list', required: true, options: {items: []},}, // keep this at position 0 as the list changes and we need to update it
            { field: 'ARID',           type: 'list',  required: true, options:  {items: app.Receipts} },  // 1
            { field: 'recid',          type: 'int',   required: false },                                     // 2
            { field: 'BID',            type: 'list',  required: true, options: {items: app.businesses}},     // 3
            { field: 'RCPTID',         type: 'int',   required: true },     // 4
            { field: 'PRCPTID',        type: 'int',   required: false },    // 5
            { field: 'PMTID',          type: 'int',   required: false },    // 6
            { field: 'Dt',             type: 'date',  required: true },     // 7
            { field: 'DocNo',          type: 'text',  required: false },    // 8
            { field: 'Payor', required: true,                               // 9   <<<<<<********
                type: 'enum',
                options: {
                    url:        '/v1/transactantstd/',
                    max:        1,
                    renderItem: tcidReceiptPayorPickerRender,
                    renderDrop: tcidPickerDropRender,
                    compare:    tcidPickerCompare,
                    onNew: function (event) {
                        //console.log('++ New Item: Do not forget to submit it to the server too', event);
                        $.extend(event.item, { FirstName: '', LastName : event.item.text });
                    }
                },
            },
            { field: 'TCID',           type: 'int64', required: false },
            { field: 'Amount',         type: 'money', required: true },
            { field: 'Comment',        type: 'text',  required: false },
            { field: 'OtherPayorName', type: 'text',  required: false },
        ],
        toolbar: {
            items: [
                { id: 'btnNotes', type: 'button', icon: 'fa fa-sticky-note-o' },
                { id: 'bt3', type: 'spacer' },
                { id: 'btnClose', type: 'button', icon: 'fa fa-times' },
            ],
            onClick: function (event) {
                switch(event.target) {
                case 'btnClose':
                    w2ui.toplayout.hide('right',true);
                    w2ui.toplayout.render();
                    break;
                }
            },
        },
        onRefresh: function(/*event*/) {
            var f = w2ui.receiptForm;
            var r = f.record;

            if (r.RCPTID) {
                f.header = "Edit" + app.sReceipt + " (" + r.RCPTID + ")";
                isNewFormRecord(f.name, false);
            }
            else {
                f.header = "Edit" + app.sReceipt + " (new)";
                isNewFormRecord(f.name, true);
            }

            var BUD = (typeof r.BID == "object") ? r.BID.id : r.BID;
            f.fields[0].options.items = buildPaymentTypeOptions( BUD );
            f.fields[1].options.items = app.Receipts[BUD];
            f.fields[9].options.url = '/v1/transactantstd/'+ BUD;
            r.PmtTypeName = getPaymentTypeName(BUD,r.PMTID);
        },
        onValidate: function (event) {
            if (this.record.Amount == 0.0) {
                event.errors.push({
                    field: this.get('Amount'),
                    error: 'Amount must be something other than $0.00'
                });
            }
        },
        onChange: function(event) {
            console.log('Form Value changed:  event = ', event);
            var r = w2ui.receiptForm.record;
            if (event.target == "PmtTypeName") {
                var PMTID = getPaymentTypeID(r.BID.id,event.value_new.id);
                if (PMTID >= 0) {
                    r.PMTID = PMTID;
                    console.log('record.PMTID set to ' + r.PMTID);
                }
            }
        },
        onLoad: function(event) {
            event.onComplete = function () {
                var r = w2ui.receiptForm.record;
                r.PmtTypeName = getPaymentTypeName(r.BID,r.PMTID); // we have the PMTID, set the name
             };
        },
        actions: {
            saveadd: function() {
                var x = getCurrentBusiness();
                var BID=x.value;
                var BUD = getBUDfromBID(BID);

                // first save the record
                w2ui.receiptForm.url = '/v1/receipt/' + w2ui.receiptForm.record.BID.text + '/0';
                var grid = w2ui.receiptsGrid;
                var sel = grid.getSelection();
                grid.unselect(sel);

                var params = {cmd: 'save', formname: this.name, record: this.record };
                var dat = JSON.stringify(params);

                // save Depository request
                $.post(this.url, dat)
                .done(function(data) {
                    if (data.status != "success") {
                        return;
                    }
                })
                .fail(function(/*data*/){
                    console.log("Save Receipt failed.");
                });

                // get length of records from receipt grid and add new records to it
                // only if receipts date falls in date range selection of grid
                var recDate = dateFromString(this.record.Dt);
                var xd1 = document.getElementsByName('receiptsD1')[0].value;
                var xd2 = document.getElementsByName('receiptsD2')[0].value;
                var d1 = dateFromString(xd1);
                var d2 = dateFromString(xd2);
                if (d1.getTime() <= recDate.getTime() && recDate.getTime() < d2.getTime()) {
                    // var recLen = w2ui.receiptsGrid.records.length;
                    var newRec = this.record;
                    w2ui.receiptsGrid.add(newRec);
                    w2ui.receiptsGrid.render(); // redraw grid
                }

                // clear the form
                this.clear();

                // add new empty record
                var y = new Date();
                var pmt_options = buildPaymentTypeOptions(BUD);
                var ptInit = (pmt_options.length > 0) ? pmt_options[0] : '';
                var record = {
                    recid: 0,
                    RCPTID: 0,
                    PRCPTID: 0,
                    ARID: 0,
                    BID: BUD,
                    PMTID: 0,
                    PmtTypeName: ptInit,
                    Dt: w2uiDateControlString(y),
                    DocNo: '',
                    Payor: '',
                    TCID: 0,
                    Amount: 0,
                    Comment: '',
                    OtherPayorName: '',
                };
                this.fields[0].options.items = pmt_options;
                this.fields[1].options.items = app.Receipts[BUD];
                this.record = record;
                this.refresh();
            },
            save: function () {
                //var obj = this;
                w2ui.receiptForm.url = '/v1/receipt/' + w2ui.receiptForm.record.BID.text + '/0';
                var grid = w2ui.receiptsGrid;
                var sel = grid.getSelection();
                grid.unselect(sel);
                this.save({}, function (data) {
                    if (data.status == 'error') {
                        console.log('ERROR: '+ data.message);
                        return;
                    }
                    w2ui.toplayout.hide('right',true);
                    grid.reload();
                });
            },
            delete: function() {

                var form = this;

                w2confirm(delete_confirm_options)
                .yes(function() {
                    var tgrid = w2ui.receiptsGrid;
                    var sel = tgrid.getSelection();
                    tgrid.unselect(sel);

                    var params = {cmd: 'delete', formname: form.name, RCPTID: form.record.RCPTID };
                    var dat = JSON.stringify(params);

                    // delete Depository request
                    $.post(form.url, dat)
                    .done(function(data) {
                        if (data.status != "success") {
                            return;
                        }
                        w2ui.toplayout.hide('right',true);
                        w2ui.toplayout.render();
                        tgrid.reload();
                    })
                    .fail(function(/*data*/){
                        console.log("Delete Receipt failed.");
                    });
                })
                .no(function() {
                    return;
                });
            },
        },
   });


    //------------------------------------------------------------------------
    //          asmsGrid
    //------------------------------------------------------------------------
    $().w2grid({
        name: 'asmsGrid',
        url: '/v1/asms',
        multiSelect: false,
        show: {
            toolbar        : true,
            footer         : true,
            toolbarAdd     : true,   // indicates if toolbar add new button is visible
            toolbarDelete  : false,   // indicates if toolbar delete button is visible
            toolbarSave    : false,   // indicates if toolbar save button is visible
            selectColumn    : false,
            expandColumn    : false,
            toolbarEdit     : false,
            toolbarSearch   : false,
            toolbarInput    : true,
            searchAll       : false,
            toolbarReload   : true,
            toolbarColumns  : true,
        },
        columns: [
            {field: 'recid', hidden: true, caption: 'recid',  size: '40px', sortable: true},
            {field: 'epoch', size: '10px', style: 'text-align: center', sortable: true,
                    render: function (record /*, index, col_index*/) {
                        if (record.RentCycle !== 0 && record.PASMID === 0) {
                            return '<i class="fa fa-refresh" aria-hidden="true"></i>';
                        }
                        return '';
                    },
            },
            {field: 'ASMID', caption: 'ASMID',  size: '60px', style: 'text-align: right', sortable: true},
            {field: 'Invoice', caption: 'Invoice', size: '80px', sortable: true, style: 'text-align: right'},
            {field: 'ARID', caption: 'ARID',  hidden: true, sortable: false},
            {field: 'Start', caption: 'Date', size: '80px', sortable: true, style: 'text-align: right'},
            {field: 'Stop', caption: 'Date', size: '80px', sortable: true, style: 'text-align: right'},
            {field: 'RentCycle', caption: 'RentCycle',  hidden: true, sortable: false},
            {field: 'AcctRule', caption: 'Account Rule',  size: '200px', style: 'text-align: left', sortable: true},
            {field: 'Amount', caption: 'Amount', size: '100px', sortable: true, render: 'money', style: 'text-align: right'},
            {field: 'BID', hidden: true, caption: 'BUD', size: '40px', sortable: false},
            {field: 'PASMID', hidden: true, caption: 'PMTID', size: '40px', sortable: false},
            {field: 'RAID', caption: app.sRentalAgreement,  size: '125px', style: 'text-align: right', sortable: true},
            {field: 'RID', caption: 'RID',  size: '40px', hidden: true, sortable: false},
            {field: 'Rentable', caption: app.sRentable,  size: '150px', style: 'text-align: right', sortable: true},
            // {field: 'ATypeLID', caption: 'Type', size: '100px', sortable: true, style: 'text-align: right'},
            // {field: 'RentCycle', caption: app.sRentCycle,  size: '60px', style: 'text-align: right', sortable: true},
            // {field: 'ProrationCycle', caption: sProrationCycle,  size: '60px', style: 'text-align: right', sortable: true},
        ],
        searches : [
            { field: 'Amount', caption: 'Amount', type: 'string' },
            // { field: 'Invoice', caption: 'Invoice Number', type: 'string' },
        ],
        onClick: function(event) {
            event.onComplete = function () {
                app.new_form_rec = false;
                var rec = this.get(event.recid);

                var form = (rec.RentCycle !== 0 && rec.PASMID === 0) ? "asmEpochForm" : "asmInstForm";
                var myurl = '/v1/asm/' + rec.BID + '/' + rec.ASMID;
                console.log( 'calling setToForm( '+form+', ' + myurl + ')');

                // before setting to the form, get the list of AcctRules...
                var x = getCurrentBusiness();
                var Bid = x.value;
                var Bud = getBUDfromBID(Bid);
                $.get('/v1/uival/' + x.value + '/app.Assessments' )
                .done( function(data) {
                    if (typeof data == 'string') {  // it's weird, a successful data add gets parsed as an object, an error message does not
                        app.Assessments = JSON.parse(data);
                        w2ui[form].get('ARID').options.items = app.Assessments[Bud];
                        w2ui[form].refresh();

                        setToForm(form, myurl, 400, true);
                    }
                    if (data.status != 'success') {
                        w2ui.asmsGrid.message(data.message);
                    }
                })
                .fail( function() {
                    console.log('Error getting /v1/uival/' + x.value + '/app.Assessments');
                 });
            };
        },
        onAdd: function (/*event*/) {
            app.new_form_rec = true;

            var x = getCurrentBusiness();
            $.get('/v1/uival/' + x.value + '/app.Assessments' )
            .done( function(data) {
                if (typeof data == 'string') {  // it's weird, a successful data add gets parsed as an object, an error message does not
                    app.Assessments = JSON.parse(data);

                    // Insert an empty record...
                    var BID=x.value;
                    var BUD = getBUDfromBID(BID);
                    app.ridRentablePicker.BID = BID; // needed by typedown

                    var y = new Date();
                    var y1 = new Date(new Date().setFullYear(new Date().getFullYear() + 1));
                        var record = {
                        ARID: 0,
                        recid: 0,
                        RID: 0,
                        ASMID: 0,
                        PASMID: 0,
                        ATypeLID: 0,
                        InvoiceNo: 0,
                        RAID: 0,
                        BID: BUD,
                        Start: w2uiDateControlString(y),
                        Stop: w2uiDateControlString(y1),
                        RentCycle: 'Monthly',
                        ProrationCycle: 'Daily',
                        TCID: 0,
                        Amount: 0,
                        AcctRule: '',
                        Comment: '',
                        LastModTime: w2uiDateControlString(y),
                        LastModBy: 0,
                    };
                    // w2ui.asmEpochForm.fields[5].options.url = '/v1/rentablestd/' + app.ridRentablePicker.BID;
                    w2ui.asmEpochForm.fields[0].options.items = app.Assessments[BUD];
                    w2ui.asmEpochForm.record = record;
                    w2ui.asmEpochForm.refresh();

                    setToForm('asmEpochForm', '/v1/asm/' + BID + '/0', 400);
                }
                if (data.status != 'success') {
                    w2ui.asmEpochForm.message(data.message);
                }
            })
            .fail( function() {
                console.log('Error getting /v1/uival/'+x.value+'/app.Assessments');
             });
        },
        onRequest: function(/*event*/) {
            w2ui.asmsGrid.postData = {searchDtStart: app.D1, searchDtStop: app.D2};
        },
        onRefresh: function(event) {
            event.onComplete = function() {
                var sel_recid = this.last.sel_recid;
                if (app.activeGrid == this.name && sel_recid !== undefined && sel_recid !== null) {
                    if (app.new_form_rec) {
                        this.unselect(sel_recid);
                    }
                    else{
                        this.select(sel_recid);
                    }
                }

                if (event.target == 'monthfwd') {  // we do these tasks after monthfwd is refreshed so we know that the 2 date controls exist
                    setDateControlsInToolbar('asms');
                    w2ui.asmsGrid.postData = {searchDtStart: app.D1, searchDtStop: app.D2};
                }
            };
        }
    });

    w2ui.asmsGrid.toolbar.add( genDateRangeNavigator('asms') );
    w2ui.asmsGrid.toolbar.on('click', function(event) {
        handleDateToolbarAction(event,'asms'); // adjusts dates and loads into date controls
        w2ui.asmsGrid.postData = {searchDtStart: app.D1, searchDtStop: app.D2};
        w2ui.asmsGrid.load(w2ui.asmsGrid.url);
    });
    w2ui.asmsGrid.toolbar.on('refresh', function (/*event*/) {
        setDateControlsInToolbar('asms');
        w2ui.asmsGrid.postData = {searchDtStart: app.D1, searchDtStop: app.D2};
    });
    // bind onchange event for date input control for assessments
    $(document).on("keypress", "input[name=asmsD1]", function(e) {
        // do not procedd further untill user press the Enter key
        if (e.which != 13) {
            return;
        }
        var xd1 = document.getElementsByName('asmsD1')[0].value;
        var xd2 = document.getElementsByName('asmsD2')[0].value;
        var d1 = dateFromString(xd1);
        var d2 = dateFromString(xd2);
        // check that it is valid or not
        if (isNaN(Date.parse(xd1))) {
            return;
        }
        // check that year is not behind 2000
        if (d1.getFullYear() < 2000) {
            return;
        }
        // check that from date does not have value greater then To date
        if (d1.getTime() >= d2.getTime()) {
            d1 = new Date(d2.getTime() - 24 * 60 * 60 * 1000); //one day back from To date
        }
        app.D1 = dateControlString(d1);
        w2ui.asmsGrid.postData = {searchDtStart: app.D1, searchDtStop: app.D2};
        w2ui.asmsGrid.load(w2ui.asmsGrid.url, function() {
            document.getElementsByName('asmsD1')[0].focus();
        });
    }).on("keypress", "input[name=asmsD2]", function(e) {
        // do not procedd further untill user press the Enter key
        if (e.which != 13) {
            return;
        }
        var xd1 = document.getElementsByName('asmsD1')[0].value;
        var xd2 = document.getElementsByName('asmsD2')[0].value;
        var d1 = dateFromString(xd1);
        var d2 = dateFromString(xd2);
        // check that it is valid or not
        if (isNaN(Date.parse(xd2))) {
            return;
        }
        // check that year is not behind 2000
        if (d2.getFullYear() < 2000) {
            return;
        }
        // check that from date does not have value greater then To date
        if (d2.getTime() <= d1.getTime()) {
            d2 = new Date(d1.getTime() + 24 * 60 * 60 * 1000); //one day forward from From date
        }
        app.D2 = dateControlString(d2);
        w2ui.asmsGrid.postData = {searchDtStart: app.D1, searchDtStop: app.D2};
        w2ui.asmsGrid.load(w2ui.asmsGrid.url, function() {
            document.getElementsByName('asmsD2')[0].focus();
        });
    });


    //---------------------------------------------------------------------------------
    //          asmEpochForm  -  assessment epoch - this is for recurring assessments
    //---------------------------------------------------------------------------------
    $().w2form({
        name: 'asmEpochForm',
        style: 'border: 0px; background-color: transparent;',
        header: app.sAssessment + ' Detail',
        url: '/v1/asm',
        formURL: '/html/formasmepoch.html',
        fields: [
            { field: 'ARID',          type: 'list',   required: true, options: { items: app.Assessments }},
            { field: 'recid',         type: 'int',    required: false },
            { field: 'ASMID',         type: 'int',    required: false },
            { field: 'BID',           type: 'list',   options:  {items: app.businesses}, required: true },
            { field: 'PASMID',        type: 'w2int',  required: false },
            // { field: 'Rentable', required: false,  /* INDEX 5 -- if changed, then change URL for Typedown in asmsGrid onAdd handler */
            //     type: 'enum',
            //     options: {
            //         url:        '/v1/rentablestd/' + app.ridRentablePicker.BID,
            //         max:        1,
            //         cacheMax:   50,
            //         renderItem: asmFormRentablePickerRender,
            //         renderDrop: ridRentableDropRender,
            //         compare:    ridRentableCompare,
            //         onNew: function (event) {
            //             //console.log('++ New Item: Do not forget to submit it to the server too', event);
            //             $.extend(event.item, { Rentable : event.item.text });
            //         }
            //     },
            // },
            { field: 'Rentable',      type: 'text',   required: false },
            { field: 'InvoiceNo',     type: 'int',    required: false },
            { field: 'RID',           type: 'int',    required: false },
            { field: 'ATypeLID',      type: 'int',    required: false },
            { field: 'RAID',          type: 'int',    required: true },
            { field: 'Amount',        type: 'money',  required: true },
            { field: 'Start',         type: 'date',   required: true },
            { field: 'Stop',          type: 'date',   required: true },
            { field: 'RentCycle',     type: 'list',   options:  {items: app.cycleFreq}, required: true },
            { field: 'ProrationCycle',type: 'list',   options:  {items: app.cycleFreq}, required: true },
            { field: 'Comment',       type: 'text',   required: false },
            { field: 'LastModTime',   type: 'hidden', required: false },
            { field: 'LastModBy',     type: 'hidden', required: false },
        ],
        toolbar: {
            items: [
                { id: 'btnNotes', type: 'button', icon: 'fa fa-sticky-note-o' },
                { id: 'bt3', type: 'spacer' },
                { id: 'btnClose', type: 'button', icon: 'fa fa-times' },
            ],
            onClick: function (event) {
                switch(event.target) {
                case 'btnClose':
                    w2ui.toplayout.hide('right',true);
                    w2ui.toplayout.render();
                    break;
                }
            },
        },
        onValidate: function (event) {
            if (this.record.ARID.id === 0) {
                event.errors.push({
                    field: this.get('ARID'),
                    error: 'The Account Rule needs to be set'
                });
            }
            if (this.record.Amount < 0.01) {
                event.errors.push({
                    field: this.get('Amount'),
                    error: 'Amount must be at least $0.01'
                });
            }
        },
        actions: {
            save: function () {
                //var obj = this;
                var x = getCurrentBusiness();
                w2ui.asmEpochForm.url = '/v1/asm/' + x.value + '/' + w2ui.asmEpochForm.record.ASMID;
                var tgrid = w2ui.asmsGrid;
                var sel = tgrid.getSelection();
                tgrid.unselect(sel);
                this.save({}, function (data) {
                    if (data.status == 'error') {
                        console.log('ERROR: '+ data.message);
                        return;
                    }
                    w2ui.toplayout.hide('right',true);
                    tgrid.reload();
                });
            },
            delete: function() {

                var form = this;

                w2confirm(delete_confirm_options)
                .yes(function() {
                    var tgrid = w2ui.asmsGrid;
                    var sel = tgrid.getSelection();
                    tgrid.unselect(sel);

                    var params = {cmd: 'delete', formname: form.name, ASMID: form.record.ASMID };
                    var dat = JSON.stringify(params);

                    // delete Depository request
                    $.post(form.url, dat)
                    .done(function(data) {
                        if (data.status != "success") {
                            return;
                        }
                        w2ui.toplayout.hide('right',true);
                        w2ui.toplayout.render();
                        tgrid.reload();
                    })
                    .fail(function(/*data*/){
                        console.log("Delete Assessment epoch failed.");
                    });
                })
                .no(function() {
                    return;
                });
            },
        },
        onRefresh: function(/*event*/) {
            var f = w2ui.asmEpochForm;
            var r = f.record;
            if (r.ASMID) {
                f.header = "Edit" + app.sAssessment + " (" + r.ASMID + ")";
                isNewFormRecord(f.name, false);
            }
            else {
                f.header = "Edit" + app.sAssessment + " (new)";
                isNewFormRecord(f.name, true);
            }
        }
    });

    //----------------------------------------------------------------------------------------------
    //          asmInstForm  -  assessment instance - instances only, not for recurring assessments
    //----------------------------------------------------------------------------------------------
    $().w2form({
        name: 'asmInstForm',
        style: 'border: 0px; background-color: transparent;',
        header: app.sAssessment + ' Detail',
        url: '/v1/asm',
        formURL: '/html/formasminst.html',
        fields: [
            { field: 'ARID',          type: 'list',   required: true, options: { items: app.Assessments } },
            { field: 'recid',         type: 'int',    required: false },
            { field: 'ASMID',         type: 'int',    required: false },
            { field: 'BID',           type: 'list',   options:  {items: app.businesses}, required: false },
            { field: 'PASMID',        type: 'w2int',  required: false },
            { field: 'RID',           type: 'w2int',  hidden:   true },
            { field: 'Rentable',      type: 'text',   required: false },
            { field: 'RAID',          type: 'w2int',  required: false },
            { field: 'Amount',        type: 'money',  required: true },
            { field: 'Start',         type: 'date',   required: true },
            { field: 'Stop',          type: 'date',   required: true },
            { field: 'RentCycle',     type: 'list',   options:  {items: app.cycleFreq}, required: true },
            { field: 'ProrationCycle',type: 'list',   options:  {items: app.cycleFreq}, required: true },
            { field: 'Comment',       type: 'text',   required: false },
            { field: 'LastModTime',   type: 'hidden', required: false },
            { field: 'LastModBy',     type: 'hidden', required: false },
        ],
        toolbar: {
            items: [
                { id: 'btnNotes', type: 'button', icon: 'fa fa-sticky-note-o' },
                { id: 'bt3', type: 'spacer' },
                { id: 'btnClose', type: 'button', icon: 'fa fa-times' },
            ],
            onClick: function (event) {
                switch(event.target) {
                case 'btnClose':
                    w2ui.toplayout.hide('right',true);
                    w2ui.toplayout.render();
                    break;
                }
            },
        },
        actions: {
            save: function () {
                //var obj = this;
                var tgrid = w2ui.asmsGrid;
                var sel = tgrid.getSelection();
                tgrid.unselect(sel);
                this.save({}, function (data) {
                    if (data.status == 'error') {
                        console.log('ERROR: '+ data.message);
                        return;
                    }
                    w2ui.toplayout.hide('right',true);
                    tgrid.reload();
                });

            },
            delete: function() {

                var form = this;

                w2confirm(delete_confirm_options)
                .yes(function() {
                    var tgrid = w2ui.asmsGrid;
                    var sel = tgrid.getSelection();
                    tgrid.unselect(sel);

                    var params = {cmd: 'delete', formname: form.name, ASMID: form.record.ASMID };
                    var dat = JSON.stringify(params);

                    // delete Depository request
                    $.post(form.url, dat)
                    .done(function(data) {
                        if (data.status != "success") {
                            return;
                        }
                        w2ui.toplayout.hide('right',true);
                        w2ui.toplayout.render();
                        tgrid.reload();
                    })
                    .fail(function(/*data*/){
                        console.log("Delete Assessment instance failed.");
                    });
                })
                .no(function() {
                    return;
                });
            },
        },
        onLoad: function(event) {
            event.onComplete = function() {
                var f = w2ui.asmInstForm;
                var r = f.record;
                // var x = getCurrentBusiness();
                // var BID=parseInt(x.value);
                // var BUD = getBUDfromBID(BID);

                var params = {"cmd":"get","recid":0,"name":"asmInstForm"};
                var dat = JSON.stringify(params);
                $.post('/v1/asm/' + x.value + '/' + r.PASMID, dat)
                .done( function(data) {
                    if (data.status != 'success') {
                        f.message(data.message);
                        f.pasmStart = "";
                        f.pasmStop = "";
                    }
                    data = JSON.parse(data);
                    // get parent assessment dates and store it in form
                    f.pasmStart = data.record.Start;
                    f.pasmStop = data.record.Stop;
                })
                .fail( function() {
                    console.log('Error getting /v1/asm/' + x.value + '/' + r.PASMID);
                 });
            };
        },
        onRefresh: function(/*event*/) {
            var f = w2ui.asmInstForm;
            var r = f.record;

            if (r.ASMID) {
                f.header = "Edit" + app.sAssessment + " (" + r.ASMID + ")";
                isNewFormRecord(f.name, false);
            }
            else {
                f.header = "Edit" + app.sAssessment + " (new)";
                isNewFormRecord(f.name, true);
            }

            // r.epoch = app.epochInstance[  (r.RentCycle !== 'Norecur' && r.PASMID === 0) ? 0 : 1 ];
            if (!String.prototype.format) {
                String.prototype.format = function() {
                    var args = arguments;
                    return this.replace(/{(\d+)}/g, function(match, number) {
                        return typeof args[number] != 'undefined'? args[number] : match;
                    });
                };
            }

            var hdr = '';
            if (typeof r.RentCycle !== "object") { return; }
            if (r.RentCycle.text == 'Norecur' && r.PASMID === 0) {
                // EPOCH
                hdr = 'This assessment is not part of any recurring series';
            } else {
                // INSTANCE has 4 variables: ParentASM, RentCycle, Start, Stop
                hdr = app.asmInstanceHeader.format(''+r.PASMID, r.RentCycle.text, f.pasmStart, f.pasmStop);
            }
            $("#asmInstForm").find("#AssessmentEpochOrInstance").html(hdr);
        }
    });

    //------------------------------------------------------------------------
    //          tcidRAPayorPicker
    //------------------------------------------------------------------------
    $().w2form({
        name: 'tcidRAPayorPicker',
        style: 'border: 0px; background-color: transparent;',
        formURL: '/html/tcidrapayorpicker.html',
        focus  : 0,
        fields: [
            { field: 'TCID', type: 'w2int', required: true },
            { field: 'pickedName', required: true,
                type: 'enum',
                options: {
                    url:        '/v1/transactantstd/' + app.TcidRAPayorPicker.BID,
                    max:        1,
                    renderItem: tcidRAPayorPickerRender,
                    renderDrop: tcidPickerDropRender,
                    compare:    tcidPickerCompare,
                    onNew: function (event) {
                        //console.log('++ New Item: Do not forget to submit it to the server too', event);
                        $.extend(event.item, { FirstName: '', LastName : event.item.text });
                    }
                },
            },
            { field: 'DtStart', type: 'date', required: true },
            { field: 'DtStop', type: 'date', required: true },
            { field: 'FirstName', type: 'text', required: false },
            { field: 'LastName', type: 'text', required: false },
            { field: 'CompanyName', type: 'text', required: false },
            { field: 'IsCompany', type: 'int', required: false },
        ],
        onRefresh: function(/*event*/) {
            w2ui.tcidRAPayorPicker.fields[1].options.url = '/v1/transactantstd/' + app.TcidRAPayorPicker.BID;
            console.log('SAVE tcidRAPayorPicker: TCID = ' + w2ui.tcidRAPayorPicker.record.TCID + '  DtStart = ' + w2ui.tcidRAPayorPicker.record.DtStart + '  DtStop = ' + w2ui.tcidRAPayorPicker.record.DtStop);
        },
        onChange: function (event) {
            console.log(event);
        },
        actions: {
            save: function () {
                var errs = w2ui.tcidRAPayorPicker.validate(true);
                if (errs.length > 0) {
                    return;
                }
                w2popup.close();
                saveNewRAPayor();
            },
        },
    });

    //------------------------------------------------------------------------
    //          tcidRUserPicker
    //------------------------------------------------------------------------
    $().w2form({
        name: 'tcidRUserPicker',
        style: 'border: 0px; background-color: transparent;',
        formURL: '/html/tcidruserpicker.html',
        focus  : 0,
        fields: [
            { field: 'TCID', type: 'w2int', required: true },
            { field: 'pickedName', required: true,
                type: 'enum',
                options: {
                    url:        '/v1/transactantstd/' + app.TcidRUserPicker.BID,
                    max:        1,
                    renderItem: tcidRUserPickerRender,
                    renderDrop: tcidPickerDropRender,
                    compare:    tcidPickerCompare,
                    onNew: function (event) {
                        //console.log('++ New Item: Do not forget to submit it to the server too', event);
                        $.extend(event.item, { FirstName: '', LastName : event.item.text });
                    }
                },
            },
            { field: 'RentableName', type: 'list', required: true, options: { items: [] } },
            { field: 'DtStart', type: 'date', required: true },
            { field: 'DtStop', type: 'date', required: true },
            { field: 'FirstName', type: 'text', required: false },
            { field: 'LastName', type: 'text', required: false },
            { field: 'CompanyName', type: 'text', required: false },
            { field: 'IsCompany', type: 'int', required: false },
        ],
        onRefresh: function(/*event*/) {
            w2ui.tcidRUserPicker.fields[1].options.url = '/v1/transactantstd/' + app.TcidRUserPicker.BID;
            w2ui.tcidRUserPicker.fields[2].options.items = app.TcidRUserPicker.RARentablesNames;
            if (app.TcidRUserPicker.RARentablesNames.length == 1) {
                w2ui.tcidRUserPicker.record.RentableName = app.TcidRUserPicker.RARentablesNames[0];
            }
        },
        onChange: function (event) {
            console.log(event);
        },
        actions: {
            save: function () {
                var errs = w2ui.tcidRUserPicker.validate(true);
                if (errs.length > 0) { return; }
                console.log('SAVE tcidRUserPicker: TCID = ' + w2ui.tcidRUserPicker.record.TCID + '  DtStart = ' + w2ui.tcidRUserPicker.record.DtStart + '  DtStop = ' + w2ui.tcidRUserPicker.record.DtStop);
                w2popup.close();
                saveNewRUser();
            },
        },
    });

    //------------------------------------------------------------------------
    //          ridRentablePicker
    //------------------------------------------------------------------------
    $().w2form({
        name: 'ridRentablePicker',
        style: 'border: 0px; background-color: transparent;',
        formURL: '/html/ridrentablepicker.html',
        focus  : 0,
        openOnFocus: true,
        fields: [
            { field: 'RentableName', required: true,
                type: 'enum',
                options: {
                    url:        '/v1/rentablestd/' + app.ridRentablePicker.BID,
                    max:        1,
                    cacheMax:   50,
                    renderItem: ridRentablePickerRender,
                    renderDrop: ridRentableDropRender,
                    compare:    ridRentableCompare,
                    onNew: function (event) {
                        //console.log('++ New Item: Do not forget to submit it to the server too', event);
                        $.extend(event.item, { RentableName : event.item.text });
                    }
                },
            },
            { field: 'DtStart', type: 'date',  required: true },
            { field: 'DtStop',  type: 'date',  required: true },
            { field: 'Amount',  type: 'money', required: true },
            { field: 'RID',     type: 'wsint' },
        ],
        onRefresh: function(/*event*/) {
            w2ui.ridRentablePicker.fields[0].options.url = '/v1/rentablestd/' + app.ridRentablePicker.BID;
        },
        onChange: function (event) {
            console.log(event);
        },
        actions: {
            save: function () {
                var errs = w2ui.ridRentablePicker.validate(true);
                if (errs.length > 0) { return; }
                console.log('SAVE ridRentablePicker: TCID = ' + w2ui.ridRentablePicker.record.TCID + '  DtStart = ' + w2ui.ridRentablePicker.record.DtStart + '  DtStop = ' + w2ui.ridRentablePicker.record.DtStop);
                w2popup.close();
                saveNewRARentable();
            },
        },
    });


    //------------------------------------------------------------------------
    //          rentalAgrFinder
    //------------------------------------------------------------------------
    $().w2form({
        name: 'rentalAgrFinder',
        style: 'border: 0px; background-color: transparent;',
        formURL: '/html/rentalagrfinder.html',
        focus  : 0,
        fields: [
            { field: 'TCID', type: 'int', required: true },
            // INDEX 1
            { field: 'PayorName', required: true,
                type: 'enum',
                options: {
                    url:        '/v1/rentalagrtd/' + app.RentalAgrFinder.BID,
                    // max:        1,
                    renderItem: rentalAgrFinderRender,
                    renderDrop: rentalAgrFinderDropRender,
                    compare:    rentalAgrFinderCompare,
                    onNew: function (event) {
                        console.log('++ New Item: Do not forget to submit it to the server too', event);
                        //$.extend(event.item, { FirstName: '', LastName : event.item.text });
                    }
                },
            },
            // INDEX 2
            { field: 'RentableName', type: 'list', required: true, options: { items: [] } },
            { field: 'RAID', type: 'int', required: true },
            { field: 'FirstName', type: 'text', required: false},
            { field: 'LastName', type: 'text', required: false},
            { field: 'CompanyName', type: 'text', required: false},
            { field: 'IsCompany', type: 'int', required: false },
        ],
        onRefresh: function(/*event*/) {
            w2ui.rentalAgrFinder.fields[1].options.url = '/v1/rentalagrtd/' + app.RentalAgrFinder.BID;

            w2ui.rentalAgrFinder.fields[2].options.items = app.RentalAgrFinder.RARentablesNames;
            if (app.RentalAgrFinder.RARentablesNames.length == 1) {
                w2ui.rentalAgrFinder.record.RentableName = app.RentalAgrFinder.RARentablesNames[0];
            }

        },
        onChange: function (event) {
            console.log(event);
        },
        actions: {
            save: function () {
                w2ui.asmEpochForm.record.RAID = w2ui.rentalAgrFinder.record.RAID;
                w2ui.asmEpochForm.record.Rentable = w2ui.rentalAgrFinder.record.RentableName.text;
                w2ui.asmEpochForm.record.RID = w2ui.rentalAgrFinder.record.RentableName.id;
                w2ui.asmEpochForm.refresh();
                w2popup.close();
                // var errs = w2ui.tcidRUserPicker.validate(true);
                // if (errs.length > 0) { return; }
                // console.log('SAVE tcidRUserPicker: TCID = ' + w2ui.tcidRUserPicker.record.TCID + '  DtStart = ' + w2ui.tcidRUserPicker.record.DtStart + '  DtStop = ' + w2ui.tcidRUserPicker.record.DtStop);
                // saveNewRUser();
            },
        },
    });

    //------------------------------------------------------------------------
    //          pmtsGrid
    //------------------------------------------------------------------------
    $().w2grid({
        name: 'pmtsGrid',
        url: '/v1/pmts',
        multiSelect: false,
        show: {
            toolbar        : true,
            footer         : true,
            toolbarAdd     : true,   // indicates if toolbar add new button is visible
            toolbarDelete  : false,   // indicates if toolbar delete button is visible
            toolbarSave    : false,   // indicates if toolbar save button is visible
            selectColumn    : false,
            expandColumn    : false,
            toolbarEdit     : false,
            toolbarSearch   : false,
            toolbarInput    : false,
            searchAll       : false,
            toolbarReload   : false,
            toolbarColumns  : false,
        },
        columns: [
            {field: 'recid', hidden: true, caption: 'recid',  size: '40px', sortable: true},
            {field: 'PMTID',       hidden: true, caption: 'PMTID',        size: '150px',                             sortable: true, style: 'text-align: center'},
            {field: 'BID',         hidden: true, caption: 'BID',          size: '150px',                             sortable: true, style: 'text-align: center'},
            {field: 'Name',        hidden: false, caption: 'Name',        size: '150px', sortable: true, style: 'text-align: left'},
            {field: 'Description', hidden: false, caption: 'Description', size: '60%',   sortable: true, style: 'text-align: left'},
        ],
        onLoad: function(event) {
            if (event.xhr.status == 200) {
                if (typeof data == "undefined") {
                    return;
                }
                var temp_list = [];
                var data = JSON.parse(event.xhr.responseText);
                data.records.forEach(function(pmtRec){
                    temp_list.push({id: pmtRec.PMTID, text: pmtRec.Name});
                });
                app.paymentTypeList = temp_list;

                // update payments list for a business
                var x = getCurrentBusiness();
                var BID=parseInt(x.value);
                var BUD = getBUDfromBID(BID);
                app.pmtTypes[BUD] = temp_list;
            }
        },
        onRefresh: function(event) {
            event.onComplete = function() {
                var sel_recid = this.last.sel_recid;
                if (app.activeGrid == this.name && sel_recid !== undefined && sel_recid !== null) {
                    if (app.new_form_rec) {
                        this.unselect(sel_recid);
                    }
                    else{
                        this.select(sel_recid);
                    }
                }
            };
        },
        onClick: function(event) {
            event.onComplete = function() {
                app.new_form_rec = false;
                var rec = this.get(event.recid);  // integer value (event.recid holds value in string)

                // popup the dialog form
                setToForm('pmtForm', '/v1/pmts/' + rec.BID + '/' + rec.PMTID, 400, true);
            };
        },
        onAdd: function (/*event*/) {
            app.new_form_rec = true;

            var x = getCurrentBusiness();
            var BID=parseInt(x.value);
            var BUD = getBUDfromBID(BID);

            var record = {
                recid: 0,
                PMTID: 0,
                BID: BID,
                BUD: BUD,
                Name: '',
                Description: '',
            };

            w2ui.pmtForm.record = record;
            w2ui.pmtForm.refresh();

            setToForm('pmtForm', '/v1/pmts/' + BID + '/0', 400);
        },
    });

    //------------------------------------------------------------------------
    //          payment types form
    //------------------------------------------------------------------------
    $().w2form({
        name: 'pmtForm',
        header: 'Payment Type Detail',
        url: '/v1/pmts',
        style: 'border: 0px; background-color: transparent;display: block;',
        formURL: '/html/formpmt.html',
        fields: [
            { field: 'recid', type: 'int', required: false, html: { caption: 'recid', page: 0, column: 0 } },
            { field: 'BID', type: 'int', required: false, html: { caption: 'BID', page: 0, column: 0 }, hidden: true },
            { field: 'BUD', type: 'list', options: { items: app.businesses }, required: true, html: { caption: 'BUD', page: 0, column: 0 } },
            { field: 'PMTID', type: 'int', required: false, html: { caption: 'PMTID', page: 0, column: 0 }, hidden: true },
            { field: 'Name', type: 'text', required: true, html: { caption: 'Name', page: 0, column: 0 }, sortable: true },
            { field: 'Description', type: 'text', required: false, html: { caption: 'Description', page: 0, column: 0 }, sortable: true },
            { field: 'LastModTime', type: 'date', required: false, html: { caption: 'LastModTime', page: 0, column: 0 } },
            { field: 'LastModBy', type: 'int', required: false, html: { caption: 'LastModBy', page: 0, column: 0 } },
        ],
        toolbar: {
            items: [
                { id: 'btnNotes', type: 'button', icon: 'fa fa-sticky-note-o' },
                { id: 'bt3', type: 'spacer' },
                { id: 'btnClose', type: 'button', icon: 'fa fa-times' },
            ],
            onClick: function(event) {
                switch(event.target) {
                    case 'btnClose':
                        w2ui.toplayout.hide('right',true);
                        w2ui.toplayout.render();
                        break;
                }
            }
        },
        actions: {
            save: function() {
                var tgrid = w2ui.pmtsGrid;
                var sel = tgrid.getSelection();
                tgrid.unselect(sel);

                // this.save({}, function (data) {
                //     if (data.status == 'error') {
                //         console.log('ERROR: '+ data.message);
                //         return;
                //     }
                //     w2ui.toplayout.hide('right',true);
                //     tgrid.reload();
                // });
                var params = {cmd: 'save', formname: this.name, record: this.record };
                var dat = JSON.stringify(params);

                // save Depository request
                $.post(this.url, dat)
                .done(function(data) {
                    if (data.status != "success") {
                        return;
                    }
                    w2ui.toplayout.hide('right',true);
                    w2ui.toplayout.render();
                    tgrid.reload();
                })
                .fail(function(/*data*/){
                    console.log("Save Payment Type failed.");
                });
            },
            delete: function() {

                var form = this;

                w2confirm(delete_confirm_options)
                .yes(function() {
                    var tgrid = w2ui.pmtsGrid;
                    var sel = tgrid.getSelection();
                    tgrid.unselect(sel);

                    var params = {cmd: 'delete', formname: form.name, ID: form.record.PMTID };
                    var dat = JSON.stringify(params);

                    // delete Depository request
                    $.post(form.url, dat)
                    .done(function(data) {
                        if (data.status != "success") {
                            return;
                        }

                        // remove this from app.paymentTypeList if successfully removed
                        var temp_list = [];
                        app.paymentTypeList.forEach(function(pmtRec){
                            if (pmtRec.ID != form.record.PMTID) {
                                temp_list.push({id: pmtRec.PMTID, text: pmtRec.Name});
                            }
                        });
                        app.paymentTypeList = temp_list;

                        // update payments list for a business
                        var x = getCurrentBusiness();
                        var BID=parseInt(x.value);
                        var BUD = getBUDfromBID(BID);
                        app.pmtTypes[BUD] = temp_list;

                        w2ui.toplayout.hide('right',true);
                        w2ui.toplayout.render();
                        tgrid.reload();
                    })
                    .fail(function(/*data*/){
                        console.log("Delete Payment failed.");
                    });
                })
                .no(function() {
                    return;
                });
            },
        },
        onRefresh: function(/*event*/) {
            var f = w2ui.pmtForm;
            var r = f.record;
            if (r.PMTID) {
                f.header = 'Edit Payment Type' + ' (' + r.PMTID + ')';
                isNewFormRecord(f.name, false);
            } else {
                f.header = 'Edit Payment Type (new)';
                isNewFormRecord(f.name, true);
            }
        }
    });

    //------------------------------------------------------------------------
    //          depGrid
    //------------------------------------------------------------------------
    $().w2grid({
        name: 'depGrid',
        url: '/v1/dep',
        multiSelect: false,
        show: {
            toolbar        : true,
            footer         : true,
            toolbarAdd     : true,   // indicates if toolbar add new button is visible
            toolbarDelete  : false,   // indicates if toolbar delete button is visible
            toolbarSave    : false,   // indicates if toolbar save button is visible
            selectColumn   : false,
            expandColumn   : false,
            toolbarEdit    : false,
            toolbarSearch  : false,
            toolbarInput   : false,
            searchAll      : false,
            toolbarReload  : false,
            toolbarColumns : false,
        },
        columns: [
            {field: 'recid', hidden: true, caption: 'recid', size: '40px', sortable: true},
            {field: 'DEPID', hidden: true, caption: 'DEPID', size: '150px', sortable: true, style: 'text-align: center'},
            {field: 'BID', hidden: true, caption: 'BID', size: '150px', sortable: true, style: 'text-align: center'},
            {field: 'BUD', hidden: true, caption: 'BUD', size: '150px', sortable: true, style: 'text-align: center'},
            {field: 'LID', hidden: true, caption: 'LID', size: '150px', sortable: true, style: 'text-align: center'},
            {field: 'AccountNo', hidden: false, caption: 'Account Number', size: '150px', sortable: true, style: 'text-align: right'},
            {field: 'Name', hidden: false, caption: 'Name', size: '20%', sortable: true, style: 'text-align: left'},
            {field: 'LdgrName', hidden: false, caption: 'GL Acct Name', size: '20%', sortable: true, style: 'text-align: left'},
            {field: 'GLNumber', hidden: false, caption: 'GL Number', size: '150px', sortable: true, style: 'text-align: right'},
        ],
        onRefresh: function(event) {
            event.onComplete = function() {
                var sel_recid = this.last.sel_recid;
                if (app.activeGrid == this.name && sel_recid !== undefined && sel_recid !== null) {
                    if (app.new_form_rec) {
                        this.unselect(sel_recid);
                    }
                    else{
                        this.select(sel_recid);
                    }
                }
            };
        },
        onClick: function(event) {
            event.onComplete = function () {
                app.new_form_rec = false;

                // get selected element as multiSelect is false
                var rec = this.get(event.recid);

                var BUD = getBUDfromBID(rec.BID);

                // get gl account list
                getAccountsList(rec.BID)
                .done(function(data){
                    if (data.status != 'success') {
                        w2ui.depForm.message(data.message);
                    } else {

                        var gl_selected = {id: rec.LID, text: rec.GLNumber+" "+"(" + rec.LdgrName + ")"};
                        // get gl accounts for BUD
                        w2ui.depForm.get('LID').options.items = app.gl_accounts[BUD];
                        w2ui.depForm.get('LID').options.selected = gl_selected;

                        // refresh the form
                        w2ui.depForm.refresh();
                    }

                    setToForm('depForm', '/v1/dep/' + rec.BID + '/' + rec.DEPID, 400, true);
                })
                .fail(function(/*data*/){
                    console.log("Failed to get glAccountList");
                });
            };
        },
        onAdd: function (/*event*/) {
            app.new_form_rec = true;

            // Insert an empty record...
            var x = getCurrentBusiness();
            var BID=parseInt(x.value);
            var BUD = getBUDfromBID(BID);

            // get latest gl accounts first
            getAccountsList(BID)
            .done(function(data) {

                if (data.status != 'success') {
                    w2ui.depForm.message(data.message);
                    w2ui.toplayout.content('right', w2ui.depForm);
                    w2ui.toplayout.show('right', true);
                    w2ui.toplayout.sizeTo('right', 700);
                    return;
                } else {

                    var gl_accounts_pre_selected = {id: 0, text: " -- Select GL Account -- "};
                    var gl_accounts_items = [gl_accounts_pre_selected];
                    // get gl account list for BUD from `gl_accounts` key of `app`
                    gl_accounts_items = gl_accounts_items.concat(app.gl_accounts[BUD]);

                    w2ui.depForm.get('LID').options.items = gl_accounts_items;
                    w2ui.depForm.get('LID').options.selected = gl_accounts_pre_selected;

                    var record = {
                        recid: 0,
                        DEPID: 0,
                        BID: BID,
                        BUD: BUD,
                        LID: 0,
                        Name: 'Depository Name',
                        AccountNo: 'Account Number',
                    };

                    w2ui.depForm.record = record;
                    w2ui.depForm.refresh();

                    setToForm('depForm', '/v1/dep/' + BID + '/0', 400);
                }
            })
            .fail( function() {
                console.log('unable to get GLAccounts');
                return;
             });

        },
    });

    //------------------------------------------------------------------------
    //          depository Form
    //------------------------------------------------------------------------
    $().w2form({
        name: 'depForm',
        style: 'border: 0px; background-color: transparent;',
        header: 'Depository Detail',
        url: '/v1/dep',
        formURL: '/html/formdep.html',
        fields: [
            { field: 'recid', type: 'int', required: false, html: { page: 0, column: 0 } },
            { field: 'DEPID', type: 'int', required: false, html: { page: 0, column: 0 } },
            { field: 'BID', type: 'int', required: false, html: { page: 0, column: 0 } },
            { field: 'BUD', type: 'list', required: true, options: {items: app.businesses}, html: { page: 0, column: 0 } },
            { field: 'LID', type: 'list', required: true, options: { items: [], selected: {}, maxDropHeight: 200 }, html: { page: 0, column: 0 } },
            { field: 'Name', type: 'text', required: true, html: { page: 0, column: 0 } },
            { field: 'AccountNo', type: 'text', required: false, html: { page: 0, column: 0 } },
            { field: 'LastModTime', type: 'date', required: false, html: { page: 0, column: 0 } },
            { field: 'LastModBy', type: 'int', required: false, html: { page: 0, column: 0 } },
        ],
        toolbar: {
            items: [
                { id: 'btnNotes', type: 'button', icon: 'fa fa-sticky-note-o' },
                { id: 'bt3', type: 'spacer' },
                { id: 'btnClose', type: 'button', icon: 'fa fa-times' },
            ],
            onClick: function (event) {
                switch(event.target) {
                case 'btnClose':
                    w2ui.toplayout.hide('right',true);
                    w2ui.toplayout.render();
                    break;
                }
            },
        },
        actions: {
            save: function (/*target, data*/) {
                var tgrid = w2ui.depGrid;
                var sel = tgrid.getSelection();
                tgrid.unselect(sel);

                // this.save({}, function (data) {
                //     if (data.status == 'error') {
                //         console.log('ERROR: '+ data.message);
                //         return;
                //     }
                //     w2ui.toplayout.hide('right',true);
                //     tgrid.reload();
                // });
                // TODO: need to figure out why save is not working here?

                var params = {cmd: 'save', formname: this.name, record: this.record };
                var dat = JSON.stringify(params);

                // save Depository request
                $.post(this.url, dat)
                .done(function(data) {
                    if (data.status != "success") {
                        return;
                    }
                    w2ui.toplayout.hide('right',true);
                    w2ui.toplayout.render();
                    tgrid.reload();
                })
                .fail(function(/*data*/){
                    console.log("Save Depository failed.");
                });
            },
            delete: function(/*target, data*/) {

                var form = this;

                w2confirm(delete_confirm_options)
                .yes(function() {

                    var tgrid = w2ui.depGrid;
                    var sel = tgrid.getSelection();
                    tgrid.unselect(sel);

                    var params = {cmd: 'delete', formname: form.name, ID: form.record.DEPID };
                    var dat = JSON.stringify(params);

                    // delete Depository request
                    $.post(form.url, dat)
                    .done(function(data) {
                        if (data.status != "success") {
                            return;
                        }
                        w2ui.toplayout.hide('right',true);
                        w2ui.toplayout.render();
                        tgrid.reload();
                    })
                    .fail(function(/*data*/){
                        console.log("Delete Depository failed.");
                    });
                })
                .no(function() {
                    return;
                });
            },
        },
        onRefresh: function(/*event*/) {
            var f = w2ui.depForm;
            var r = f.record;
            if (r.DEPID) {
                f.header = 'Edit Depository' + ' (' + r.DEPID + ')';
                isNewFormRecord(f.name, false);
            } else {
                f.header = 'Edit Depository (new)';
                isNewFormRecord(f.name, true);
            }
        }
    });

    //------------------------------------------------------------------------
    //          Account Rules Grid
    //------------------------------------------------------------------------
    $().w2grid({
        name: 'arsGrid',
        url: '/v1/ars',
        multiSelect: false,
        show: {
            toolbar        : true,
            footer         : true,
            toolbarAdd     : true,    // indicates if toolbar add new button is visible
            toolbarDelete  : false,   // indicates if toolbar delete button is visible
            toolbarSave    : false,   // indicates if toolbar save button is visible
            selectColumn   : false,
            expandColumn   : false,
            toolbarEdit    : false,
            toolbarSearch  : false,
            toolbarInput   : false,
            searchAll      : false,
            toolbarReload  : false,
            toolbarColumns : false,
        },
        columns: [
            {field: 'recid',  hidden: true,  caption: 'recid', size: '40px',  sortable: true},
            {field: 'ARID',   hidden: true,  caption: 'COPID', size: '150px', sortable: true, style: 'text-align: center'},
            {field: 'BID',    hidden: true,  caption: 'BID',   size: '150px', sortable: true, style: 'text-align: center'},
            {field: 'Name',   hidden: false, caption: 'Name',  size: '15%',   sortable: true, style: 'text-align: left'},
            {field: 'ARType', hidden: false, caption: 'ARType',size: '80px',  sortable: true, style: 'text-align: left',
                render: function (record, index, col_index) {
                    return app.ARTypes[this.getCellValue(index, col_index)];
                }
            },
            {field: 'DebitLID',        hidden: true,  caption: 'DebitLID',   size: '50px', sortable: true},
            {field: 'DebitLedgerName', hidden: false, caption: 'Debit',      size: '200px',sortable: true, style: 'text-align: left'},
            {field: 'CreditLID',       hidden: true,  caption: 'CreditLID',  size: '50px', sortable: true},
            {field: 'CreditLedgerName',hidden: false, caption: 'CreditLID',  size: '200px',sortable: true, style: 'text-align: left'},
            {field: 'DtStart',                        caption: 'Start',      size: '70px', sortable: true, style: 'text-align: right'},
            {field: 'DtStop',                         caption: 'Stop',       size: '70px', sortable: true, style: 'text-align: right'},
            {field: 'Description',     hidden: false, caption: 'Description',size: '20%',  sortable: true, style: 'text-align: left'},
        ],
        onRefresh: function(event) {
            event.onComplete = function() {
                var sel_recid = this.last.sel_recid;
                if (app.activeGrid == this.name && sel_recid !== undefined && sel_recid !== null) {
                    if (app.new_form_rec) {
                        this.unselect(sel_recid);
                    }
                    else{
                        this.select(sel_recid);
                    }
                }
            };
        },
        onClick: function(event) {
            event.onComplete = function () {
                app.new_form_rec = false;

                // multi select is false
                var rec = this.get(event.recid);

                var BUD = getBUDfromBID(rec.BID);

                // set ARType DropDown list
                var artype_selected;
                var artype_items = [];
                Object.keys(app.ARTypes).forEach(function(artype_id){
                    if (rec.ARType == artype_id) {
                        artype_selected = {id: artype_id, text: app.ARTypes[artype_id]};
                    }
                    artype_items.push({id: artype_id, text: app.ARTypes[artype_id]});
                });

                // get gl account list
                getPostAccounts(rec.BID)
                .done(function(/*data*/){

                    // set fields
                    w2ui.arsForm.get('ARType').options.items=artype_items;
                    w2ui.arsForm.get('ARType').options.selected=artype_selected;

                    w2ui.arsForm.get('DebitLID').options.items=app.post_accounts[BUD];
                    w2ui.arsForm.get('DebitLID').options.selected={id: rec.DebitLID, text: rec.DebitLedgerName};

                    w2ui.arsForm.get('CreditLID').options.items=app.post_accounts[BUD];
                    w2ui.arsForm.get('CreditLID').options.selected={id: rec.CreditLID, text: rec.CreditLedgerName};

                    // refresh the form
                    w2ui.arsForm.refresh();

                    setToForm('arsForm', '/v1/ar/' + rec.BID + '/' + rec.ARID, 400, true);
                })
                .fail(function(/*data*/){
                    console.log("Failed to get glAccountList");
                });
            };
        },
        onAdd: function (/*event*/) {
            app.new_form_rec = true;

            // Insert an empty record...
            var x = getCurrentBusiness();
            var BID=x.value;
            var BUD = getBUDfromBID(BID);

            // get latest gl accounts first
            getPostAccounts(BID)
            .done(function(data) {
                if (data.status != 'success') {
                    w2ui.arsForm.message(data.message);
                    w2ui.toplayout.content('right', w2ui.arsForm);
                    w2ui.toplayout.show('right', true);
                    w2ui.toplayout.sizeTo('right', 700);
                    return;
                }
                else {
                    var artype_pre_selected = {id: 0, text: " -- Select AR type -- "};
                    var artype_items = [artype_pre_selected];
                    Object.keys(app.ARTypes).forEach(function(artype_id){
                        artype_items.push({id: artype_id, text: app.ARTypes[artype_id]});
                    });

                    var post_accounts_pre_selected = {id: 0, text: " -- Select GL Account -- "};
                    var post_accounts_items = [post_accounts_pre_selected];
                    post_accounts_items = post_accounts_items.concat(app.post_accounts[BUD]);

                    w2ui.arsForm.get('ARType').options.items = artype_items;
                    w2ui.arsForm.get('ARType').options.selected = artype_pre_selected;
                    w2ui.arsForm.get('DebitLID').options.items = post_accounts_items;
                    w2ui.arsForm.get('DebitLID').options.selected = post_accounts_pre_selected;
                    w2ui.arsForm.get('CreditLID').options.items = post_accounts_items;
                    w2ui.arsForm.get('CreditLID').options.selected = post_accounts_pre_selected;
                    // w2ui.arsForm.refresh();

                    var y = new Date();
                    var ny = new Date(y.getFullYear() + 1, y.getMonth(), y.getDate(), 0, 0, 0);

                    var record = {
                        recid: 0,
                        BID: BUD,
                        ARID: 0,
                        ARType: artype_pre_selected,
                        DebitLID: post_accounts_pre_selected,
                        CreditLID: post_accounts_pre_selected,
                        Name: '',
                        Description: '',
                        DtStart: w2uiDateControlString(y),
                        DtStop: w2uiDateControlString(ny),
                        PriorToRAStart: true,
                        PriorToRAStop: true,
                    };
                    w2ui.arsForm.record = record;
                    w2ui.arsForm.refresh();

                    setToForm('arsForm', '/v1/ar/' + BID + '/0', 400);
                }
            })
            .fail( function() {
                console.log('unable to get GLAccounts');
                return;
             });

        },
    });

    //------------------------------------------------------------------------
    //          Account Rules Form
    //------------------------------------------------------------------------
    $().w2form({
        name: 'arsForm',
        style: 'border: 0px; background-color: transparent;',
        header: 'Edit Account Rule',
        url: '/v1/ar',
        formURL: '/html/formar.html',
        fields: [
            { field: 'recid', type: 'int', required: false, html: { page: 0, column: 0 } },
            { field: 'ARID', type: 'int', required: false, html: { page: 0, column: 0 } },
            { field: 'BID', type: 'list', required: true, options: { items: app.businesses }, html: { page: 0, column: 0 } },
            { field: 'Name', type: 'text', required: true, html: { page: 0, column: 0 } },
            { field: 'ARType', type: 'list', required: true, html: { page: 0, column: 0 }, options: { items: [], selected: {}, maxDropHeight: 200 } },
            { field: 'DebitLID', type: 'list', required: true, html: { page: 0, column: 0 }, options: { items: [], selected: {}, maxDropHeight: 200 } },
            { field: 'CreditLID', type: 'list', required: true, html: { page: 0, column: 0 }, options: { items: [], selected: {}, maxDropHeight: 200 } },
            { field: 'Description', type: 'text', required: false, html: { page: 0, column: 0} },
            { field: 'DtStart', type: 'date', required: true, html: { page: 0, column: 0 } },
            { field: 'DtStop', type: 'date', required: true, html: { page: 0, column: 0 } },
            { field: 'PriorToRAStart', type: 'checkbox', required: true, html: { page: 0, column: 0 } },
            { field: 'PriorToRAStop', type: 'checkbox', required: true, html: { page: 0, column: 0 } },
        ],
        toolbar: {
            items: [
                { id: 'btnNotes', type: 'button', icon: 'fa fa-sticky-note-o' },
                { id: 'bt3', type: 'spacer' },
                { id: 'btnClose', type: 'button', icon: 'fa fa-times' },
            ],
            onClick: function (event) {
                switch(event.target) {
                case 'btnClose':
                    w2ui.toplayout.hide('right',true);
                    w2ui.toplayout.render();
                    break;
                }
            },
        },
        onValidate: function(event) {
            if (this.record.DtStart === '') {
                event.errors.push({
                    field: this.get('DtStart'),
                    error: 'Start date cannot be blank'
                });
            }
            if (this.record.DtStop === '') {
                event.errors.push({
                    field: this.get('DtStop'),
                    error: 'Stop date cannot be blank'
                });
            }
        },
        actions: {
            delete: function() {

                var form = this;

                w2confirm(delete_confirm_options)
                .yes(function () {
                    var tgrid = w2ui.arsGrid;
                    var sel = tgrid.getSelection();
                    tgrid.unselect(sel);

                    var params = {cmd: 'delete', formname: form.name, ARID: form.record.ARID };
                    var dat = JSON.stringify(params);

                    // delete AR request
                    $.post(form.url, dat)
                    .done(function(data) {
                        if (data.status != "success") {
                            return;
                        }
                        w2ui.toplayout.hide('right',true);
                        w2ui.toplayout.render();
                        tgrid.reload();
                    })
                    .fail(function(/*data*/){
                        console.log("Delete AR failed.");
                    });
                })
                .no(function () {
                    return;
                });
            },
            save: function () {
                //var obj = this;
                var tgrid = w2ui.arsGrid;
                var sel = tgrid.getSelection();
                tgrid.unselect(sel);
                this.save({}, function (data) {
                    if (data.status == 'error') {
                        console.log('ERROR: '+ data.message);
                        return;
                    }
                    w2ui.toplayout.hide('right',true);
                    w2ui.toplayout.render();
                    tgrid.reload();
                });
            },
        },
        onSubmit: function(target, data){
            console.log("arsForm POST data");
            // object to value before submit to server
            data.postData.record.PriorToRAStart = int_to_bool(data.postData.record.PriorToRAStart);
            data.postData.record.PriorToRAStop = int_to_bool(data.postData.record.PriorToRAStop);
            delete data.postData.record.CreditLedgerName;
            delete data.postData.record.DebitLedgerName;
            console.log(data.postData.record);
        },
        onRefresh: function(/*event*/) {
            var f = w2ui.arsForm;
            var r = f.record;
            if (r.ARID) {
                f.header = 'Edit Account Rule' + ' (' + r.ARID + ')';
                isNewFormRecord(f.name, false);
            } else {
                f.header = 'Edit Account Rule (new)';
                isNewFormRecord(f.name, true);
            }

        }
    });

}  // buildPageElements


function saveNewRAPayor() {
    "use strict";

    var rec = {
        recid: w2ui.rapGrid.records.length,                 // + 1
        BID: w2ui.rentalagrForm.record.BID,                 // BID of RAID we're editing
        TCID: w2ui.tcidRAPayorPicker.record.TCID,           // The TCID from the person picked
        RAID: w2ui.rentalagrForm.record.RAID,               // the RAID we're editing
        FirstName: w2ui.tcidRAPayorPicker.record.FirstName, // ignored
        MiddleName: "",                                     // ignored
        LastName: w2ui.tcidRAPayorPicker.record.LastName,   // ignored
        IsCompany: w2ui.tcidRAPayorPicker.record.IsCompany,
        CompanyName: w2ui.tcidRAPayorPicker.record.CompanyName,   // ignored
        DtStart: w2ui.tcidRAPayorPicker.record.DtStart, // start
        DtStop: w2ui.tcidRAPayorPicker.record.DtStop,                  // end
    };
    var params = {cmd: 'save', formname: 'tcidRAPayorPicker', record: rec };
    var dat = JSON.stringify(params);

    $.post(w2ui.rapGrid.url, dat)
    .done(function(data) {
        if (typeof data == 'string') {  // it's weird, a successful data add gets parsed as an object, an error message does not
            var msg = JSON.parse(data);
            w2ui.rapGrid.message(msg.message);
            return;
        }
        if (data.status == 'success') {
            rec.recid = data.recid; // success reply returns RAPID of record just added
            w2ui.rapGrid.add(rec,true);
        } else {
            w2ui.rapGrid.message(data.message);
        }
    })
    .fail(function(data) {
        console.log('data = ' + data);
    });

}

function popupTcidRAPayorPicker(sTitle,bid) {
    "use strict";
    app.TcidRAPayorPicker = {BID: bid, Title: sTitle};  // used by tcidRAPayorPicker form
    var y = new Date();
    var ny = new Date(y.getFullYear() + 1, y.getMonth(), y.getDate(), 0, 0, 0);
    w2ui.tcidRAPayorPicker.record.DtStart = w2uiDateControlString(y);
    w2ui.tcidRAPayorPicker.record.DtStop = w2uiDateControlString(ny);
    w2ui.tcidRAPayorPicker.record.TCID = -1;
    w2ui.tcidRAPayorPicker.record.pickedName = '';
    w2ui.tcidRAPayorPicker.record.IsCompany = -1;
    w2ui.tcidRAPayorPicker.record.CompanyName = '';
    w2ui.tcidRAPayorPicker.refresh();
    var raid = w2ui.rentalagrForm.record.RAID;
    $().w2popup('open', {
        title   : 'Add New ' + sTitle + ' to RA0'+raid,
        body    : '<div id="form" style="width: 100%; height: 100%;"></div>',
        style   : 'padding: 15px 0px 0px 0px',
        width   : 400,
        height  : 200,
        showMax : true,
        onToggle: function (event) {
            $(w2ui.tcidRAPayorPicker.box).hide();
            event.onComplete = function () {
                $(w2ui.tcidRAPayorPicker.box).show();
                w2ui.tcidRAPayorPicker.resize();
            };
        },
        onOpen: function (event) {
            event.onComplete = function () {
                // specifying an onOpen handler instead would be equivalent to specifying
                // an onBeforeOpen handler, which would make this code execute too
                // early and hence not deliver.
                $('#w2ui-popup #form').w2render('tcidRAPayorPicker');
            };
        }
    });
}

function popupRidRentablePicker(sTitle,bid) {
    "use strict";
    app.ridRentablePicker = {BID: bid, Title: sTitle};  // used by RidRentablePicker form
    var y = new Date();
    var ny = new Date(y.getFullYear() + 1, y.getMonth(), y.getDate(), 0, 0, 0);
    w2ui.ridRentablePicker.record.DtStart = w2uiDateControlString(y);
    w2ui.ridRentablePicker.record.DtStop = w2uiDateControlString(ny);
    w2ui.ridRentablePicker.record.TCID = -1;
    w2ui.ridRentablePicker.record.RentableName = '';
    w2ui.ridRentablePicker.record.Amount = '';
    w2ui.ridRentablePicker.refresh();
    var raid = w2ui.rentalagrForm.record.RAID;
    $().w2popup('open', {
        title   : 'Add New ' + sTitle + ' to RA0' + raid,
        body    : '<div id="form" style="width: 100%; height: 100%;"></div>',
        style   : 'padding: 15px 0px 0px 0px',
        width   : 400,
        height  : 240,
        showMax : true,
        onToggle: function (event) {
            $(w2ui.ridRentablePicker.box).hide();
            event.onComplete = function () {
                $(w2ui.ridRentablePicker.box).show();
                w2ui.ridRentablePicker.resize();
            };
        },
        onOpen: function (event) {
            event.onComplete = function () {
                // specifying an onOpen handler instead would be equivalent to specifying
                // an onBeforeOpen handler, which would make this code execute too
                // early and hence not deliver.
                $('#w2ui-popup #form').w2render('ridRentablePicker');
            };
        }
    });
}

function saveNewRUser() {
    "use strict";

    var myRID = -1;
    var rname = w2ui.tcidRUserPicker.record.RentableName.text;
    var url = '/v1/ruser/';
    for (var i = 0; i < app.TcidRUserPicker.RAR.records.length; i++) {
        if (app.TcidRUserPicker.RAR.records[i].RentableName == rname) {
            myRID = app.TcidRUserPicker.RAR.records[i].RID;
            url += '' + app.TcidRUserPicker.RAR.records[i].BID + '/' + myRID;
        }
    }
    if (myRID < 1) {
        console.log('RID = ' + myRID);
        return;
    }
    var rec = {
        recid: w2ui.rapGrid.records.length,                 // + 1
        BID: w2ui.rentalagrForm.record.BID,                 // BID of RID we're editing
        TCID: w2ui.tcidRUserPicker.record.TCID,           // The TCID from the person picked
        RID: myRID,                                         // the selected RID
        RentableName: rname,                                // the name of the rentable
        FirstName: w2ui.tcidRUserPicker.record.FirstName, // ignored
        MiddleName: "",                                     // ignored
        LastName: w2ui.tcidRUserPicker.record.LastName,   // ignored
        IsCompany: w2ui.tcidRUserPicker.record.IsCompany,
        CompanyName: w2ui.tcidRUserPicker.record.CompanyName,
        DtStart: w2ui.tcidRUserPicker.record.DtStart,                  // start
        DtStop: w2ui.tcidRUserPicker.record.DtStop,                  // end
    };
    var params = {cmd: 'save', formname: 'tcidRUserPicker', record: rec };
    var dat = JSON.stringify(params);

    // save the record to the server, insert into grid if successful
    $.post(url, dat)
    .done(function(data) {
        if (typeof data == 'string') {  // it's weird, a successful data add gets parsed as an object, an error message does not
            var msg = JSON.parse(data);
            w2ui.rauGrid.message(msg.message);
            return;
        }
        if (data.status == 'success') {
            rec.recid = data.recid; // success reply returns RUID of record just added
            w2ui.rauGrid.add(rec,true);
        } else {
            w2ui.rauGrid.message(data.message);
        }
    })
    .fail(function(data) {
        console.log('data = ' + data);
    });
}

function saveNewRARentable() {
    "use strict";
    var rec = {
        recid: 0,                                                   // new
        BUI: w2ui.rentalagrForm.record.BID.text,                         // BID of RID we're editing
        RAID: w2ui.rentalagrForm.record.RAID,                       // The RAID from the form being edited
        RID: w2ui.ridRentablePicker.record.RID,                     // the selected RID
        RentableName: w2ui.ridRentablePicker.record.RentableName[0].RentableName,   // the name of the rentable
        RARDtStart: w2ui.ridRentablePicker.record.DtStart,          // start
        RARDtStop: w2ui.ridRentablePicker.record.DtStop,            // end
        ContractRent: w2ui.ridRentablePicker.record.Amount,         // end
    };
    var params = {cmd: 'save', formname: 'ridRentablePicker', record: rec };
    var dat = JSON.stringify(params);

    // save the record to the server, insert into grid. We need the
    // RARID of the record just saved so that we can store it along
    // with the rest of the record information that we insert into the grid.
    // We pick this up in the "success" return information
    var url = '/v1/rar/' + rec.BUI + '/' + rec.RAID;
    $.post(url, dat)
    .done(function(data) {
        if (typeof data == 'string') {  // it's weird, a successful data add gets parsed as an object, an error message does not
            var msg = JSON.parse(data);
            w2ui.rarGrid.message(msg.message);
            return;
        }
        if (data.status == 'success') {
            rec.recid = data.recid; // success reply returns RARID of record just added
            w2ui.rarGrid.add(rec,true);
        } else {
            w2ui.rarGrid.message(data.message);
        }
    })
    .fail(function(data) {
        console.log('data = ' + data);
    });
}

function popupTcidRUserPicker(sTitle,bid,raid) {
    "use strict";
    app.TcidRUserPicker = {BID: bid, Title: sTitle, RAID: raid, RARentablesNames: [], RAR: []};  // used by tcidRUserPicker form
    var y = new Date();
    var ny = new Date(y.getFullYear() + 1, y.getMonth(), y.getDate(), 0, 0, 0);
    w2ui.tcidRUserPicker.record.DtStart = w2uiDateControlString(y);
    w2ui.tcidRUserPicker.record.DtStop = w2uiDateControlString(ny);
    w2ui.tcidRUserPicker.record.TCID = -1;
    w2ui.tcidRUserPicker.record.pickedName = '';
    w2ui.tcidRUserPicker.record.IsCompany = -1;
    w2ui.tcidRUserPicker.record.CompanyName = '';
    w2ui.tcidRUserPicker.refresh();
    var url = '/v1/rar/' + bid + '/' + raid;
    $.get(url,function(data,status) {
        if (status != "success") {
            console.log('>>>>>>>>>>>>>>>  status = ' + status);
            return;
        }
        app.TcidRUserPicker.RAR = JSON.parse(data);
        for (var i = 0; i < app.TcidRUserPicker.RAR.records.length; i++) {
            app.TcidRUserPicker.RARentablesNames.push(app.TcidRUserPicker.RAR.records[i].RentableName);
        }
    });
    $().w2popup('open', {
        title   : 'Add A New ' + sTitle,
        body    : '<div id="form" style="width: 100%; height: 100%;"></div>',
        style   : 'padding: 15px 0px 0px 0px',
        width   : 400,
        height  : 250,
        showMax : true,
        onToggle: function (event) {
            $(w2ui.tcidRUserPicker.box).hide();
            event.onComplete = function () {
                $(w2ui.tcidRUserPicker.box).show();
                w2ui.tcidRUserPicker.resize();
            };
        },
        onOpen: function (event) {
            event.onComplete = function () {
                // specifying an onOpen handler instead would be equivalent to specifying
                // an onBeforeOpen handler, which would make this code execute too
                // early and hence not deliver.
                $('#w2ui-popup #form').w2render('tcidRUserPicker');
            };
        }
    });
}

function popupRentalAgrPicker() {
    "use strict";
    var x = getCurrentBusiness();
    app.RentalAgrFinder = {BID: x.value, RAID: 0, TCID: 0, RID: 0, FirstName: '', LastName: '', CompanyName: '', IsCompany: false, RAR: [], RARentablesNames: []};
    app.RentalAgrFinder.RARentablesNames = [{id: 0, text:" "}];
    w2ui.rentalAgrFinder.fields[2].options.items = app.RentalAgrFinder.RARentablesNames;
    w2ui.rentalAgrFinder.record.TCID = -1;
    w2ui.rentalAgrFinder.record.RAID = -1;
    w2ui.rentalAgrFinder.record.PayorName = '';
    w2ui.rentalAgrFinder.record.IsCompany = -1;
    w2ui.rentalAgrFinder.record.CompanyName = '';
    w2ui.rentalAgrFinder.record.FirstName = '';
    w2ui.rentalAgrFinder.record.LastName = '';
    w2ui.rentalAgrFinder.refresh();


    $().w2popup('open', {
        title   : 'Find Rental Agreement',
        body    : '<div id="form" style="width: 100%; height: 100%;"></div>',
        style   : 'padding: 15px 0px 0px 0px',
        width   : 400,
        height  : 250,
        showMax : true,
        onToggle: function (event) {
            $(w2ui.rentalAgrFinder.box).hide();
            event.onComplete = function () {
                $(w2ui.rentalAgrFinder.box).show();
                w2ui.rentalAgrFinder.resize();
            };
        },
        onOpen: function (event) {
            event.onComplete = function () {
                // specifying an onOpen handler instead would be equivalent to specifying
                // an onBeforeOpen handler, which would make this code execute too
                // early and hence not deliver.
                $('#w2ui-popup #form').w2render('rentalAgrFinder');
            };
        }
    });
}

function createRentalAgreementForm() {
    "use strict";
    w2ui.raLayout.content('left', w2ui.rentalagrForm);
    w2ui.raLayout.content('main', w2ui.raLayoutSub1);

    w2ui.raLayoutSub1.content('top', w2ui.rarGrid);
    w2ui.rarGrid.header = plural(app.sRentable);
    w2ui.raLayoutSub1.content('main', w2ui.rapGrid);
    w2ui.rapGrid.header = plural(app.sPayor);

    w2ui.raLayoutSub1.content('preview', w2ui.rauGrid);
    w2ui.rauGrid.header = plural(app.sUser);
    w2ui.raLayoutSub1.content('bottom', w2ui.raPetGrid);
    w2ui.raPetGrid.header = "Pets";
}



function finishInitialization() {
    "use strict";
    defineDateFmts();
    buildPageElements();
    createRentalAgreementForm();
    var d1 = new Date();
    d1.setDate(1);
    app.D1 = dateControlString(d1);
    var d2 = dateMonthFwd(d1);
    app.D2 = dateControlString(d2);
}

$(function () {
    "use strict";
    $.get('/v1/uilists/' + app.language + '/' + app.template)
    .done(function(data, textStatus, jqXHR) {

        if (data.substring(11,14) == "err") {
            console.log('ERROR: '+data);
        }

        // if status is success then
        if (jqXHR.status == 200) {
            var app_data = JSON.parse(data);
            // fit all lists, values, maps in app variable
            for( var key in app_data ) {
                app[key] = app_data[key];
            }
        } else {
            console.log( '**** YIPES! ****  status on /v1/uilists/ = ' + textStatus);
        }

        // finish initialization
        finishInitialization();

    })
    .fail( function() {
        console.log('Error getting /v1/uilists');
    });

});

</script>

<div id="layout"style="position: absolute; top: 0px; left: 0px; bottom: 0px; right: 0px;"></div>

</body>
</html>
