<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="/js/w2ui-1.5.rc1.min.css" />
    <script src="/js/jquery.min.js"></script>
    <script src="/js/w2ui-1.5.rc1.js"></script>
    <link rel="stylesheet" href="/html/fa/css/font-awesome.min.css">
    <script src="/js/rutil.js"></script>
    <link rel="icon" type="image/png" href="/html/images/favicon32x32.png">
</head>
<body>

<!--  color Icon images:  icon-page, w2ui-icon-check, ... see below in toptoolbar -->
<!--

mainlayout    - w2ui layout toptoolbar, toplayout, footer
toplayout     - w2ui layout for sidebar, main, and right (Detail)
reportslayout - w2ui layout for reports, main for reports, and top for toolbar
toptoolbar    - w2ui toolbar
sidebarL1     - w2ui sidebar

-->

<script>
/*global
    w2ui, console, plural, monthBack, monthFwd, dayBack, dayFwd, setToRAForm, setToForm,
    w2uiDateControlString, w2popup, getCurrentBusiness, dateControlString, dateMonthFwd,
    tcidPickerDropRender, tcidRAPayorPickerRender, tcidPickerCompare,
*/

/*globals $:false */

// my app object in which to manage key data
var app = {
    D1: "2016-02-01",
    D2: "2016-03-01",
    uid: 211,
    lastCmd: '',
    TcidRAPayorPicker: {BID: 0},
    TcidRUserPicker: {BID: 0, Title: '', RAID: 0, RARentablesNames: [], RAR: []},
    language: "{{.Language}}",
    template: "{{.Template}}",
    pstyle: 'border: 1px solid #dfdfdf; padding: 0px;',
    pstyleNB: 'border: 0px solid #dfdfdf; padding: 0px;',
    pstyle4: 'border: 1px solid #bbbbbb; padding: 0px;',
    pstyle2: 'border: 1px solid #cfcfcf; padding: 0px;',
    prefmt: 'font-family: "Monaco", "Menlo", "Source Code Pro", monospace; white-space: pre; font-size: 9pt; background-color: white;',
    bgyellow: 'background-color: yellow;',
    stdfmt: 'font-family: "Open Sans","Roboto",sans-serif; font-size: 9pt; border-spacing:5px; padding: 5px; color: #777777;',
};


function showReport(rptname) {
    "use strict";
    var x = getCurrentBusiness();
    var userid = 211;
    var url = '/wsvc/' + userid + '/' + x.value + '?r=' + rptname;
    w2ui.toplayout.content('main', w2ui.reportslayout);
    w2ui.toplayout.hide('right',true);
    var y = document.getElementsByName("dateD1");
    var d = y[0].value;
    app.D1 = d;
    url += '&dtstart=' + d;
    //console.log('d1 = ' + d);
    y = document.getElementsByName("dateD2");
    d = y[0].value;
    app.D2 = d;
    // console.log('d2 = ' + d);
    url += '&dtstop=' + d;
    console.log('url = ' + url);
    w2ui.reportslayout.load('main', url);
}


// // urlPrefix returns the standard for values for the web services
// // url ending:  <userid>/<business id>
// function urlSuffix() {
//     "use strict";
//     user = "211"; // hardcoded for now
//     return user+x[0].value;
// }

// ChangeBusiness updates the UI to the newly selected business
function ChangeBusiness() {
    "use strict";
    w2ui.toplayout.content('main', ' ');
    w2ui.toplayout.hide('right',true);
    var s = w2ui.sidebarL1;
    var sel = s.selected;
    if (sel !== null) { 
        s.unselect(sel);
    }
    w2ui.reportslayout.load('main','/html/blank.html');
    app.lastCmd = '';
    s.collapse('reports');
    s.collapse('admin');
}

function switchToGrid(svc) {
    "use strict";
    var grid = svc + 'Grid'; // this builds the name of the w2ui grid we want
    var x = getCurrentBusiness();
    var url = '/v1/' + svc + '/' + x.value;
    w2ui[grid].url = url;
    console.log('url = ' + url);
    w2ui.toplayout.content('main', w2ui[grid]);
    w2ui.toplayout.hide('right',true);
}

function defineDateFmts() {
    "use strict";
    var month = (new Date()).getMonth() + 1;
    var year  = (new Date()).getFullYear();
    // // US Format
    $('input[type=us-date]').w2field('date', { format: 'm/d/yyy' });
    $('input[type=us-dateA]').w2field('date', { format: 'm/d/yyyy', start:  month + '/5/' + year, end: month + '/25/' + year });
    $('input[type=us-dateB]').w2field('date', { format: 'm/d/yyyy', blocked: [ month+'/12/2014',month+'/13/2014',month+'/14/' + year,]});
    $('input[type=us-date1]').w2field('date', { format: 'm/d/yyyy', end: $('input[type=us-date2]') });
    $('input[type=us-date2]').w2field('date', { format: 'm/d/yyyy', start: $('input[type=us-date1]') });
    $('input[type=us-time]').w2field('time',  { format: 'h12' });
    $('input[type=us-timeA]').w2field('time', { format: 'h12', start: '8:00 am', end: '4:30 pm' });

    // EU Common Format
    $('input[type=eu-date]').w2field('date',  { format: 'd.m.yyyy' });
    $('input[type=eu-dateA]').w2field('date', { format: 'd.m.yyyy', start:  '5.' + month + '.' + year, end: '25.' + month + '.' + year });
    $('input[type=eu-dateB]').w2field('date', { format: 'd.m.yyyy', blocked: ['12.' + month + '.' + year, '13.' + month + '.' + year, '14.' + month + '.' + year]});
    $('input[type=eu-date1]').w2field('date', { format: 'd.m.yyyy', end: $('input[type=eu-date2]') });
    $('input[type=eu-date2]').w2field('date', { format: 'd.m.yyyy', start: $('input[type=eu-date1]') });
    $('input[type=eu-time]').w2field('time',  { format: 'h24' });
    $('input[type=eu-timeA]').w2field('time', { format: 'h24', start: '8:00 am', end: '4:30 pm' });
}

// The reason to load these elements in this way rather than storing them as part of a
// 'config' variable then passing them into the widget generators is that we need to
// download the lists first. Making the elements part of a config.* variable would evaluate
// the dropdown lists prior to downloading their values. By doing it this way, we download
// the lists first so that their values will be set by the server before we build the UI.
function buildPageElements() {
    "use strict";
    //------------------------------------------------------------------------
    //          mainlayout
    //------------------------------------------------------------------------
    $('#layout').w2layout({
        name: 'mainlayout',
        padding: 2,
        panels: [
            { type: 'top', size: 55, style: app.pstyle, content: 'top' },
            { type: 'left', size: 200, hidden: true, style: app.pstyle, content: 'left' },
            { type: 'main', style: app.pstyle, content: 'main' },
            { type: 'preview', size: '50%', resizable: true, hidden: true, style: app.pstyle, content: 'preview' },
            { type: 'right', size: 200, resizable: true, style: app.pstyle, hidden: true, content: 'Details' },
            { type: 'bottom', size: 23, resizable: true, style: app.stdfmt, content: '&copy; 2015-2016 Accord Interests' }
        ]
    });


    //------------------------------------------------------------------------
    //          NEWS LAYOUT
    //------------------------------------------------------------------------
    $().w2layout({
        name: 'newsLayout',
        padding: 0,
        panels: [
            { type: 'left', hidden: false, style: app.pstyleNB, size: 20 },
            { type: 'top', hidden: true },
            { type: 'main', size: '90%', resizable: true, hidden: false, style: app.pstyleNB, content: 'Hi.  I should load w2ui.newsLayout' },
            { type: 'preview', hidden: true },
            { type: 'bottom', hidden: true },
            { type: 'right', hidden: true }
        ]
    });

    //------------------------------------------------------------------------
    //          toplayout
    //------------------------------------------------------------------------
    w2ui.mainlayout.content('main', $().w2layout({
        name: 'toplayout',
        padding: 2,
        panels: [
            { type: 'top',     size: 200, style: app.pstyle2,  hidden: true, resizable: true, content: w2ui.newsLayout},
            { type: 'left',    size: 200, style: app.pstyle2,                resizable: true, content: 'sidebar' },
            { type: 'main',               style: app.pstyle2   },
            { type: 'preview', size: 0,   style: app.bgyellow, hidden: true, resizable: true, content: 'preview' },
            { type: 'right',   size: 200, style: app.pstyle2,  hidden: true, resizable: true },
            { type: 'bottom',  size: 0,   style: app.pstyle2,  hidden: true, resizable: true, content: 'toplayout - bottom' }
        ]
    }));
    
    //------------------------------------------------------------------------
    //          toptoolbar
    //------------------------------------------------------------------------
    w2ui.mainlayout.content('top', $().w2toolbar({
        name: 'toptoolbar',
        items: [
             { type: 'html',  id: 'logo',
                html: '<div style="padding: 4px 0px;">'+
                      '<img src="/html/images/logo.png">'+
                      '</div>' 
            },
            { type: 'break', id: 'break1' },
            { type: 'menu',    id: 'moduleMenu', caption: 'Select Module',    icon: 'fa fa-sitemap', items: [
                { text: 'Directory',          icon: 'fa fa-user' }, 
                { text: 'RentRoll',           icon: 'fa fa-building-o' }, 
                { text: 'Forms & Procedures', icon: 'fa fa-book' }, 
            ]},
             { type: 'html',  id: 'BUD',
                html: //'<div style="background-color: #eee; padding: 10px 5px; border-bottom: 1px solid silver">'+
                    '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<i class="fa fa-building-o"></i> &nbsp;' + app.sBusinessUnit +
                    ': <select name="BusinessSelect" onchange="ChangeBusiness()">'+
                    '{{range .BL}}<option value="{{.BID}}">{{.Designation}}</option>{{end}}'+
                    '</select>&nbsp;&nbsp;&nbsp;' //+ '</div>'
            },
            { type: 'break', id: 'break2' },
            { type: 'button', id: 'msgButton', caption: 'News Flash', /*icon: 'fa fa-newspaper-o'*/ icon: 'fa fa-spinner fa-pulse fa-3x fa-fw'},
            { type: 'menu',    id: 'menuButton', caption: 'Panels',    icon: 'fa fa-table', items: [
                { text: 'Template-Dflt', icon: 'fa fa-language' }, 
                { text: 'Template-Apts', icon: 'fa fa-language' }, 
                { text: 'Messages', icon: 'fa fa-folder-o' }, 
            ]},
        ],
        onClick: function (event) {
            console.log('target = ' + event.target);
            switch(event.target) {
                case "moduleMenu:Directory":      window.location.href = 'https://directory.airoller.com/'; break;
                case "menuButton:Template-Dflt":  window.location.href = '/home/en-us/default'; break;
                case "menuButton:Template-Apts":  window.location.href = '/home/en-us/apts';    break;
                case "moduleMenu:RentRoll":       window.location.href = '/';                   break;
                case "menuButton:Sidebar":        w2ui.toplayout.toggle('left',true);           break;
                case "menuButton:mainLayoutMain": w2ui.mainlayout.toggle('main',true);          break;
                case "menuButton:Preview":        w2ui.toplayout.toggle('preview',true);        break;
                case "menuButton:Details":        w2ui.toplayout.toggle('right',true);          break;
                case "menuButton:Footer":         w2ui.mainlayout.toggle('bottom',true);        break;
                case "menuButton:topLayoutMain":  w2ui.toplayout.toggle('main',true);           break;

                case "msgButton":
                case "menuButton:Messages":
                        w2ui.toplayout.toggle('top',true); 
                        w2ui.toplayout.set('top',{ content: w2ui.newsLayout});     
                        w2ui.newsLayout.load('main', '/html/news.html', 'flip-down', function () {console.log('content loaded');});
                        w2ui.toptoolbar.set('msgButton', {icon: 'fa fa-newspaper-o'});
                        break;
            }
        },
    }));

    //------------------------------------------------------------------------
    //          sidebarL1
    //------------------------------------------------------------------------
    w2ui.toplayout.content('left',$().w2sidebar({
        name: 'sidebarL1',
        nodes: [
            { id: 'main', text: 'Main', img: 'icon-folder', expanded: true, group: true,
                nodes: [  { id: 'rentables', text: plural(app.sRentable), icon: 'fa fa-cube' },
                        { id: 'transactants', text: plural(app.sTransactant), icon: 'fa fa-users' },
                        { id: 'rentalagrs',  text: plural(app.sRentalAgreement),  icon: 'fa fa-certificate', hint: 'Rental Agreements' },
                        { id: 'asms',  text: plural(app.sAssessment),  icon: 'fa fa-star-o', hint: plural(app.sAssessment) },
                        { id: 'receipts',  text: plural(app.sReceipt),  icon: 'fa fa-star', hint: plural(app.sReceipt) },
                        { id: 'goRatePlan',  text: 'Rate Plan',  icon: 'fa fa-money', hint: 'RatePlan' },
                        { id: 'goServiceMenu',  text: 'Service',  icon: 'fa fa-user', hint: 'Service' },
                ]
            },
            { id: 'reports', text: 'Reports', img: 'icon-folder', expanded: false, group: true,
                nodes: [ 
                       { id: 'asmrpt', text: 'Assessments', icon: 'fa fa-file-text-o' },
                       { id: 'b', text: 'Business Units', icon: 'fa fa-file-text-o' },
                       { id: 'coa', text: 'Chart Of Accounts', icon: 'fa fa-file-text-o' },
                       { id: 'dpm', text: 'Deposit Methods', icon: 'fa fa-file-text-o' },
                       { id: 'dep', text: 'Depositories', icon: 'fa fa-file-text-o' },
                       { id: 'delinq', text: 'Delinquency', icon: 'fa fa-file-text-o' },
                       { id: 'gsr', text: 'GSR', icon: 'fa fa-file-text-o' },
                       { id: 'j', text: 'Journal', icon: 'fa fa-file-text-o' },
                       { id: 'l', text: 'Ledger', icon: 'fa fa-file-text-o' },
                       { id: 'la', text: 'Ledger Activity', icon: 'fa fa-file-text-o' },
                       { id: 'people', text: 'People', icon: 'fa fa-file-text-o' },
                       { id: 'pmt', text: 'Payment Types', icon: 'fa fa-file-text-o' },
                       { id: 'rcpt', text: 'Receipts', icon: 'fa fa-file-text-o' },
                       { id: 'rcbt', text: 'Rentable Type Counts', icon: 'fa fa-file-text-o' },
                       { id: 'r', text: plural(app.sRentable), icon: 'fa fa-file-text-o' },
                       { id: 'ra', text: 'Rental Agreements', icon: 'fa fa-file-text-o' },
                       { id: 'rat', text: 'Rental Agreement Templates', icon: 'fa fa-file-text-o' },
                       { id: 'rt', text: 'Rentable Types', icon: 'fa fa-file-text-o' },
                       { id: 'rr', text: 'RentRoll', icon: 'fa fa-file-text-o' },
                       { id: 'statements', text: 'Statements', icon: 'fa fa-file-text-o' },
                       { id: 'sl', text: 'String Lists', icon: 'fa fa-file-text-o' },
                       { id: 'tb', text: 'Trial Balance', icon: 'fa fa-file-text-o' },
                ]
            },
            { id: 'admin', text: 'Admin', img: 'icon-wrench', expanded: false, group: true,
                nodes: [ 
                    { id: 'accounts', text: 'Chart Of Accounts', icon: 'fa fa-folder-o' },
                ]
            },
        ],
        onExpand: function(event) {
            //var x = getCurrentBusiness();
            //console.log('current biz = ' + x.value + '  name = ' + x.name );
            switch (event.target) {
                case 'reports':
                    var w = w2ui.reportslayout;
                    w2ui.toplayout.content('main', w);
                    w2ui.toplayout.hide('right',true);
                    break;
            }

        },
        onFlat: function (event) {
            console.log('event.goFlat = ' + event.goFlat );
            $('#sidebarL1').css('width', (event.goFlat ? '35px' : '200px'));
        },
        onClick: function (event) {
            console.log('event.target = ' + event.target);
            switch(event.target) {
                case 'accounts':
                case 'rentables':
                case 'transactants':
                case 'rentalagrs':
                case 'receipts':
                case 'asms':
                    switchToGrid(event.target);
                    break;
                case 'asmrpt':
                case 'b':
                case 'coa':
                case 'delinq':
                case 'dep':
                case 'dpm':
                case 'gsr':
                case 'j':
                case 'l':
                case 'la':
                case 'people':
                case 'pmt':
                case 'r':
                case 'ra':
                case 'rat':
                case 'rcbt':  // rentable count by type
                case 'rcpt':
                case 'rr':
                case 'rt':
                case 'sl':
                case 'statements':
                case 'tb':
                    showReport(event.target);
                    app.lastCmd = event.target;
                    break;

                default:
                    console.log('unhandled event: ' + event.target);
            }
        }
    }));

    //------------------------------------------------------------------------
    //          reportslayout
    //------------------------------------------------------------------------
    $().w2layout({
        name: 'reportslayout',
        padding: 0,
        panels: [
            { type: 'top',size: 40, content: 'reports toolbar'},
            { type: 'left', size: 20, style: app.prefmt, hidden: false },
            { type: 'main',  size: 100, style: app.prefmt},
            { type: 'preview', size: 0, hidden: true, content: 'reports preview' },
            { type: 'right', size: 200, hidden: true, content: 'reports - detail' },
            { type: 'bottom', size: 20, hidden: true, content: 'reports - bottom' },
        ]
    });

    
    //------------------------------------------------------------------------
    //          reportstoolbar
    //------------------------------------------------------------------------
    w2ui.reportslayout.content('top', $().w2toolbar({
        name: 'reportstoolbar',
        items: [
            { type: 'break', id: 'break1' },
            { type: 'button',  id: 'monthback', icon: 'fa fa-backward', tooltip: 'month back' },
            { type: 'button',  id: 'dayback', icon: 'fa fa-chevron-left', tooltip: 'day back' },
            { type: 'html',    id: 'reportsD1', html: function () {
                    var html =
                      '<div style="padding: 3px 10px;">'+
                      ' Start: <input type="date" name="dateD1">'+
                      '</div>';
                    return html;
                }
            },
            { type: 'html',    id: 'reportsD2', html: function () {
                    var html =
                      '<div style="padding: 3px 10px;">'+
                      ' Stop: <input type="date" name="dateD2">'+
                      '</div>';
                    return html;
                }
            },
            { type: 'button',  id: 'dayfwd', icon: 'fa fa-chevron-right', tooltip: 'day forward' },
            { type: 'button',  id: 'monthfwd', icon: 'fa fa-forward', tooltip: 'month forward' },
            { type: 'break', id: 'break2' },
            { type: 'button',  id: 'csvexport', icon: 'fa fa-table', tooltip: 'export to csv' },
            { type: 'button',  id: 'printreport', icon: 'fa fa-print', tooltip: 'print' },
        ],
        onClick: function (event) {
            var xd1 = document.getElementsByName("dateD1")[0];
            var xd2 = document.getElementsByName("dateD2")[0];

            switch (event.target) {
            case 'monthback':
                app.D1 = monthBack(xd1);
                app.D2 = monthBack(xd2);
                break;
            case 'monthfwd':
                app.D1 = monthFwd(xd1);
                app.D2 = monthFwd(xd2);
                break;
            case 'dayback':
                app.D1 = dayBack(xd1);
                app.D2 = dayBack(xd2);
                break;
            case 'dayfwd':
                app.D1 = dayFwd(xd1);
                app.D2 = dayFwd(xd2);
                break;
            }
            showReport(app.lastCmd);
        },
        onRefresh: function (event) {
            if (event.target == 'monthfwd') {  // we do these tasks after monthfwd is refreshed so we know that the 2 date controls exist
                var x = document.getElementsByName("dateD1");
                x[0].value = app.D1;
                x = document.getElementsByName("dateD2");
                x[0].value = app.D2;
            }
        }
    }));

    //------------------------------------------------------------------------
    //          accountsGrid
    //------------------------------------------------------------------------
    $().w2grid({
        name: 'accountsGrid',
        url: '/v1/GLAccounts',
        show: {
            header: false,
            toolbar: true,
            footer: true,
            searches: true,
            lineNumbers: false,
            selectColumn: false,
            expandColumn: false
        },        
        columns: [
            {field: 'recid',    caption: 'recid', size: '40px', sortable: true},
            {field: 'LID',      caption: 'LID', size: '50px', sortable: true},
            {field: 'PLID',     caption: 'PLID', size: '50px', sortable: true},
            {field: 'BID',      caption: 'BID', size: '40px', sortable: true},
            {field: 'GLNumber', caption: 'GL Number', size: '85px', sortable: true},
            {field: 'Name',     caption: 'Name', size: '10%', sortable: true},
            {field: 'Status',   caption: 'Status', size: '50px', sortable: true},
            {field: 'AcctType', caption: 'AcctType', size: '140px', sortable: true},
        ],
        onSelect:  function(event) {
            console.log(event);
        },
        onClick: function(event) {
            event.onComplete = function () {
                // Object.getOwnPropertyNames(this).forEach(function(val, idx, array) {
                //   console.log(val + ' -> ' + this[val]);
                // });   
                var sel = this.getSelection(true);
                console.log('Current selection is ' + sel );
            };
        }
    });

    //------------------------------------------------------------------------
    //          transactantsGrid
    //------------------------------------------------------------------------
    $().w2grid({ 
        name: 'transactantsGrid', 
        url: '/v1/transactants',
        show: {
            header: false,
            toolbar: true,
            //footer: true,
            lineNumbers: false,
            selectColumn: false,
            expandColumn: false
        },        
        columns: [
            {field: 'TCID',         caption: "TCID",          size: '50px',  sortable: true, style: 'text-align: right', hidden: false},
            {field: 'FirstName',    caption: "First Name",    size: '125px', sortable: true, hidden: false},
            {field: 'MiddleName',   caption: "Middle Name",   size: '20px',  sortable: true, hidden: true},
            {field: 'LastName',     caption: "Last Name",     size: '125px', sortable: true, hidden: false},
            {field: 'CompanyName',  caption: "Company Name",  size: '125px', sortable: true, hidden: true},
            {field: 'PrimaryEmail', caption: "Primary Email", size: '175px', sortable: true, hidden: false},
            {field: 'CellPhone',    caption: "Cell Phone",    size: '100px', sortable: true, hidden: false},
            {field: 'WorkPhone',    caption: "Work Phone",    size: '100px', sortable: true, hidden: false},
        ],
        onClick: function(event) {
            // var sel = this.getSelection(true);
            event.onComplete = function () {
                // var x = this.get; Object.getOwnPropertyNames(x).forEach(function(val, idx, array) { console.log(val + ' -> ' + x[val]); });
                var sel = this.getSelection(true);
                if (sel.length > 0) {
                    for (var i = 0; i < sel.length; ++i) {
                        var ob = this.get(sel[i]);
                        setToForm('transactantForm', '/v1/person/' + ob.BID + '/' + ob.TCID);
                     }
                } else {
                    console.log('*** NO SELECTION FOUND ***   So, select index 0');
                    this.select(1);
                }
            };
        }
    });

    //------------------------------------------------------------------------
    //          transactantForm
    //------------------------------------------------------------------------
    $().w2form({
        name: 'transactantForm',
        style: 'border: 0px; background-color: transparent;',
        header: app.sTransactant + ' Detail',
        url: '/v1/person',
        formURL: '/html/formtc.html',
        fields: [
            { field: 'recid', type: 'int', required: false, html: { caption: 'recid', page: 0, column: 0 } },
            { field: 'FirstName', type: 'text', required: false, html: { caption: 'First Name', page: 0, column: 0 } },
            { field: 'LastName', type: 'text', required: false, html: { caption: 'Last Name', page: 0, column: 0 } },
            { field: 'MiddleName', type: 'text', required: false, html: { caption: 'Middle Name', page: 0, column: 0 } },
            { field: 'PreferredName', type: 'text', required: false, html: { caption: 'Preferred Name', page: 0, column: 0 } },
            { field: 'PrimaryEmail', type: 'email', required: false, html: { caption: 'Primary Email', page: 0, column: 0 } },
            { field: 'TCID', type: 'int', required: false, html: { caption: 'TCID', page: 0, column: 0 } },
            { field: 'BID', type: 'list', options: {items: app.businesses}, required: false, html: { caption: 'BID', page: 0, column: 0 } },
            { field: 'NLID', type: 'int', required: false, html: { caption: 'NLID', page: 0, column: 0 } },
            { field: 'CompanyName', type: 'text', required: false, html: { caption: 'Company Name', page: 0, column: 0 } },
            { field: 'IsCompany', type: 'list', options: {items: app.companyOrPerson}, required: false, html: { caption: 'Person or Company', page: 0, column: 0 } },
            { field: 'SecondaryEmail', type: 'email', required: false, html: { caption: 'Secondary Email', page: 0, column: 0 } },
            { field: 'WorkPhone', type: 'phone', required: false, html: { caption: 'Work Phone', page: 0, column: 0 } },
            { field: 'CellPhone', type: 'phone', required: false, html: { caption: 'Cell Phone', page: 0, column: 0 } },
            { field: 'Address', type: 'text', required: false, html: { caption: 'Address', page: 0, column: 0 } },
            { field: 'Address2', type: 'text', required: false, html: { caption: 'Address 2', page: 0, column: 0 } },
            { field: 'City', type: 'text', required: false, html: { caption: 'City', page: 0, column: 0 } },
            { field: 'State', type: 'list', options: {items: app.usStateAbbr}, required: false, html: { caption: 'State', page: 0, column: 0 } },
            { field: 'PostalCode', type: 'text', required: false, html: { caption: 'Postal Code', page: 0, column: 0 } },
            { field: 'Country', type: 'text', required: false, html: { caption: 'Country', page: 0, column: 0 } },
            { field: 'Website', type: 'text', required: false, html: { caption: 'Website', page: 0, column: 0 } },
            { field: 'LastModTime', type: 'text', required: false, html: { caption: 'LastModTime', page: 0, column: 0 } },
            { field: 'LastModBy', type: 'text', required: false, html: { caption: 'LastModBy', page: 0, column: 0 } },
            { field: 'Points', type: 'text', required: false, html: { caption: 'Points', page: 1, column: 0 } },
            { field: 'DateofBirth', type: 'date', required: false, html: { caption: 'Date of Birth', page: 1, column: 0 } },
            { field: 'EmergencyContactName', type: 'text', required: false, html: { caption: 'Emerg Cntct Name', page: 1, column: 0 } },
            { field: 'EmergencyContactAddress', type: 'text', required: false, html: { caption: 'Emerg Cntct Addr', page: 1, column: 0 } },
            { field: 'EmergencyContactTelephone', type: 'text', required: false, html: { caption: 'Emerg Cntct Tel', page: 1, column: 0 } },
            { field: 'EmergencyEmail', type: 'text', required: false, html: { caption: 'Emergency Email', page: 1, column: 0 } },
            { field: 'AlternateAddress', type: 'text', required: false, html: { caption: 'Alternate Address', page: 1, column: 0 } },
            { field: 'EligibleFutureUser', type: 'list', options: {items: app.yesNoList}, required: false, html: { caption: 'Eligible Future User', page: 1, column: 0 } },
            { field: 'Industry', type: 'text', required: false, html: { caption: 'Industry', page: 1, column: 0 } },
            { field: 'SourceSLSID', type: 'w2int', required: false, html: { caption: 'Source SLSID', page: 1, column: 0 } },
            { field: 'CreditLimit', type: 'w2float', required: false, html: {caption: 'Credit Limit', page: 2, column: 0 } },
            { field: 'TaxpayorID', type: 'text', required: false, html: {caption: 'Taxpayor ID', page: 2, column: 0 } },
            { field: 'AccountRep', type: 'text', required: false, html: {caption: 'Account Rep', page: 2, column: 0 } },
            { field: 'EligibleFuturePayor', type: 'list', options: {items: app.yesNoList}, required: false, html: {caption: 'Eligible Future Payor', page: 2, column: 0 } },
            { field: 'EmployerName', type: 'text', required: false, html: {caption: 'Employer Name', page: 3, column: 0 } },
            { field: 'EmployerStreetAddress', type: 'text', required: false, html: {caption: 'Employer Street Address', page: 3, column: 0 } },
            { field: 'EmployerCity', type: 'text', required: false, html: {caption: 'Employer City', page: 3, column: 0 } },
            { field: 'EmployerState', type: 'list', options: {items: app.usStateAbbr}, required: false, html: {caption: 'Employer State', page: 3, column: 0 } },
            { field: 'EmployerPostalCode', type: 'text', required: false, html: {caption: 'Employer Postal Code', page: 3, column: 0 } },
            { field: 'EmployerEmail', type: 'text', required: false, html: {caption: 'Employer Email', page: 3, column: 0 } },
            { field: 'EmployerPhone', type: 'text', required: false, html: {caption: 'Employer Phone', page: 3, column: 0 } },
            { field: 'Occupation', type: 'text', required: false, html: {caption: 'Occupation', page: 3, column: 0 } },
            { field: 'ApplicationFee', type: 'text', required: false, html: {caption: 'Application Fee', page: 3, column: 0 } },
            { field: 'DesiredUsageStartDate', type: 'date', required: false, html: {caption: 'Desired Usage Start Date', page: 3, column: 0 } },
            { field: 'RentableTypePreference', type: 'text', required: false, html: {caption: 'Rentable Type Preference', page: 3, column: 0 } },
            { field: 'FLAGS', type: 'text', required: false, html: {caption: 'FLAGS', page: 3, column: 0 } },
            { field: 'Approver', type: 'text', required: false, html: {caption: 'Approver', page: 3, column: 0 } },
            { field: 'DeclineReasonSLSID', type: 'w2int', required: false, html: {caption: 'Decline Reason SLSID', page: 3, column: 0 } },
            { field: 'OtherPreferences', type: 'text', required: false, html: {caption: 'Other Preferences', page: 3, column: 0 } },
            { field: 'FollowUpDate', type: 'date', required: false, html: {caption: 'FollowU pDate', page: 3, column: 0 } },
            { field: 'CSAgent', type: 'text', required: false, html: {caption: 'CS Agent', page: 3, column: 0 } },
            { field: 'OutcomeSLSID', type: 'text', required: false, html: {caption: 'Outcome SLSID', page: 3, column: 0 } },
            { field: 'FloatingDeposit', type: 'w2float', required: false, html: {caption: 'Floating Deposit', page: 3, column: 0 } },
            { field: 'RAID', type: 'w2int', required: false, html: {caption: 'RAID', page: 3, column: 0 } },

        ],
        tabs: [
            { id: 'tab1', caption: app.sTransactant },
            { id: 'tab2', caption: app.sUser },
            { id: 'tab3', caption: app.sPayor },
            { id: 'tab4', caption: app.sProspect },
        ],
        toolbar: {
            items: [
                { id: 'btnNotes', type: 'button', icon: 'fa fa-sticky-note-o' },
                { id: 'bt3', type: 'spacer' },
                { id: 'btnClose', type: 'button', icon: 'fa fa-times' },
            ],
            onClick: function (event) {
                if (event.target == 'btnClose') {
                    w2ui.toplayout.hide('right',true);
                }
                if (event.target == 'btnNotes')  {
                    notesPopUp();
                }
            },
        },
        actions: {
            save: function () {
                var tgrid = w2ui.transactantsGrid;
                var sel = tgrid.getSelection();
                tgrid.unselect(sel);
                console.log('before: tgrid.getSelection() = ' + tgrid.getSelection() );
                this.save({}, function (data) { 
                    if (data.status == 'error') {
                        console.log('ERROR: '+ data.message);
                        return;
                    }
                    w2ui.toplayout.hide('right',true);
                    tgrid.reload();
                });
            },
            reset: function () {
                w2ui.transactantForm.resize();
            }
        },
        onRefresh: function() {
            var f = w2ui.transactantForm;
            var r = f.record;
            var name = r.FirstName + ' ' + r.LastName;
            var title = 'Edit ' + app.sTransactant + ' - ' + name +' (' + r.TCID + ')';
            f.header = title;
        }
    });


    //------------------------------------------------------------------------
    //          notesPopUp
    //------------------------------------------------------------------------
    function notesPopUp() {
        w2popup.open({
            width   : 580,
            height  : 350,
            title   : 'Notes',
            body    : '<div class="w2ui-centered" style="line-height: 1.8">'+
                      '     This is a sample of what the Notes area.'+
                      '     <br>The focus will not leave popup. <br><br>'+
                      '     Add Note: <textarea name="comments" type="text" style="width: 385px; height: 80px"></textarea><br>'+
                       '</div>',
            buttons : '<button class="w2ui-btn" onclick="w2popup.close()">Ok</button>'+
                      '<button class="w2ui-btn" onclick="w2popup.close()">Cancel</button>'
        });
    }


    //------------------------------------------------------------------------
    //          rentablesGrid
    //------------------------------------------------------------------------
    $().w2grid({
        name: 'rentablesGrid',
        url: '/v1/rentable',
        formURL: '/html/formr.html',
        show: {
            header: false,
            toolbar: true,
            searches: true,
            footer: false,
            lineNumbers: false,
            selectColumn: false,
            expandColumn: false
        },
        columns: [
            {field: 'recid', caption: 'recid', size: '50px', hidden: true, sortable: true},
            {field: 'RID', caption: 'RID', size: '50px', sortable: true},
            {field: 'RentableName', caption: 'RentableName', size: '150px', sortable: true},
            {field: 'AssignmentTime', caption: 'Assignment Time', size: '120px', sortable: true},
        ],
        onClick: function(event) {
            // var sel = this.getSelection(true);
            event.onComplete = function () {
                var sel = this.getSelection(true);
                if (sel.length > 0) {
                    for (var i = 0; i < sel.length; i++) {
                        var ob = this.get(sel[i]);
                        console.log('rentable form url: ' + '/v1/rentable/' + ob.BID + '/' + ob.RID);
                        setToForm('rentableForm', '/v1/rentable/' + ob.BID + '/' + ob.RID);
                    }
                } else {
                    console.log('*** NO SELECTION FOUND ***   So, select index 0');
                    this.select(1);
                }
            };
        }
    });

    //------------------------------------------------------------------------
    //          rentableForm
    //------------------------------------------------------------------------
    $().w2form({
        name: 'rentableForm',
        style: 'border: 0px; background-color: transparent;',
        header: app.sRentable + ' Detail',
        url: '/v1/rentable',
        formURL: '/html/formr.html',
        fields: [
            { field: 'recid', type: 'int', required: false, html: { caption: 'recid', page: 0, column: 0 } },
            { field: 'RID', type: 'int', required: false, html: { caption: 'RID', page: 0, column: 0 } },
            { field: 'BID', type: 'list', options: {items: app.businesses}, required: false, html: { caption: 'BID', page: 0, column: 0 } },
            { field: 'RentableName', type: 'text', required: false, html: { caption: 'RentableName', page: 0, column: 0 } },
            { field: 'AssignmentTime', type: 'list', options: {items: app.assignmentTimeList}, required: false, html: { caption: 'Assignment Time', page: 0, column: 0 } },
        ],
        toolbar: {
            items: [
                { id: 'btnNotes', type: 'button', icon: 'fa fa-sticky-note-o' },
                { id: 'bt3', type: 'spacer' },
                { id: 'btnClose', type: 'button', icon: 'fa fa-times' },
            ],
            onClick: function (event) {
                switch(event.target) {
                case 'btnClose':
                    w2ui.toplayout.hide('right',true);
                    break;
                }
            },
        },
        actions: {
            save: function () {
                //var obj = this;
                var tgrid = w2ui.rentablesGrid;
                var sel = tgrid.getSelection();
                tgrid.unselect(sel);
                this.save({}, function (data) { 
                    if (data.status == 'error') {
                        console.log('ERROR: '+ data.message);
                        return;
                    }
                    w2ui.toplayout.hide('right',true);
                    tgrid.reload();
                });

            },
            reset: function() {
                var f = w2ui.rentableForm;
                console.log('f:   recid = ' + f.record.recid + '   RID = ' + f.record.RID + '   Name = ' + f.record.RentableName);
            }
        },
        onRefresh: function(/*event*/) {
            var f = w2ui.rentableForm;
            var r = f.record;
            f.header = 'Edit ' + app.sRentable + ' - ' + r.RentableName + ' (' + r.RID + ')';
        }
    });

    //------------------------------------------------------------------------
    //          rentalagrsGrid
    //------------------------------------------------------------------------
    $().w2grid({
        name: 'rentalagrsGrid',
        url: '/v1/rentalagrs',       
        show: {
            toolbar: true,
            footer: true,
        },
        multiSearch: true,
        searches: [
            { field: 'RAID', caption: 'RAID', type: 'text' },
            { field: 'AgreementStart', caption: 'Agreement Start Date', type: 'date' },
            { field: 'AgreementStop', caption: 'Agreement Stop Date', type: 'date' },
        ],
        columns: [
            {field: 'recid', hidden: true, caption: 'recid',  size: '40px', sortable: true},
            {field: 'BID', hidden: true, caption: 'BID',  size: '40px', sortable: false},
            {field: 'RAID', caption: 'RAID',  size: '50px', sortable: true},
            {field: 'Payor', caption: 'Payor', size: '125px', sortable: true},
            {field: 'AgreementStart', caption: 'Agreement<br>Start', render: 'date', size: '80px', sortable: true, style: 'text-align: right'},
            {field: 'AgreementStop', caption: 'Agreement<br>Stop',  render: 'date', size: '80px', sortable: true, style: 'text-align: right'},
        ], 
        actions: {
            save: function () {
                var tgrid = w2ui.rentalagrsGrid;
                var sel = tgrid.getSelection();
                tgrid.unselect(sel);
                console.log('before: tgrid.getSelection() = ' + tgrid.getSelection() );
            },
        },
        onClick: function(event) {
            //var sel = this.getSelection(true);
            event.onComplete = function () {
                var sel = this.getSelection(true);
                console.log('Get Selection: Rental Agreement');
                if (sel.length > 0) {
                    for (var i = 0; i < sel.length; i++) {
                        var ob = this.get(sel[i]);
                        console.log( 'BID = ' + ob.BID + ',   RAID = ' + ob.RAID);
                        var d = new Date();  // we'll use today for time-sensitive data
                        setToRAForm(ob.BID,ob.RAID,d);
                    }
                } else {
                    console.log('*** NO SELECTION FOUND ***   So, select index 0');
                    this.select(1);
                }
            };
        },
    });


    //------------------------------------------------------------------------
    //          Rental Agreement Details
    //------------------------------------------------------------------------
    $().w2layout({
        name: 'raLayout',
        padding: 0,
        panels: [
            { type: 'left', size: '40%', resizable: true, style: app.pstyle, content: 'top' },
            { type: 'top', size: 0, hidden: true },
            { type: 'main', size: '60%', resizable: true, style: app.pstyle, content: 'main' },
            { type: 'preview', size: 0, content: 'PREVIEW',  hidden: true },
            { type: 'bottom', size: 0, hidden: true },
            { type: 'right', size: 0, hidden: true }
        ]
    });
    $().w2layout({
        name: 'raLayoutSub1',
        padding: 1,
        panels: [
            { type: 'top', size: '30%', resizable: true, style: app.pstyle4, content: 'Rentables' },
            { type: 'left', size: 0, hidden: true },
            { type: 'main', size: '20%', resizable: true, style: app.pstyle4, content: 'Payors' },
            { type: 'preview', size: '60%', resizable: true, style: app.pstyle4, content: 'Users' },
            { type: 'right', size: 0, hidden: true },
            { type: 'bottom', size: '25%', resizable: true, style: app.pstyle4, content: 'Pets' }
        ]
    });

    //------------------------------------------------------------------------
    //          rentalagrForm
    //------------------------------------------------------------------------
    $().w2form({
        name: 'rentalagrForm',
        style: 'border: 0px; background-color: transparent;',
        header: app.sRentalAgreement + ' Detail',
        //url: '/v1/rentalagrs',
        formURL: '/html/formra.html',
        fields: [
            { field: 'recid', type: 'int', required: false, html: { caption: 'recid', page: 0, column: 0 } },
            { field: 'RAID', type: 'int', required: false, html: { caption: 'RAID', page: 0, column: 0 } },
            { field: 'RATID', type: 'int', required: false, html: { caption: 'RATID', page: 0, column: 0 } },
            { field: 'BID', type: 'list', options: {items: app.businesses}, required: false, html: { caption: 'BID', page: 0, column: 0 } },
            { field: 'NLID', type: 'int', required: false, html: { caption: 'Notes', page: 0, column: 0 } },
            { field: 'AgreementStart', type: 'date', required: false, html: { caption: 'Agreement Start', page: 0, column: 0 } },
            { field: 'AgreementStop', type: 'date', required: false, html: { caption: 'Agreement Stop', page: 0, column: 0 } },
            { field: 'PossessionStart', type: 'date', required: false, html: { caption: 'Possession Start', page: 0, column: 0 } },
            { field: 'PossessionStop', type: 'date', required: false, html: { caption: 'Possession Stop', page: 0, column: 0 } },
            { field: 'RentStart', type: 'date', required: false, html: { caption: 'Rent Start', page: 0, column: 0 } },
            { field: 'RentStop', type: 'date', required: false, html: { caption: 'Rent Stop', page: 0, column: 0 } },
            { field: 'RentCycleEpoch', type: 'date', required: false, html: { caption: 'Rent Cycle Epoch', page: 0, column: 0 } },
            { field: 'UnspecifiedAdults', type: 'int', required: false, html: { caption: 'Unspecified Adults', page: 0, column: 0 } },
            { field: 'UnspecifiedChildren', type: 'int', required: false, html: { caption: 'Unspecified Children', page: 0, column: 0 } },
            { field: 'Renewal', type: 'list', options: {items: app.renewalMap}, required: false, html: { caption: 'Renewal', page: 0, column: 0 } },
            { field: 'SpecialProvisions', type: 'text', required: false, html: { caption: 'Special Provisions', page: 0, column: 0 } },
            { field: 'LastModTime', type: 'text', required: false, html: { caption: 'LastModTime', page: 0, column: 0 } },
            { field: 'LastModBy', type: 'int', required: false, html: { caption: 'LastModBy', page: 0, column: 0 } },
            { field: 'LeaseType', type: 'w2int', required: false, html: {page: 1, column: 0}},
            { field: 'ExpenseAdjustmentType', type: 'w2int', required: false, html: {page: 1, column: 0}},
            { field: 'ExpensesStop', type: 'w2float', required: false, html: {page: 1, column: 0}},
            { field: 'ExpenseStopCalculation', type: 'text', required: false, html: {page: 1, column: 0}},
            { field: 'BaseYearEnd', type: 'date', required: false, html: {page: 1, column: 0}},
            { field: 'ExpenseAdjustment', type: 'date', required: false, html: {page: 1, column: 0}},
            { field: 'EstimatedCharges', type: 'w2float', required: false, html: {page: 1, column: 0}},
            { field: 'RateChange', type: 'w2float', required: false, html: {page: 1, column: 0}},
            { field: 'NextRateChange', type: 'date', required: false, html: {page: 1, column: 0}},
            { field: 'PermittedUses', type: 'text', required: false, html: {page: 1, column: 0}},
            { field: 'ExclusiveUses', type: 'text', required: false, html: {page: 1, column: 0}},
            { field: 'ExtensionOption', type: 'text', required: false, html: {page: 1, column: 0}},
            { field: 'ExtensionOptionNotice', type: 'date', required: false, html: {page: 1, column: 0}},
            { field: 'ExpansionOption', type: 'text', required: false, html: {page: 1, column: 0}},
            { field: 'ExpansionOptionNotice', type: 'date', required: false, html: {page: 1, column: 0}},
            { field: 'RightOfFirstRefusal', type: 'text', required: false, html: {page: 1, column: 0}},
        ],
        tabs: [
            { id: 'tab1', caption: app.sRAMainTab },
            { id: 'tab2', caption: app.sRACommercialTab },
        ],
        actions: {
            save: function () {
                var tgrid = w2ui.rentalagrsGrid;
                var sel = tgrid.getSelection();
                tgrid.unselect(sel);
                this.save({}, function (data) { 
                    if (data.status == 'error') {
                        console.log('ERROR: '+ data.message);
                        return;
                    }
                    w2ui.toplayout.hide('right',true);
                    tgrid.reload();
                });
            },
            reset: function() {
                w2ui.toplayout.resize();
                w2ui.raLayout.resize();
                w2ui.rentalagrForm.resize();
                w2ui.raLayoutSub1.resize();
                w2ui.transactantForm.resize();
                var f = w2ui.rentalagrForm;
                console.log('f:   recid = ' + f.record.recid + '   RAID = ' + f.record.RID);
            }
        },
        onRefresh: function(/*event*/) {
            var f = w2ui.rentalagrForm;
            f.header = 'Edit ' + app.sRentalAgreement + ' -  RA00' + f.record.RAID;
        }
    });

    //------------------------------------------------------------------------
    //          rarGrid
    //------------------------------------------------------------------------
    $().w2grid({
        name: 'rarGrid',
        show: {
            header: app.sRentable,
            toolbar: true,
            footer: false,
            lineNumbers: false,
            selectColumn: false,
            expandColumn: false,
            toolbarAdd: true,
            toolbarDelete: true,
            toolbarSave: true,
            toolbarEdit: false,
            toolbarSearch: false,
            toolbarInput: false,
            searchAll: false,
            toolbarReload: false,
            toolbarColumns: false,
        },
         url: '/v1/rar/',       
        columns: [
            {field: 'recid', hidden: true, caption: 'recid',  size: '40px', sortable: true},
            {field: 'RAID', hidden: true, caption: 'RAID',  size: '40px', sortable: true},
            {field: 'RID', hidden: true, caption: app.sRentable,  size: '10%', sortable: true},
            {field: 'RentableName', caption: app.sRentable+' Name',  size: '10%', sortable: true},
            {field: 'ContractRent', caption: 'Rent', size: '10%', sortable: true, render: 'money', editable: { type: 'money' }},
            {field: 'RARDtStart', caption: 'Start', size: '10%', sortable: true, style: 'text-align: right', editable: { type: 'date' }},
            {field: 'RARDtStop', caption: 'Stop',  size: '10%', sortable: true, style: 'text-align: right', editable: { type: 'date' }},
            ],
        onDelete: function(/*event*/) {
            var sel = w2ui.rarGrid.getSelection(true); // get the record indeces rather than the recids
            w2ui.rarGrid.postData = {
                RID: w2ui.rarGrid.records[sel[0]].RID,
            };
        },
        onRefresh: function(/*event*/) {
            var total = 0.0;
            //var sumIndex = -1;
            for (var i = 0; i < w2ui.rarGrid.records.length; i++) {
                total += w2ui.rarGrid.records[i].ContractRent;
            }
            w2ui.rarGrid.summary.push({recid: 's-1', RAID: 0, RID: 0, RentableName: '', ContractRent: total, RARDtStart: '', RARDtStop: '', w2ui: {summary: true}});
        },

     });

    //------------------------------------------------------------------------
    //          rapGrid
    //------------------------------------------------------------------------
    $().w2grid({
        name: 'rapGrid',
        show: {
            header: app.sPayor,
            toolbar: true,
            footer: false,
            lineNumbers: false,
            selectColumn: false,
            expandColumn: false,
            toolbarAdd: true,
            toolbarDelete: true,
            toolbarSave: true,
            toolbarEdit: false,
            toolbarSearch: false,
            toolbarInput: false,
            searchAll: false,
            toolbarReload: false,
            toolbarColumns: false,
        },
        url: '/v1/rapayor',       
        columns: [
            {field: 'recid', hidden: true, caption: 'recid',  size: '40px', sortable: true},
            {field: 'TCID', hidden: true, caption: 'TCID',  size: '40px', sortable: true},
            {field: 'FirstName', caption: 'First Name',  size: '10%', sortable: true},
            {field: 'MiddleName', caption: 'MI',  size: '30px', sortable: true},
            {field: 'LastName', caption: 'Last Name',  size: '10%', sortable: true},
            {field: 'DtStart', caption: 'Start', size: '10%', sortable: true, style: 'text-align: right', editable: { type: 'date' }},
            {field: 'DtStop', caption: 'Stop',  size: '10%', sortable: true, style: 'text-align: right', editable: { type: 'date' }},
        ],
        onAdd: function (/*event*/) {
            var x = getCurrentBusiness();
            popupTcidRAPayorPicker(app.sPayor, x.value );
        },
        onSave: function() {
            console.log('save payors');
        },
        onDelete: function(/*event*/) {
            var sel = w2ui.rapGrid.getSelection(true); // get the record indeces rather than the recids
            w2ui.rapGrid.postData = {
                TCID: w2ui.rapGrid.records[sel[0]].TCID,
            };
        }
     });

    //------------------------------------------------------------------------
    //          rauGrid
    //------------------------------------------------------------------------
    $().w2grid({
        name: 'rauGrid',
        show: {
            header: app.sUser,
            toolbar: true,
            footer: false,
            lineNumbers: false,
            selectColumn: false,
            expandColumn: false,
            toolbarAdd: true,
            toolbarDelete: true,
            toolbarSave: true,
            toolbarEdit: false,
            toolbarSearch: false,
            toolbarInput: false,
            searchAll: false,
            toolbarReload: false,
            toolbarColumns: false,
        },
        url: '/v1/ruser',       
        columns: [
            {field: 'recid', hidden: true, caption: 'recid',  size: '40px', sortable: true},
            {field: 'TCID', hidden: true, caption: 'TCID',  size: '40px', sortable: true},
            {field: 'RID', hidden: true, caption: 'RID',  size: '40px', sortable: true},
            {field: 'BID', hidden: true, caption: 'RID',  size: '40px', sortable: true},
            {field: 'RentableName', caption: app.sRentable,  size: '10%', sortable: true},
            {field: 'FirstName', caption: 'First Name',  size: '10%', sortable: true},
            {field: 'MiddleName', caption: 'MI',  size: '30px', sortable: true},
            {field: 'LastName', caption: 'Last Name',  size: '10%', sortable: true},
            {field: 'DtStart', caption: 'Start', size: '10%', sortable: true, style: 'text-align: right', editable: { type: 'date' }},
            {field: 'DtStop', caption: 'Stop',  size: '10%', sortable: true, style: 'text-align: right', editable: { type: 'date' }},
        ],
        onAdd: function (/*event*/) {
            var x = getCurrentBusiness();
            console.log('rentalagrForm.record.RAID = ' + w2ui.rentalagrForm.record.RAID);
            popupTcidRUserPicker(app.sUser, x.value, w2ui.rentalagrForm.record.RAID );
        },
        onSave: function() {
            console.log('save users');
        },
        onDelete: function(/*event*/) {
            var sel = w2ui.rauGrid.getSelection(true); // get the record indeces rather than the recids
            var x = getCurrentBusiness();
            w2ui.rauGrid.postData = {
                TCID: w2ui.rauGrid.records[sel[0]].TCID,
            };
            w2ui.rauGrid.url = '/v1/ruser/' + x.value + '/' + w2ui.rauGrid.records[sel[0]].RID;
        }
     });

    //------------------------------------------------------------------------
    //          raPetGrid
    //------------------------------------------------------------------------
    $().w2grid({
        name: 'raPetGrid',
        show: {
            header: app.sUser,
            toolbar: true,
            footer: false,
            toolbarAdd: true,
            toolbarDelete: true,
            toolbarSave: true,
            toolbarEdit: false,
            toolbarSearch: false,
            toolbarInput: false,
            searchAll: false,
            toolbarReload: false,
            toolbarColumns: false,
        },
        url: '/v1/rapet',       
        columns: [
            {field: 'recid', hidden: true, caption: 'recid',  size: '40px', sortable: true},
            {field: 'PETID', hidden: true, caption: 'PETID',  size: '40px', sortable: true},
            {field: 'Name',     caption: 'Name', size: '10%', sortable: true},
            {field: 'Type',     caption: 'Type', size: '10%', sortable: true},
            {field: 'Breed',    caption: 'Breed', size: '10%', sortable: true},
            {field: 'Color',    caption: 'Color', size: '10%', sortable: true},
            {field: 'Weight',   caption: 'Weight', size: '10%', sortable: true},
            {field: 'DtStart',  caption: 'DtStart', size: '10%', sortable: true, style: 'text-align: right'},
            {field: 'DtStop',   caption: 'DtStop', size: '10%', sortable: true, style: 'text-align: right'},
        ],
        onDelete: function(event) {
            var sel = w2ui.rPetGrid.getSelection(true); // get the record indeces rather than the recids
            w2ui.rPetGrid.postData = {
                PETID: w2ui.rPetGrid.records[sel[0]].PETID,
            };
        }

     });

    //------------------------------------------------------------------------
    //          receiptsGrid
    //------------------------------------------------------------------------
    $().w2grid({
        name: 'receiptsGrid',
        url: '/v1/receipts',       
        show: {
            toolbar: true,
            footer: true,
        },
        columns: [
            {field: 'recid', hidden: true, caption: 'recid',  size: '40px', sortable: true},
            {field: 'RCPTID', caption: 'ReceiptID',  size: '50px', style: 'text-align: right', sortable: true},
            {field: 'Dt', caption: 'Date', size: '80px', sortable: true, style: 'text-align: right'},
            {field: 'Amount', caption: 'Amount', size: '100px', sortable: true, render: 'money', style: 'text-align: right'},
            {field: 'BID', hidden: true, caption: 'BUD', size: '40px', sortable: false},
            {field: 'PMTID', hidden: true, caption: 'PMTID', size: '40px', sortable: false},
            {field: 'RAID', caption: app.sRentalAgreement,  size: '50px', style: 'text-align: right', sortable: true},
            {field: 'DocNo', caption: 'Document Number',  size: '100px', style: 'text-align: right', sortable: true},
        ], 
        actions: {
            save: function () {
                var tgrid = w2ui.receiptsGrid;
                var sel = tgrid.getSelection();
                tgrid.unselect(sel);
                console.log('before: tgrid.getSelection() = ' + tgrid.getSelection() );
            },
        },
        onClick: function(event) {
            //var sel = this.getSelection(true);
            event.onComplete = function () {
                var sel = this.getSelection(true);
                console.log('Get Selection: Receipt');
                if (sel.length > 0) {
                    for (var i = 0; i < sel.length; i++) {
                        var ob = this.get(sel[i]);
                        console.log( 'BID = ' + ob.BID + ',   RCPT = ' + ob.RCPTID);
                        setToForm('receiptForm', '/v1/receipt/' + ob.BID + '/' + ob.RCPTID);
                    }
                } else {
                    console.log('*** NO SELECTION FOUND ***   So, select index 0');
                    this.select(1);
                }
            };
        },
        onRequest: function(/*event*/) {
            console.log('On Request.  url = ' + w2ui.receiptsGrid.url);
        },
        onSearch: function(/*event*/) {
            console.log('Search called');
        }
    });

    //------------------------------------------------------------------------
    //          receiptForm
    //------------------------------------------------------------------------
    $().w2form({
        name: 'receiptForm',
        style: 'border: 0px; background-color: transparent;',
        header: app.sRentable + ' Detail',
        url: '/v1/receipt',
        formURL: '/html/formrcpt.html',
        fields: [
            { field: 'recid', type: 'int', required: false },
            { field: 'RID', type: 'int', required: false },
            { field: 'BID', type: 'list', options: {items: app.businesses}, required: true },
            { field: 'RentableName',   type: 'text',  required: false, },
            { field: 'RCPTID',         type: 'w2int', required: true },
            { field: 'PRCPTID',        type: 'w2int', required: false },
            { field: 'RAID',           type: 'w2int', required: true },
            { field: 'PMTID',          type: 'w2int', required: false },
            { field: 'Dt',             type: 'date',  required: true },
            { field: 'DocNo',          type: 'text',  required: false },
            { field: 'Amount',         type: 'money', required: true },
            { field: 'AcctRule',       type: 'text',  required: true },
            { field: 'Comment',        type: 'text',  required: false },
            { field: 'OtherPayorName', type: 'text',  required: false },
        ],
        toolbar: {
            items: [
                { id: 'btnNotes', type: 'button', icon: 'fa fa-sticky-note-o' },
                { id: 'bt3', type: 'spacer' },
                { id: 'btnClose', type: 'button', icon: 'fa fa-times' },
            ],
            onClick: function (event) {
                switch(event.target) {
                case 'btnClose':
                    w2ui.toplayout.hide('right',true);
                    break;
                }
            },
        },
        actions: {
            save: function () {
                //var obj = this;
                var tgrid = w2ui.receiptsGrid;
                var sel = tgrid.getSelection();
                tgrid.unselect(sel);
                this.save({}, function (data) { 
                    if (data.status == 'error') {
                        console.log('ERROR: '+ data.message);
                        return;
                    }
                    w2ui.toplayout.hide('right',true);
                    tgrid.reload();
                });

            },
            reset: function() {
                var f = w2ui.receiptForm;
                console.log('f:   recid = ' + f.record.recid + '   RCPTID = ' + f.record.RCPTID );
            }
        },
        onRefresh: function(/*event*/) {
            var f = w2ui.receiptForm;
            var r = f.record;
            f.header = 'Edit ' + app.sReceipt + ' (' + r.RCPTID + ')';
        }
    });


    //------------------------------------------------------------------------
    //          asmsGrid
    //------------------------------------------------------------------------
    $().w2grid({
        name: 'asmsGrid',
        url: '/v1/asms',       
        show: {
            toolbar: true,
            footer: true,
        },
        columns: [
            {field: 'recid', hidden: true, caption: 'recid',  size: '40px', sortable: true},
            {field: 'epoch', size: '10px', style: 'text-align: center', sortable: true},
            {field: 'ASMID', caption: 'ASMID',  size: '50px', style: 'text-align: right', sortable: true},
            {field: 'Invoice', caption: 'Invoice', size: '80px', sortable: true, style: 'text-align: right'},
            {field: 'Start', caption: 'Date', size: '80px', sortable: true, style: 'text-align: right'},
            {field: 'Stop', caption: 'Date', size: '80px', sortable: true, style: 'text-align: right'},
            {field: 'Amount', caption: 'Amount', size: '100px', sortable: true, render: 'money', style: 'text-align: right'},
            {field: 'ATypeLID', caption: 'Type', size: '100px', sortable: true, style: 'text-align: right'},
            {field: 'BID', hidden: true, caption: 'BUD', size: '40px', sortable: false},
            {field: 'PASMID', hidden: true, caption: 'PMTID', size: '40px', sortable: false},
            {field: 'RAID', caption: app.sRentalAgreement,  size: '50px', style: 'text-align: right', sortable: true},
            {field: 'RID', caption: app.sRentable,  size: '50px', style: 'text-align: right', sortable: true},
            // {field: 'RentCycle', caption: app.sRentCycle,  size: '60px', style: 'text-align: right', sortable: true},
            // {field: 'ProrationCycle', caption: sProrationCycle,  size: '60px', style: 'text-align: right', sortable: true},
        ], 
        actions: {
            save: function () {
                var tgrid = w2ui.asmsGrid;
                var sel = tgrid.getSelection();
                tgrid.unselect(sel);
                console.log('before: tgrid.getSelection() = ' + tgrid.getSelection() );
            },
        },
        onClick: function(event) {
            //var sel = this.getSelection(true);
            event.onComplete = function () {
                var sel = this.getSelection(true);
                console.log('Get Selection: Assessment');
                if (sel.length > 0) {
                    for (var i = 0; i < sel.length; i++) {
                        var ob = this.get(sel[i]);
                        var form = (ob.RentCycle !== 'Norecur' && ob.PASMID === 0) ? "asmEpochForm" : "asmInstForm";
                        var myurl = '/v1/asm/' + ob.BID + '/' + ob.ASMID;
                        console.log( 'calling setToForm( '+form+', ' + myurl + ')');
                        setToForm(form, myurl);
                    }
                } else {
                    console.log('*** NO SELECTION FOUND ***   So, select index 0');
                    this.select(1);
                }
            };
        },
        onRequest: function(/*event*/) {
            console.log('On Request.  url = ' + w2ui.asmsGrid.url);
        },
        onRefresh: function(/*event*/) {
            for (var i = 0; i < w2ui.asmsGrid.records.length; i++) {
                if (w2ui.asmsGrid.records[i].RentCycle !== 'Norecur' &&                         // if this is recurring...
                    w2ui.asmsGrid.records[i].PASMID === 0) {                                    // and it is NOT and instance... 
                    w2ui.asmsGrid.records[i].epoch = '<i class="fa fa-refresh" aria-hidden="true"></i>';
                }
            }
        },
        onSearch: function(/*event*/) {
            console.log('Search called');
        }
    });

    //------------------------------------------------------------------------
    //          asmInstForm  -  assessment instance
    //------------------------------------------------------------------------
    $().w2form({
        name: 'asmInstForm',
        style: 'border: 0px; background-color: transparent;',
        header: app.sAssessment + ' Detail',
        url: '/v1/asm',
        formURL: '/html/formasminst.html',
        fields: [
            { field: 'recid',         type: 'int',    required: false },
            { field: 'ASMID',         type: 'int',    required: false },
            { field: 'BID',           type: 'list',   options:  {items: app.businesses}, required: false },
            { field: 'PASMID',        type: 'w2int',   required: false },
            { field: 'RID',           type: 'w2int',   required: false },
            { field: 'ATypeLID',      type: 'w2int',  required: true },
            { field: 'RAID',          type: 'w2int',  required: false },
            { field: 'Amount',        type: 'money',  required: true },
            { field: 'Start',         type: 'date',   required: true },
            { field: 'Stop',          type: 'date',   required: true },
            { field: 'RentCycle',     type: 'list',   options:  {items: app.cycleFreq}, required: true },
            { field: 'ProrationCycle',type: 'list',   options:  {items: app.cycleFreq}, required: true },
            { field: 'AcctRule',      type: 'text',   required: true },
            { field: 'Comment',       type: 'text',   required: false },
            { field: 'LastModTime',   type: 'hidden', required: false },
            { field: 'LastModBy',     type: 'hidden', required: false },
        ],
        toolbar: {
            items: [
                { id: 'btnNotes', type: 'button', icon: 'fa fa-sticky-note-o' },
                { id: 'bt3', type: 'spacer' },
                { id: 'btnClose', type: 'button', icon: 'fa fa-times' },
            ],
            onClick: function (event) {
                switch(event.target) {
                case 'btnClose':
                    w2ui.toplayout.hide('right',true);
                    break;
                }
            },
        },
        actions: {
            save: function () {
                //var obj = this;
                var tgrid = w2ui.asmsGrid;
                var sel = tgrid.getSelection();
                tgrid.unselect(sel);
                this.save({}, function (data) { 
                    if (data.status == 'error') {
                        console.log('ERROR: '+ data.message);
                        return;
                    }
                    w2ui.toplayout.hide('right',true);
                    tgrid.reload();
                });

            },
            reset: function() {
                var f = w2ui.asmInstForm;
                console.log('reset: ASMID = ' + f.record.ASMID );
            }
        },
        onRefresh: function(/*event*/) {
            var f = w2ui.asmInstForm;
            var r = f.record;
            f.header = 'Edit ' + app.sAssessment + ' (' + r.ASMID + ')';
            // r.epoch = app.epochInstance[  (r.RentCycle !== 'Norecur' && r.PASMID === 0) ? 0 : 1 ];
            if (!String.prototype.format) {
                String.prototype.format = function() {
                    var args = arguments;
                    return this.replace(/{(\d+)}/g, function(match, number) { 
                        return typeof args[number] != 'undefined'? args[number] : match;
                    });
                };
            }
            var hdr = '';
            if (r.RentCycle !== 'Norecur' && r.PASMID === 0) {
                // EPOCH
                hdr = 'This is an epoch assessment, it defines a recurring series of assessment instances.';
            } else {
                // INSTANCE has 3 variables: ParentASM, RentCycle, Proration
                hdr = app.asmInstanceHeader.format(''+r.PASMID, r.RentCycle, r.ProrationCycle);
            }
            document.getElementById("AssessmentEpochOrInstance").innerHTML = hdr;
        }
    });

    //------------------------------------------------------------------------
    //          asmEpochForm  -  assessment epoch
    //------------------------------------------------------------------------
    $().w2form({
        name: 'asmEpochForm',
        style: 'border: 0px; background-color: transparent;',
        header: app.sAssessment + ' Detail',
        url: '/v1/asm',
        formURL: '/html/formasmepoch.html',
        fields: [
            { field: 'recid',         type: 'int',    required: false },
            { field: 'ASMID',         type: 'int',    required: false },
            { field: 'BID',           type: 'list',   options:  {items: app.businesses}, required: true },
            { field: 'PASMID',        type: 'w2int',   required: false },
            { field: 'RID',           type: 'w2int',   required: false },
            { field: 'ATypeLID',      type: 'w2int',  required: true },
            { field: 'RAID',          type: 'w2int',  required: false },
            { field: 'Amount',        type: 'money',  required: true },
            { field: 'Start',         type: 'date',   required: true },
            { field: 'Stop',          type: 'date',   required: true },
            { field: 'RentCycle',     type: 'list',   options:  {items: app.cycleFreq}, required: true },
            { field: 'ProrationCycle',type: 'list',   options:  {items: app.cycleFreq}, required: true },
            { field: 'AcctRule',      type: 'text',   required: true },
            { field: 'Comment',       type: 'text',   required: false },
            { field: 'LastModTime',   type: 'hidden', required: false },
            { field: 'LastModBy',     type: 'hidden', required: false },
        ],
        toolbar: {
            items: [
                { id: 'btnNotes', type: 'button', icon: 'fa fa-sticky-note-o' },
                { id: 'bt3', type: 'spacer' },
                { id: 'btnClose', type: 'button', icon: 'fa fa-times' },
            ],
            onClick: function (event) {
                switch(event.target) {
                case 'btnClose':
                    w2ui.toplayout.hide('right',true);
                    break;
                }
            },
        },
        actions: {
            save: function () {
                //var obj = this;
                var tgrid = w2ui.asmsGrid;
                var sel = tgrid.getSelection();
                tgrid.unselect(sel);
                this.save({}, function (data) { 
                    if (data.status == 'error') {
                        console.log('ERROR: '+ data.message);
                        return;
                    }
                    w2ui.toplayout.hide('right',true);
                    tgrid.reload();
                });

            },
            reset: function() {
                var f = w2ui.asmInstForm;
                console.log('reset: ASMID = ' + f.record.ASMID );
            }
        },
        onRefresh: function(/*event*/) {
            var f = w2ui.asmInstForm;
            var r = f.record;
            f.header = 'Edit ' + app.sAssessment + ' (' + r.ASMID + ')';
            // r.epoch = app.epochInstance[  (r.RentCycle !== 'Norecur' && r.PASMID === 0) ? 0 : 1 ];
            if (!String.prototype.format) {
                String.prototype.format = function() {
                    var args = arguments;
                    return this.replace(/{(\d+)}/g, function(match, number) { 
                        return typeof args[number] != 'undefined'? args[number] : match;
                    });
                };
            }
        }
    });

    //------------------------------------------------------------------------
    //          tcidRAPayorPicker
    //------------------------------------------------------------------------
    $().w2form({
        name: 'tcidRAPayorPicker',
        style: 'border: 0px; background-color: transparent;',
        formURL: '/html/tcidrapayorpicker.html',
        focus  : 0,
        fields: [
            { field: 'TCID', type: 'w2int', required: true },
            { field: 'pickedName', required: true, 
                type: 'enum', 
                options: {
                    url:        '/v1/transactantstd/' + app.TcidRAPayorPicker.BID,
                    max:        1,
                    renderItem: tcidRAPayorPickerRender,
                    renderDrop: tcidPickerDropRender,
                    compare:    tcidPickerCompare,
                    onNew: function (event) {
                        //console.log('++ New Item: Do not forget to submit it to the server too', event);
                        $.extend(event.item, { FirstName: '', LastName : event.item.text });
                    }
                },
            },
            { field: 'DtStart', type: 'date', required: true },
            { field: 'DtStop', type: 'date', required: true },
            { field: 'FirstName', type: 'text', required: false },
            { field: 'LastName', type: 'text', required: false },
        ],
        onRefresh: function(/*event*/) {
            w2ui.tcidRAPayorPicker.fields[1].options.url = '/v1/transactantstd/' + app.TcidRAPayorPicker.BID;
            console.log('SAVE tcidRAPayorPicker: TCID = ' + w2ui.tcidRAPayorPicker.record.TCID + '  DtStart = ' + w2ui.tcidRAPayorPicker.record.DtStart + '  DtStop = ' + w2ui.tcidRAPayorPicker.record.DtStop);
        },
        onChange: function (event) {
            console.log(event);
        },
        actions: {
            save: function () {
                var errs = w2ui.tcidRAPayorPicker.validate(true);
                if (errs.length > 0) { 
                    return; 
                }
                w2popup.close();
                saveNewRAPayor();
            },
        },
    });
    //------------------------------------------------------------------------
    //          tcidRUserPicker
    //------------------------------------------------------------------------
    $().w2form({
        name: 'tcidRUserPicker',
        style: 'border: 0px; background-color: transparent;',
        formURL: '/html/tcidruserpicker.html',
        focus  : 0,
        fields: [
            { field: 'TCID', type: 'w2int', required: true },
            { field: 'pickedName', required: true, 
                type: 'enum', 
                options: {
                    url:        '/v1/transactantstd/' + app.TcidRUserPicker.BID,
                    max:        1,
                    renderItem: tcidRAPayorPickerRender,
                    renderDrop: tcidPickerDropRender,
                    compare:    tcidPickerCompare,
                    onNew: function (event) {
                        //console.log('++ New Item: Do not forget to submit it to the server too', event);
                        $.extend(event.item, { FirstName: '', LastName : event.item.text });
                    }
                },
            },
            { field: 'RentableName', type: 'list', required: true, options: { items: [] } },
            { field: 'DtStart', type: 'date', required: true },
            { field: 'DtStop', type: 'date', required: true },
            { field: 'FirstName', type: 'text', required: false },
            { field: 'LastName', type: 'text', required: false },
        ],
        onRefresh: function(/*event*/) {
            w2ui.tcidRUserPicker.fields[1].options.url = '/v1/transactantstd/' + app.TcidRUserPicker.BID;
            w2ui.tcidRUserPicker.fields[2].options.items = app.TcidRUserPicker.RARentablesNames;
        },
        onChange: function (event) {
            console.log(event);
        },
        actions: {
            save: function () {
                var errs = w2ui.tcidRUserPicker.validate(true);
                if (errs.length > 0) { return; }
                console.log('SAVE tcidRUserPicker: TCID = ' + w2ui.tcidRUserPicker.record.TCID + '  DtStart = ' + w2ui.tcidRUserPicker.record.DtStart + '  DtStop = ' + w2ui.tcidRUserPicker.record.DtStop);
                w2popup.close();
                saveNewRUser();
            },
        },
    });
}


function saveNewRAPayor() {
    "use strict";
    var y = new Date();
    var ny = new Date(y.getFullYear() + 1, y.getMonth(), y.getDate(), 0, 0, 0);
    var rec = {
        recid: w2ui.rapGrid.records.length,                 // + 1
        BID: w2ui.rentalagrForm.record.BID,                 // BID of RAID we're editing
        TCID: w2ui.tcidRAPayorPicker.record.TCID,           // The TCID from the person picked
        RAID: w2ui.rentalagrForm.record.RAID,               // the RAID we're editing
        FirstName: w2ui.tcidRAPayorPicker.record.FirstName, // ignored
        MiddleName: "",                                     // ignored
        LastName: w2ui.tcidRAPayorPicker.record.LastName,   // ignored
        DtStart: w2uiDateControlString(y),                  // start
        DtStop: w2uiDateControlString(ny),                  // end
    };
    //console.log('rec = ' + rec);
    w2ui.rapGrid.add(rec,true);
    var params = {cmd: 'save', formname: 'tcidRAPayorPicker', record: rec };
    var dat = JSON.stringify(params);
    // console.log('url = ' + w2ui.rapGrid.url);
    $.post(w2ui.rapGrid.url, dat, function(data,status) {
        console.log('data = ' + data);
        if (status != "success") {
            console.log('status = ' + status);
        }
    });
}

function popupTcidRAPayorPicker(sTitle,bid) {
    "use strict";
    app.TcidRAPayorPicker = {BID: bid, Title: sTitle};  // used by tcidRAPayorPicker form
    var y = new Date();
    var ny = new Date(y.getFullYear() + 1, y.getMonth(), y.getDate(), 0, 0, 0);
    w2ui.tcidRAPayorPicker.record.DtStart = w2uiDateControlString(y);
    w2ui.tcidRAPayorPicker.record.DtStop = w2uiDateControlString(ny);
    w2ui.tcidRAPayorPicker.record.TCID = -1;
    w2ui.tcidRAPayorPicker.refresh();
    $().w2popup('open', {
        title   : 'Add A New ' + sTitle,
        body    : '<div id="form" style="width: 100%; height: 100%;"></div>',
        style   : 'padding: 15px 0px 0px 0px',
        width   : 400,
        height  : 200, 
        showMax : true,
        onToggle: function (event) {
            $(w2ui.tcidRAPayorPicker.box).hide();
            event.onComplete = function () {
                $(w2ui.tcidRAPayorPicker.box).show();
                w2ui.tcidRAPayorPicker.resize();
            };
        },
        onOpen: function (event) {
            event.onComplete = function () {
                // specifying an onOpen handler instead would be equivalent to specifying 
                // an onBeforeOpen handler, which would make this code execute too 
                // early and hence not deliver.
                $('#w2ui-popup #form').w2render('tcidRAPayorPicker');
            };
        }
    });   
}

function saveNewRUser() {
    "use strict";
    var y = new Date();
    var ny = new Date(y.getFullYear() + 1, y.getMonth(), y.getDate(), 0, 0, 0);
    var myRID = -1;
    var rname = w2ui.tcidRUserPicker.record.RentableName.text;
    var url = '/v1/ruser/';
    for (var i = 0; i < app.TcidRUserPicker.RAR.records.length; i++) {
        if (app.TcidRUserPicker.RAR.records[i].RentableName == rname) {
            myRID = app.TcidRUserPicker.RAR.records[i].RID;
            url += '' + app.TcidRUserPicker.RAR.records[i].BID + '/' + myRID;
        }
    }
    if (myRID < 1) { 
        console.log('RID = ' + myRID);
        return; 
    }
    var rec = {
        recid: w2ui.rapGrid.records.length,                 // + 1
        BID: w2ui.rentalagrForm.record.BID,                 // BID of RID we're editing
        TCID: w2ui.tcidRAPayorPicker.record.TCID,           // The TCID from the person picked
        RID: myRID,                                         // the selected RID
        RentableName: rname,                                // the name of the rentable
        FirstName: w2ui.tcidRAPayorPicker.record.FirstName, // ignored
        MiddleName: "",                                     // ignored
        LastName: w2ui.tcidRAPayorPicker.record.LastName,   // ignored
        DtStart: w2uiDateControlString(y),                  // start
        DtStop: w2uiDateControlString(ny),                  // end
    };
    var params = {cmd: 'save', formname: 'tcidRUserPicker', record: rec };
    var dat = JSON.stringify(params);

    // save the record to the server, insert into grid if successful
    $.post(url, dat)
    .done(function(data) {
        if (typeof data == 'string') {  // it's weird, a successful data add gets parsed as an object, an error message does not
            var msg = JSON.parse(data);
            w2ui.rauGrid.message(msg.message);
            return;
        }
        if (data.status == 'success') {
            rec.recid = data.recid; // success reply returns RUID of record just added
            w2ui.rauGrid.add(rec,true);
        } else {
            w2ui.rauGrid.message(data.message);
        }
    })
    .fail(function(data) {
        console.log('data = ' + data);
    });
}

function popupTcidRUserPicker(sTitle,bid,raid) {
    "use strict";
    app.TcidRUserPicker = {BID: bid, Title: sTitle, RAID: raid, RARentablesNames: [], RAR: []};  // used by tcidRUserPicker form
    var y = new Date();
    var ny = new Date(y.getFullYear() + 1, y.getMonth(), y.getDate(), 0, 0, 0);
    w2ui.tcidRUserPicker.record.DtStart = w2uiDateControlString(y);
    w2ui.tcidRUserPicker.record.DtStop = w2uiDateControlString(ny);
    w2ui.tcidRUserPicker.record.TCID = -1;
    w2ui.tcidRUserPicker.refresh();
    var url = '/v1/rar/' + bid + '/' + raid;
    $.get(url,function(data,status) {
        if (status != "success") {
            console.log('>>>>>>>>>>>>>>>  status = ' + status);
            return;
        }
        app.TcidRUserPicker.RAR = JSON.parse(data);
        for (var i = 0; i < app.TcidRUserPicker.RAR.records.length; i++) {
            app.TcidRUserPicker.RARentablesNames.push(app.TcidRUserPicker.RAR.records[i].RentableName);
        }
    });
    $().w2popup('open', {
        title   : 'Add A New ' + sTitle,
        body    : '<div id="form" style="width: 100%; height: 100%;"></div>',
        style   : 'padding: 15px 0px 0px 0px',
        width   : 400,
        height  : 250, 
        showMax : true,
        onToggle: function (event) {
            $(w2ui.tcidRUserPicker.box).hide();
            event.onComplete = function () {
                $(w2ui.tcidRUserPicker.box).show();
                w2ui.tcidRUserPicker.resize();
            };
        },
        onOpen: function (event) {
            event.onComplete = function () {
                // specifying an onOpen handler instead would be equivalent to specifying 
                // an onBeforeOpen handler, which would make this code execute too 
                // early and hence not deliver.
                $('#w2ui-popup #form').w2render('tcidRUserPicker');
            };
        }
    });
}

function createRentalAgreementForm() {
    "use strict";    
    w2ui.raLayout.content('left', w2ui.rentalagrForm);
    w2ui.raLayout.content('main', w2ui.raLayoutSub1); 

    w2ui.raLayoutSub1.content('top', w2ui.rarGrid);
    w2ui.rarGrid.header = plural(app.sRentable);
    w2ui.raLayoutSub1.content('main', w2ui.rapGrid);
    w2ui.rapGrid.header = plural(app.sPayor);
    
    w2ui.raLayoutSub1.content('preview', w2ui.rauGrid);
    w2ui.rauGrid.header = plural(app.sUser);
    w2ui.raLayoutSub1.content('bottom', w2ui.raPetGrid);
    w2ui.raPetGrid.header = "Pets";
}

function finishInitialization() {
    "use strict";
    defineDateFmts();
    buildPageElements();
    createRentalAgreementForm();

    var d1 = new Date();
    d1.setDate(1);
    app.D1 = dateControlString(d1);
    var d2 = dateMonthFwd(d1);
    app.D2 = dateControlString(d2);
}

function handleData(data,status) {
    if (status == "success") {
        /* jshint ignore:start */
        eval(data); // defines all the lists; values for the dropdown lists
        /* jshint ignore:end */
        console.log("SUCCESSFULLY LOADED LISTS");
    } else {
        console.log( '**** YIPES! ****  status on /v1/uilists/ = ' + status);
    }
    finishInitialization();
}

$(function () {
    "use strict";
    $.get('/v1/uilists/' + app.language + '/' + app.template)
    .done(handleData)
    .fail( function() { 
        console.log('Error getting /v1/uilists');
     });
}
);

</script>

<div id="layout"style="position: absolute; top: 0px; left: 0px; bottom: 0px; right: 0px;"></div>

</body>
</html>
